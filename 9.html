<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>辐射避难所：废墟纪元 - 终极增强版</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-green: #39ff14;
            --neon-orange: #ff8c00;
            --neon-yellow: #fff700;
            --neon-purple: #b829ff;
            --dark-bg: #0a0a0f;
            --panel-bg: rgba(20, 20, 35, 0.9);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--dark-bg);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            line-height: 1.6;
        }
        
        /* 动态粒子背景系统 */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            background: radial-gradient(circle at 50% 50%, rgba(0, 243, 255, 0.03) 0%, transparent 50%);
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            animation: float 15s infinite ease-in-out;
        }
        
        .particle.type-1 {
            background: rgba(0, 243, 255, 0.4);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }
        
        .particle.type-2 {
            background: rgba(255, 0, 255, 0.3);
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.4);
        }
        
        .particle.type-3 {
            background: rgba(57, 255, 20, 0.3);
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.4);
        }
        
        @keyframes float {
            0%, 100% { 
                transform: translateY(0) translateX(0) rotate(0deg); 
                opacity: 0; 
            }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            50% { 
                transform: translateY(-100vh) translateX(100px) rotate(180deg); 
            }
        }
        
        /* 增强CRT扫描线效果 */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1),
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 3px
            );
            pointer-events: none;
            z-index: 1000;
            animation: scanline 10s linear infinite;
        }
        
        .crt-flicker {
            animation: flicker 0.15s infinite;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 243, 255, 0.01);
            z-index: 999;
        }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        
        @keyframes flicker {
            0% { opacity: 0.97; }
            50% { opacity: 1; }
            100% { opacity: 0.98; }
        }
        
        /* 游戏容器优化 */
        .game-container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 全息HUD头部 */
        .header {
            background: linear-gradient(135deg, rgba(45, 19, 44, 0.95), rgba(128, 19, 54, 0.95));
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 2px solid var(--neon-pink);
            box-shadow: 
                0 0 40px rgba(255, 0, 255, 0.4), 
                inset 0 0 30px rgba(255, 0, 255, 0.1),
                0 0 80px rgba(255, 0, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: hologram 4s infinite linear;
        }
        
        @keyframes hologram {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .game-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 42px;
            font-weight: 900;
            color: var(--neon-blue);
            text-align: center;
            text-shadow: 
                0 0 20px rgba(0, 243, 255, 0.8),
                0 0 40px rgba(0, 243, 255, 0.4),
                0 0 80px rgba(0, 243, 255, 0.2);
            letter-spacing: 4px;
            position: relative;
            animation: titlePulse 3s infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { text-shadow: 0 0 20px rgba(0, 243, 255, 0.8), 0 0 40px rgba(0, 243, 255, 0.4); }
            50% { text-shadow: 0 0 30px rgba(0, 243, 255, 1), 0 0 60px rgba(0, 243, 255, 0.6); }
        }
        
        .subtitle-bar {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin-top: 15px;
            font-size: 15px;
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .subtitle-bar span {
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            font-family: 'Orbitron', monospace;
        }
        
        /* 响应式主布局 */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 25px;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .sidebar {
                order: 2;
            }
        }
        
        /* 玻璃态面板升级 */
        .glass-panel {
            background: linear-gradient(135deg, rgba(30, 30, 50, 0.9), rgba(20, 20, 35, 0.95));
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }
        
        .glass-panel:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .panel-title {
            color: var(--neon-blue);
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }
        
        /* 状态面板HUD优化 */
        .status-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 768px) {
            .status-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .stat-card {
            background: linear-gradient(145deg, rgba(40, 45, 65, 0.9), rgba(25, 30, 45, 0.95));
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(78, 204, 163, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--stat-color), transparent);
            transform: scaleX(0);
            transition: transform 0.4s;
        }
        
        .stat-card:hover::after {
            transform: scaleX(1);
        }
        
        .stat-card.health { --stat-color: #ff416c; border-color: rgba(255, 65, 108, 0.3); }
        .stat-card.hunger { --stat-color: #f2994a; border-color: rgba(242, 153, 74, 0.3); }
        .stat-card.thirst { --stat-color: #56ccf2; border-color: rgba(86, 204, 242, 0.3); }
        .stat-card.energy { --stat-color: #38ef7d; border-color: rgba(56, 239, 125, 0.3); }
        
        .stat-card.critical {
            animation: criticalPulse 1s infinite;
            border-color: #ff416c;
            box-shadow: 0 0 30px rgba(255, 65, 108, 0.4);
        }
        
        @keyframes criticalPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 65, 108, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 40px rgba(255, 65, 108, 0.6); }
        }
        
        .stat-icon {
            font-size: 36px;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 8px currentColor);
            display: block;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 900;
            font-family: 'Orbitron', monospace;
            color: var(--stat-color);
            text-shadow: 0 0 15px currentColor;
            margin: 5px 0;
        }
        
        .stat-bar-container {
            margin-top: 12px;
            height: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .stat-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            background-size: 200% 100%;
        }
        
        .stat-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* 资源网格优化 */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }
        
        .resource-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            padding: 18px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            user-select: none;
        }
        
        .resource-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transition: left 0.6s;
        }
        
        .resource-card:hover::before {
            left: 100%;
        }
        
        .resource-card:hover {
            transform: translateY(-4px) scale(1.03);
            border-color: var(--neon-blue);
            box-shadow: 0 8px 25px rgba(0, 243, 255, 0.25);
            z-index: 10;
        }
        
        .resource-card.rare {
            border-color: var(--neon-purple);
            background: linear-gradient(145deg, rgba(184, 41, 255, 0.1), rgba(184, 41, 255, 0.05));
        }
        
        .resource-card.rare:hover {
            box-shadow: 0 8px 25px rgba(184, 41, 255, 0.3);
        }
        
        .resource-card.epic {
            border-color: var(--neon-orange);
            background: linear-gradient(145deg, rgba(255, 140, 0, 0.1), rgba(255, 140, 0, 0.05));
        }
        
        .resource-icon {
            font-size: 36px;
            margin-bottom: 8px;
            display: block;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
        }
        
        .resource-count {
            font-size: 22px;
            font-weight: bold;
            color: var(--neon-green);
            font-family: 'Orbitron', monospace;
            text-shadow: 0 0 10px rgba(57, 239, 20, 0.5);
        }
        
        .resource-name {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            font-weight: 500;
        }
        
        /* 标签页系统增强 */
        .tab-container {
            margin-top: 25px;
        }
        
        .tab-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 5px;
            background: rgba(0,0,0,0.2);
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .tab-btn {
            background: rgba(108, 92, 231, 0.15);
            border: 1px solid rgba(108, 92, 231, 0.3);
            color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            font-size: 14px;
        }
        
        .tab-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .tab-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .tab-btn:hover {
            transform: translateY(-2px);
            border-color: rgba(108, 92, 231, 0.6);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
            box-shadow: 0 0 25px rgba(102, 126, 234, 0.6);
            transform: scale(1.05);
        }
        
        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 按钮样式系统 */
        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 14px 28px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            margin: 6px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }
        
        .action-btn:hover:not(:disabled)::after {
            animation: btnShine 0.8s ease-in-out;
        }
        
        @keyframes btnShine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }
        
        .action-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }
        
        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(0.8);
            transform: none !important;
        }
        
        .action-btn.danger {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            box-shadow: 0 6px 20px rgba(255, 65, 108, 0.4);
        }
        
        .action-btn.danger:hover:not(:disabled) {
            box-shadow: 0 8px 30px rgba(255, 65, 108, 0.6);
        }
        
        .action-btn.success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: #000;
            box-shadow: 0 6px 20px rgba(56, 239, 125, 0.4);
        }
        
        .action-btn.warning {
            background: linear-gradient(135deg, #f2994a, #f2c94c);
            color: #000;
            box-shadow: 0 6px 20px rgba(242, 201, 76, 0.4);
        }
        
        .action-btn.info {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            box-shadow: 0 6px 20px rgba(0, 198, 255, 0.4);
        }
        
        /* 探索卡片网格 */
        .explore-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .explore-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }
        
        .explore-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.05), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .explore-card:hover::before {
            opacity: 1;
        }
        
        .explore-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--neon-blue);
            box-shadow: 0 15px 40px rgba(0, 243, 255, 0.2);
        }
        
        .explore-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
        }
        
        .explore-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .explore-info {
            font-size: 13px;
            color: #888;
            line-height: 1.6;
        }
        
        .risk-low { color: var(--neon-green); }
        .risk-med { color: #f2c94c; }
        .risk-high { color: #ff416c; }
        
        /* 任务列表优化 */
        .quest-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .quest-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .quest-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border-left: 4px solid var(--neon-orange);
            padding: 20px;
            margin: 12px 0;
            border-radius: 0 16px 16px 0;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .quest-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 0;
            height: 100%;
            background: rgba(255, 140, 0, 0.1);
            transition: width 0.3s;
        }
        
        .quest-item:hover::before {
            width: 100%;
        }
        
        .quest-item:hover {
            transform: translateX(8px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .quest-item.completed {
            border-left-color: var(--neon-green);
            opacity: 0.8;
            background: linear-gradient(135deg, rgba(57, 255, 20, 0.05), rgba(57, 255, 20, 0.02));
        }
        
        .quest-item.completed::before {
            background: rgba(57, 255, 20, 0.1);
        }
        
        .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .quest-title {
            font-weight: 800;
            color: var(--neon-orange);
            font-size: 16px;
        }
        
        .quest-type {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(255,140,0,0.2);
            color: var(--neon-orange);
            font-weight: 600;
        }
        
        .quest-desc {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .quest-reward {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: var(--neon-green);
            font-weight: 600;
            flex-wrap: wrap;
        }
        
        .quest-progress {
            margin-top: 15px;
            height: 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-orange), var(--neon-pink));
            transition: width 0.4s;
            position: relative;
        }
        
        .quest-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShimmer 2s infinite;
        }
        
        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* 建造网格 */
        .build-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 18px;
        }
        
        .build-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .build-card.built {
            border-color: var(--neon-green);
            background: linear-gradient(145deg, rgba(57, 255, 20, 0.1), rgba(57, 255, 20, 0.05));
        }
        
        .build-card:hover:not(.built) {
            transform: translateY(-5px);
            border-color: var(--neon-blue);
            box-shadow: 0 10px 30px rgba(0, 243, 255, 0.2);
        }
        
        .build-icon {
            font-size: 42px;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.2));
        }
        
        .build-name {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .build-effect {
            font-size: 12px;
            color: #888;
            margin-bottom: 12px;
        }
        
        .build-cost {
            font-size: 11px;
            color: #666;
            line-height: 1.5;
        }
        
        /* 制作系统 */
        .craft-category {
            margin-bottom: 30px;
        }
        
        .craft-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }
        
        .craft-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .craft-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .craft-item:hover {
            transform: scale(1.02);
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .craft-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .craft-icon {
            font-size: 40px;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.3));
        }
        
        .craft-details h4 {
            margin-bottom: 5px;
            color: #fff;
        }
        
        .craft-stats {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        
        .craft-requirements {
            font-size: 11px;
            color: #666;
        }
        
        .craft-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* 宠物系统增强 */
        .pet-container {
            text-align: center;
            padding: 30px;
        }
        
        .pet-avatar {
            font-size: 100px;
            margin: 30px 0;
            display: inline-block;
            animation: petBounce 3s infinite ease-in-out;
            filter: drop-shadow(0 0 30px rgba(255, 200, 100, 0.6));
            position: relative;
        }
        
        .pet-avatar::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            animation: petShadow 3s infinite ease-in-out;
        }
        
        @keyframes petBounce {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-15px); }
            50% { transform: translateY(0); }
            75% { transform: translateY(-8px); }
        }
        
        @keyframes petShadow {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 0.3; }
            25% { transform: translateX(-50%) scale(0.8); opacity: 0.2; }
            50% { transform: translateX(-50%) scale(1); opacity: 0.3; }
        }
        
        .pet-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px auto;
            max-width: 500px;
        }
        
        .pet-stat-card {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        
        .pet-stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-orange);
        }
        
        .pet-stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--neon-orange);
            font-family: 'Orbitron', monospace;
        }
        
        /* NPC系统 */
        .npc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .npc-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .npc-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(10px);
            border-color: var(--neon-blue);
            box-shadow: 0 10px 30px rgba(0, 243, 255, 0.15);
        }
        
        .npc-avatar {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            border: 3px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        
        .npc-card:hover .npc-avatar {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }
        
        .npc-info {
            flex: 1;
        }
        
        .npc-name {
            font-weight: bold;
            color: var(--neon-blue);
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .npc-role {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
        }
        
        .npc-affection {
            display: flex;
            gap: 3px;
        }
        
        .heart {
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .heart.filled {
            color: #ff416c;
            text-shadow: 0 0 10px rgba(255, 65, 108, 0.6);
        }
        
        .heart.empty {
            color: rgba(255,255,255,0.2);
        }
        
        /* 营地面板 */
        .camp-status {
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.15), rgba(56, 239, 125, 0.1));
            border: 1px solid rgba(56, 239, 125, 0.3);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .camp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .camp-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .camp-stat {
            text-align: center;
        }
        
        .camp-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--neon-green);
            font-family: 'Orbitron', monospace;
        }
        
        .camp-stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        
        .camp-members {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .camp-member {
            text-align: center;
            min-width: 80px;
            transition: all 0.3s;
        }
        
        .camp-member:hover {
            transform: translateY(-5px);
        }
        
        .member-avatar {
            width: 70px;
            height: 70px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            border: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }
        
        .camp-member:hover .member-avatar {
            border-color: var(--neon-green);
            box-shadow: 0 0 25px rgba(57, 239, 20, 0.4);
        }
        
        .member-avatar::after {
            content: '';
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--neon-green);
            border-radius: 50%;
            border: 3px solid var(--dark-bg);
        }
        
        /* 装备栏优化 */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .equipment-slot {
            background: linear-gradient(145deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.4s;
            cursor: pointer;
            position: relative;
        }
        
        .equipment-slot.filled {
            border-style: solid;
            border-color: var(--neon-orange);
            background: linear-gradient(145deg, rgba(255, 140, 0, 0.15), rgba(255, 140, 0, 0.05));
        }
        
        .equipment-slot:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        
        .equipment-slot.filled:hover {
            border-color: var(--neon-pink);
            box-shadow: 0 10px 30px rgba(255, 0, 255, 0.3);
        }
        
        .equipment-icon {
            font-size: 48px;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.2));
            transition: all 0.3s;
        }
        
        .equipment-slot:hover .equipment-icon {
            transform: scale(1.2);
        }
        
        .equipment-level {
            position: absolute;
            top: -12px;
            right: -12px;
            background: linear-gradient(135deg, var(--neon-pink), #ff6b6b);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 5px 15px rgba(255, 0, 255, 0.5);
            border: 3px solid var(--dark-bg);
            animation: levelPulse 2s infinite;
        }
        
        @keyframes levelPulse {
            0%, 100% { box-shadow: 0 5px 15px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 5px 25px rgba(255, 0, 255, 0.8); }
        }
        
        /* 技能树 */
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }
        
        .skill-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .skill-card.active {
            border-color: var(--neon-green);
            background: linear-gradient(145deg, rgba(57, 255, 20, 0.1), rgba(57, 255, 20, 0.05));
            box-shadow: 0 5px 20px rgba(57, 255, 20, 0.2);
        }
        
        .skill-card.maxed {
            border-color: var(--neon-yellow);
            background: linear-gradient(145deg, rgba(255, 247, 0, 0.1), rgba(255, 247, 0, 0.05));
            opacity: 0.8;
        }
        
        .skill-card:hover:not(.maxed) {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            border-color: var(--neon-blue);
        }
        
        .skill-icon {
            font-size: 36px;
            margin-bottom: 10px;
            display: block;
        }
        
        .skill-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .skill-level {
            font-size: 12px;
            color: var(--neon-blue);
            font-weight: 600;
        }
        
        .skill-desc {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }
        
        /* 日志系统增强 */
        .log-container {
            background: linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.5));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }
        
        .log-entry {
            margin: 10px 0;
            padding: 12px 16px;
            border-radius: 10px;
            position: relative;
            padding-left: 20px;
            animation: logSlide 0.4s ease-out;
            border-left: 4px solid transparent;
        }
        
        @keyframes logSlide {
            from { opacity: 0; transform: translateX(-20px) scale(0.95); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }
        
        .log-entry::before {
            content: '';
            position: absolute;
            left: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            border-radius: 2px;
        }
        
        .log-entry.success { 
            background: rgba(56, 239, 125, 0.1); 
            border-left-color: var(--neon-green);
        }
        .log-entry.danger { 
            background: rgba(255, 65, 108, 0.1); 
            border-left-color: #ff416c;
        }
        .log-entry.warning { 
            background: rgba(242, 201, 76, 0.1); 
            border-left-color: #f2c94c;
        }
        .log-entry.loot { 
            background: rgba(255, 217, 61, 0.1); 
            border-left-color: var(--neon-orange);
        }
        .log-entry.story { 
            background: rgba(0, 243, 255, 0.1); 
            border-left-color: var(--neon-blue);
        }
        .log-entry.event {
            background: rgba(184, 41, 255, 0.1);
            border-left-color: var(--neon-purple);
        }
        
        .log-time {
            font-size: 11px;
            color: #666;
            margin-right: 10px;
            opacity: 0.8;
        }
        
        /* 日记系统 */
        .diary-entries {
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            padding-right: 10px;
        }
        
        .diary-entry {
            background: linear-gradient(135deg, rgba(255,0,255,0.05), transparent);
            border-left: 4px solid var(--neon-pink);
            padding: 20px;
            margin: 15px 0;
            border-radius: 0 16px 16px 0;
            font-size: 15px;
            line-height: 1.8;
            color: #ddd;
            position: relative;
            transition: all 0.3s;
        }
        
        .diary-entry:hover {
            transform: translateX(10px);
            background: linear-gradient(135deg, rgba(255,0,255,0.1), transparent);
        }
        
        .diary-date {
            color: var(--neon-pink);
            font-size: 13px;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .diary-type {
            font-size: 11px;
            padding: 4px 10px;
            background: rgba(255,0,255,0.2);
            border-radius: 12px;
            text-transform: uppercase;
        }
        
        /* 模态框系统 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.92);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .modal-overlay.active {
            display: flex;
            animation: modalFade 0.4s;
        }
        
        @keyframes modalFade {
            from { opacity: 0; backdrop-filter: blur(0); }
            to { opacity: 1; backdrop-filter: blur(10px); }
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid var(--neon-blue);
            border-radius: 24px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 
                0 0 60px rgba(0, 243, 255, 0.3),
                inset 0 0 60px rgba(0, 243, 255, 0.05);
            position: relative;
            animation: modalSlide 0.4s ease-out;
        }
        
        @keyframes modalSlide {
            from { 
                opacity: 0; 
                transform: translateY(-50px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .modal-header {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            color: var(--neon-blue);
            margin-bottom: 25px;
            text-align: center;
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
            position: relative;
            padding-bottom: 20px;
        }
        
        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
        }
        
        .modal-body {
            line-height: 1.9;
            color: #ccc;
            font-size: 16px;
            margin-bottom: 30px;
            white-space: pre-line;
        }
        
        .modal-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .modal-choice-btn {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border: 1px solid rgba(102, 126, 234, 0.5);
            color: #fff;
            padding: 18px 25px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .modal-choice-btn:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.4), rgba(118, 75, 162, 0.4));
            transform: translateX(10px);
            border-color: var(--neon-blue);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .modal-choice-btn .choice-cost {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        /* 战斗界面 */
        .combat-arena {
            background: radial-gradient(circle at center, rgba(255,65,108,0.2) 0%, transparent 70%);
            border: 3px solid #ff416c;
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            margin-top: 25px;
            animation: combatPulse 3s infinite;
        }
        
        @keyframes combatPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(255, 65, 108, 0.3); }
            50% { box-shadow: 0 0 50px rgba(255, 65, 108, 0.5); }
        }
        
        .enemy-sprite {
            font-size: 120px;
            margin: 30px 0;
            display: inline-block;
            filter: drop-shadow(0 0 30px rgba(255,65,108,0.6));
            animation: enemyFloat 4s ease-in-out infinite;
            position: relative;
            z-index: 10;
        }
        
        @keyframes enemyFloat {
            0%, 100% { transform: translateY(0) rotate(-3deg) scale(1); }
            50% { transform: translateY(-25px) rotate(3deg) scale(1.05); }
        }
        
        .enemy-name {
            font-size: 32px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
            font-family: 'Orbitron', sans-serif;
        }
        
        .enemy-hp-bar {
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 16px;
            margin: 25px auto;
            max-width: 500px;
            border: 1px solid rgba(255,65,108,0.3);
        }
        
        .damage-number {
            position: absolute;
            font-size: 48px;
            font-weight: 900;
            color: #ff416c;
            text-shadow: 0 0 20px rgba(255,65,108,1);
            animation: damageFloat 1.2s ease-out forwards;
            pointer-events: none;
            z-index: 100;
            font-family: 'Orbitron', sans-serif;
        }
        
        .damage-number.critical {
            color: var(--neon-yellow);
            font-size: 64px;
            text-shadow: 0 0 30px rgba(255, 247, 0, 1);
        }
        
        @keyframes damageFloat {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(0.5) rotate(0deg); 
            }
            20% {
                transform: translateY(-20px) scale(1.2) rotate(-5deg);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-80px) scale(1.5) rotate(5deg); 
            }
        }
        
        /* 成就通知 */
        .achievement-toast {
            position: fixed;
            top: 30px;
            right: -400px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 140, 0, 0.95));
            color: #000;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 
                0 10px 40px rgba(255, 215, 0, 0.4),
                0 0 60px rgba(255, 215, 0, 0.2);
            transform: translateX(0);
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 3000;
            max-width: 350px;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .achievement-toast.show {
            right: 30px;
        }
        
        .achievement-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .achievement-title {
            font-weight: 900;
            font-size: 20px;
            margin-bottom: 8px;
            font-family: 'Orbitron', sans-serif;
        }
        
        .achievement-desc {
            font-size: 14px;
            color: rgba(0,0,0,0.8);
            font-weight: 600;
        }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--neon-blue), var(--neon-pink));
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--neon-pink), var(--neon-blue));
        }
        
        /* 提示框增强 */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.95);
            border: 1px solid var(--neon-blue);
            padding: 15px;
            border-radius: 12px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 100;
            max-width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: translateY(10px);
            backdrop-filter: blur(10px);
        }
        
        .tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .tooltip-title {
            color: var(--neon-blue);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .tooltip-content {
            color: #aaa;
            line-height: 1.5;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .game-title { font-size: 28px; }
            .status-panel { grid-template-columns: repeat(2, 1fr); }
            .explore-grid { grid-template-columns: 1fr; }
            .npc-grid { grid-template-columns: 1fr; }
            .equipment-grid { grid-template-columns: 1fr; }
            .modal-content { padding: 25px; }
            .pet-stats-grid { grid-template-columns: 1fr; }
        }
        
        /* 动画类 */
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .flash {
            animation: flash 0.3s;
        }
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; background: rgba(255,65,108,0.3); }
        }
        
        /* 加载动画 */
        .loading-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink));
            width: 0%;
            transition: width 0.3s;
            animation: loading 2s ease-in-out infinite;
        }
        
        @keyframes loading {
            0% { width: 0%; margin-left: 0; }
            50% { width: 100%; margin-left: 0; }
            100% { width: 0%; margin-left: 100%; }
        }
    </style>
</head>
<body>
    <!-- 粒子背景 -->
    <div class="particles" id="particles"></div>
    <div class="crt-overlay"></div>
    <div class="crt-flicker"></div>
    
    <!-- 提示框 -->
    <div class="tooltip" id="tooltip">
        <div class="tooltip-title" id="tooltipTitle"></div>
        <div class="tooltip-content" id="tooltipContent"></div>
    </div>
    
    <!-- 成就通知 -->
    <div class="achievement-toast" id="achievementToast">
        <div class="achievement-icon">🏆</div>
        <div class="achievement-title">成就解锁</div>
        <div class="achievement-desc" id="achievementText">描述文本</div>
    </div>
    
    <div class="game-container">
        <!-- 头部HUD -->
        <div class="header">
            <div class="game-title">☢️ 辐射避难所：废墟纪元</div>
            <div class="subtitle-bar">
                <span>⚡ Lv.<span id="playerLevel">1</span></span>
                <span>📊 EXP: <span id="playerExp">0</span>/<span id="playerMaxExp">100</span></span>
                <span style="color: var(--neon-pink);">📅 第 <span id="dayDisplay">1</span> 天</span>
                <span style="color: var(--neon-green);">⏰ <span id="timeDisplay">08:00</span></span>
                <span>☢️ 辐射: <span id="radDisplay">0</span>%</span>
            </div>
        </div>
        
        <div class="main-layout">
            <!-- 左侧主区域 -->
            <div class="main-content">
                <!-- 状态面板 -->
                <div class="status-panel">
                    <div class="stat-card health" id="healthCard">
                        <span class="stat-icon">❤️</span>
                        <div class="stat-value" id="healthVal">100</div>
                        <div class="stat-bar-container">
                            <div class="stat-bar-fill" id="healthBar" style="width: 100%; background: linear-gradient(90deg, #ff416c, #ff6b6b);"></div>
                        </div>
                    </div>
                    <div class="stat-card hunger" id="hungerCard">
                        <span class="stat-icon">🍖</span>
                        <div class="stat-value" id="hungerVal">100</div>
                        <div class="stat-bar-container">
                            <div class="stat-bar-fill" id="hungerBar" style="width: 100%; background: linear-gradient(90deg, #f2994a, #f2c94c);"></div>
                        </div>
                    </div>
                    <div class="stat-card thirst" id="thirstCard">
                        <span class="stat-icon">💧</span>
                        <div class="stat-value" id="thirstVal">100</div>
                        <div class="stat-bar-container">
                            <div class="stat-bar-fill" id="thirstBar" style="width: 100%; background: linear-gradient(90deg, #56ccf2, #2f80ed);"></div>
                        </div>
                    </div>
                    <div class="stat-card energy" id="energyCard">
                        <span class="stat-icon">⚡</span>
                        <div class="stat-value" id="energyVal">100</div>
                        <div class="stat-bar-container">
                            <div class="stat-bar-fill" id="energyBar" style="width: 100%; background: linear-gradient(90deg, #11998e, #38ef7d);"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 资源面板 -->
                <div class="glass-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span>📦</span> 资源储备
                        </div>
                        <div style="color: var(--neon-green); font-family: 'Orbitron', monospace; font-size: 22px; text-shadow: 0 0 10px rgba(57, 239, 20, 0.5);">
                            💵 <span id="capCount">50</span> 瓶盖
                        </div>
                    </div>
                    <div class="resource-grid" id="resourcesGrid"></div>
                </div>
                
                <!-- 主操作区 -->
                <div class="glass-panel tab-container">
                    <div class="tab-nav">
                        <button class="tab-btn active" onclick="switchTab('explore')">🗺️ 探索</button>
                        <button class="tab-btn" onclick="switchTab('quest')">📜 任务</button>
                        <button class="tab-btn" onclick="switchTab('build')">🏗️ 建造</button>
                        <button class="tab-btn" onclick="switchTab('craft')">🔨 制作</button>
                        <button class="tab-btn" onclick="switchTab('pet')">🐕 伙伴</button>
                        <button class="tab-btn" onclick="switchTab('social')">👥 营地</button>
                        <button class="tab-btn" onclick="switchTab('diary')">📖 日记</button>
                    </div>
                    
                    <!-- 探索标签 -->
                    <div id="tab-explore" class="tab-content active">
                        <div style="margin-bottom: 25px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: var(--neon-orange); margin-bottom: 8px;">
                                📍 当前位置：<span id="currentLocation">避难所</span>
                            </div>
                            <div style="color: #888; font-size: 14px; display: flex; gap: 20px; flex-wrap: wrap;">
                                <span>辐射等级: <span style="color: var(--neon-pink);">低</span></span>
                                <span>安全等级: <span style="color: var(--neon-green);">安全</span></span>
                                <span>天气: <span style="color: #f2c94c;">晴朗</span></span>
                            </div>
                        </div>
                        
                        <div class="explore-grid">
                            <div class="explore-card" onclick="explore('suburbs')">
                                <span class="explore-icon">🏘️</span>
                                <div class="explore-title">郊区废墟</div>
                                <div class="explore-info">
                                    <span class="risk-low">●</span> 低风险<br>
                                    基础资源收集<br>
                                    消耗: <span style="color: var(--neon-green);">10⚡</span>
                                </div>
                            </div>
                            <div class="explore-card" onclick="explore('city')">
                                <span class="explore-icon">🏢</span>
                                <div class="explore-title">城市中心</div>
                                <div class="explore-info">
                                    <span class="risk-med">●</span> 中风险<br>
                                    高级物资搜刮<br>
                                    消耗: <span style="color: #f2c94c;">20⚡</span>
                                </div>
                            </div>
                            <div class="explore-card" onclick="explore('lab')">
                                <span class="explore-icon">🏥</span>
                                <div class="explore-title">废弃医院</div>
                                <div class="explore-info">
                                    <span class="risk-high">●</span> 高风险<br>
                                    稀有物品/医疗<br>
                                    消耗: <span style="color: #ff416c;">30⚡</span>
                                </div>
                            </div>
                            <div class="explore-card" onclick="explore('factory')" id="factoryCard" style="display: none;">
                                <span class="explore-icon">🏭</span>
                                <div class="explore-title">废弃工厂</div>
                                <div class="explore-info">
                                    <span class="risk-high">●</span> 极高风险<br>
                                    工业材料<br>
                                    消耗: <span style="color: #ff416c;">40⚡</span>
                                </div>
                            </div>
                            <div class="explore-card" onclick="rest()" style="border-color: var(--neon-yellow);">
                                <span class="explore-icon">🏕️</span>
                                <div class="explore-title">营地休息</div>
                                <div class="explore-info">
                                    <span style="color: var(--neon-yellow);">恢复状态</span><br>
                                    恢复生命/体力<br>
                                    消耗: <span style="color: #f2c94c;">2🍖 2💧</span>
                                </div>
                            </div>
                        </div>
                        <div id="combatArea" style="display: none;"></div>
                    </div>
                    
                    <!-- 任务标签 -->
                    <div id="tab-quest" class="tab-content">
                        <div class="quest-filters">
                            <button class="tab-btn active" style="padding: 8px 16px; font-size: 12px;">全部</button>
                            <button class="tab-btn" style="padding: 8px 16px; font-size: 12px;">主线</button>
                            <button class="tab-btn" style="padding: 8px 16px; font-size: 12px;">支线</button>
                            <button class="tab-btn" style="padding: 8px 16px; font-size: 12px;">日常</button>
                        </div>
                        <div class="quest-list" id="questList"></div>
                    </div>
                    
                    <!-- 建造标签 -->
                    <div id="tab-build" class="tab-content">
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; font-size: 14px; color: #888;">
                            <strong style="color: var(--neon-blue);">💡 提示：</strong>建造高级建筑需要解锁前置建筑。部分建筑提供被动收益。
                        </div>
                        <div class="build-grid" id="buildGrid"></div>
                    </div>
                    
                    <!-- 制作标签 -->
                    <div id="tab-craft" class="tab-content">
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; font-size: 14px; color: #888;">
                            <strong style="color: var(--neon-blue);">🔧 制作系统：</strong>收集材料制作装备和工具。高级物品需要特定工作台。
                        </div>
                        <div id="craftList"></div>
                    </div>
                    
                    <!-- 宠物标签 -->
                    <div id="tab-pet" class="tab-content">
                        <div class="pet-container" id="petDisplay">
                            <div style="color: #666; padding: 60px 40px; font-size: 16px;">
                                <div style="font-size: 60px; margin-bottom: 20px;">🐾</div>
                                你还没有伙伴<br>
                                <span style="font-size: 14px; opacity: 0.7;">探索废土时可能会遇到可驯服的动物...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 社交标签 -->
                    <div id="tab-social" class="tab-content">
                        <div class="camp-status">
                            <div class="camp-header">
                                <h3 style="color: var(--neon-green); font-size: 22px;">🏕️ 幸存者营地</h3>
                                <button class="action-btn success" onclick="upgradeCamp()" style="padding: 8px 16px; font-size: 12px;">
                                    ⬆️ 升级营地
                                </button>
                            </div>
                            <div class="camp-stats">
                                <div class="camp-stat">
                                    <div class="camp-stat-value" id="campLevel">1</div>
                                    <div class="camp-stat-label">营地等级</div>
                                </div>
                                <div class="camp-stat">
                                    <div class="camp-stat-value"><span id="campMembers">1</span>/<span id="campMaxMembers">5</span></div>
                                    <div class="camp-stat-label">居民数</div>
                                </div>
                                <div class="camp-stat">
                                    <div class="camp-stat-value" id="campProsperity">100</div>
                                    <div class="camp-stat-label">繁荣度</div>
                                </div>
                                <div class="camp-stat">
                                    <div class="camp-stat-value" id="campDefense">10</div>
                                    <div class="camp-stat-label">防御力</div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; font-size: 13px; color: #888;">
                                营地效果: <span style="color: var(--neon-green);" id="campEffects">每日恢复5生命值</span>
                            </div>
                            <div class="camp-members" id="campMembersList"></div>
                        </div>
                        <h4 style="color: var(--neon-blue); margin-bottom: 15px; font-size: 18px;">🗺️ 附近幸存者</h4>
                        <div class="npc-grid" id="npcList"></div>
                    </div>
                    
                    <!-- 日记标签 -->
                    <div id="tab-diary" class="tab-content">
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,0,255,0.1); border-radius: 12px; border: 1px solid rgba(255,0,255,0.3);">
                            <div style="color: var(--neon-pink); font-weight: bold; margin-bottom: 5px;">📖 生存记录</div>
                            <div style="font-size: 13px; color: #888;">你的每一次选择和经历都会被记录在这里...</div>
                        </div>
                        <div class="diary-entries" id="diaryEntries"></div>
                    </div>
                </div>
                
                <!-- 日志区域 -->
                <div class="glass-panel" style="margin-top: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h4 style="color: #888; font-size: 16px;">📜 生存日志</h4>
                            <span style="font-size: 11px; color: #666; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 10px;" id="logCount">0 条记录</span>
                        </div>
                        <button class="action-btn" onclick="clearLog()" style="padding: 6px 14px; font-size: 12px;">
                            🗑️ 清空
                        </button>
                    </div>
                    <div class="log-container" id="logArea"></div>
                </div>
            </div>
            
            <!-- 右侧边栏 -->
            <div class="sidebar">
                <!-- 装备栏 -->
                <div class="glass-panel">
                    <div class="panel-header">
                        <div class="panel-title" style="font-size: 18px;">
                            <span>🎒</span> 装备栏
                        </div>
                    </div>
                    <div class="equipment-grid">
                        <div class="equipment-slot" id="slot-weapon" onclick="unequip('weapon')">
                            <div class="equipment-icon">🔪</div>
                            <div style="font-size: 12px; color: #888;">武器</div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;" id="weaponName">未装备</div>
                        </div>
                        <div class="equipment-slot" id="slot-armor" onclick="unequip('armor')">
                            <div class="equipment-icon">👕</div>
                            <div style="font-size: 12px; color: #888;">护甲</div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;" id="armorName">未装备</div>
                        </div>
                        <div class="equipment-slot" id="slot-accessory" onclick="unequip('accessory')">
                            <div class="equipment-icon">💍</div>
                            <div style="font-size: 12px; color: #888;">饰品</div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;" id="accessoryName">未装备</div>
                        </div>
                        <div class="equipment-slot" id="slot-pet" onclick="showPetDetail()">
                            <div class="equipment-icon">🐾</div>
                            <div style="font-size: 12px; color: #888;">伙伴</div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;" id="petSlotName">无</div>
                        </div>
                    </div>
                </div>
                
                <!-- 技能面板 -->
                <div class="glass-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="panel-title" style="font-size: 18px;">
                            <span>🧬</span> 技能
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--neon-green); font-size: 26px; font-weight: bold; font-family: 'Orbitron', monospace;" id="skillPoints">0</div>
                            <div style="font-size: 11px; color: #888;">可用技能点</div>
                        </div>
                    </div>
                    <div class="skill-grid" id="skillTree"></div>
                </div>
                
                <!-- 存档管理 -->
                <div class="glass-panel">
                    <div class="panel-header">
                        <div class="panel-title" style="font-size: 18px;">
                            <span>💾</span> 系统
                        </div>
                    </div>
                    <button class="action-btn success" onclick="saveGame()" style="width: 100%; margin-bottom: 12px; padding: 14px;">
                        💾 保存进度
                    </button>
                    <button class="action-btn" onclick="loadGame()" style="width: 100%; margin-bottom: 12px; padding: 14px;">
                        📂 读取存档
                    </button>
                    <button class="action-btn danger" onclick="resetGame()" style="width: 100%; padding: 14px;">
                        🔄 重新开始
                    </button>
                </div>
                
                <!-- 统计信息 -->
                <div class="glass-panel">
                    <div class="panel-header" style="border-bottom: none; margin-bottom: 15px;">
                        <div class="panel-title" style="font-size: 16px; color: #888;">
                            📊 统计数据
                        </div>
                    </div>
                    <div style="font-size: 14px; line-height: 2.2; color: #aaa;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>⚔️ 击杀敌人</span>
                            <span style="color: #fff; font-weight: bold; font-family: 'Orbitron', monospace;" id="statKills">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>🗺️ 探索次数</span>
                            <span style="color: #fff; font-weight: bold; font-family: 'Orbitron', monospace;" id="statExplores">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>📜 完成任务</span>
                            <span style="color: #fff; font-weight: bold; font-family: 'Orbitron', monospace;" id="statQuests">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>🏗️ 建造完成</span>
                            <span style="color: #fff; font-weight: bold; font-family: 'Orbitron', monospace;" id="statBuilds">0</span>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--neon-orange); font-weight: bold;">🏆 生存评分</span>
                            <span style="color: var(--neon-orange); font-weight: bold; font-size: 28px; font-family: 'Orbitron', monospace; text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);" id="statScore">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- 快速操作 -->
                <div class="glass-panel">
                    <div class="panel-header" style="border-bottom: none; margin-bottom: 15px;">
                        <div class="panel-title" style="font-size: 16px; color: #888;">
                            ⚡ 快捷操作
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="action-btn" onclick="quickEat()" style="padding: 12px 8px; font-size: 12px;">
                            🥫 进食
                        </button>
                        <button class="action-btn" onclick="quickDrink()" style="padding: 12px 8px; font-size: 12px;">
                            💧 饮水
                        </button>
                        <button class="action-btn" onclick="quickHeal()" style="padding: 12px 8px; font-size: 12px;">
                            💊 治疗
                        </button>
                        <button class="action-btn warning" onclick="toggleTime()" style="padding: 12px 8px; font-size: 12px;" id="timeBtn">
                            ⏸️ 暂停
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 模态框 -->
    <div class="modal-overlay" id="gameModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">标题</div>
            <div class="modal-body" id="modalText">内容</div>
            <div class="modal-choices" id="modalChoices"></div>
        </div>
    </div>

    <script>
        // ==================== 游戏核心数据 ====================
        
        const gameData = {
            version: '3.0',
            player: {
                name: '幸存者',
                level: 1,
                exp: 0,
                maxExp: 100,
                stats: {
                    health: 100,
                    maxHealth: 100,
                    hunger: 100,
                    thirst: 100,
                    energy: 100,
                    radiation: 0,
                    maxRadiation: 100
                }
            },
            resources: {
                // 基础材料
                wood: 0, stone: 0, metal: 0, 
                // 生存资源
                food: 3, water: 3, medkit: 1, 
                // 战斗资源
                ammo: 10, 
                // 高级材料
                fuel: 0, electronics: 0, crystal: 0,
                // 新材料
                plastic: 0, circuit_board: 0, gears: 0, cloth: 0, chemicals: 0
            },
            caps: 50,
            equipment: {
                weapon: null,
                armor: null,
                accessory: null,
                pet: null
            },
            buildings: {},
            skills: {
                combat: 0, survival: 0, crafting: 0, barter: 0, leadership: 0
            },
            skillPoints: 0,
            quests: [],
            completedQuests: [],
            diary: [],
            pet: null,
            npcs: [],
            camp: {
                level: 1,
                members: ['player'],
                prosperity: 100,
                maxMembers: 5,
                defense: 10
            },
            stats: {
                kills: 0, explores: 0, builds: 0, crafts: 0, quests: 0,
                playTime: 0, distance: 0
            },
            time: { day: 1, hour: 8, paused: false },
            flags: {
                introRead: false,
                firstBuild: false,
                firstCombat: false,
                factoryUnlocked: false
            },
            eventCooldowns: {}
        };
        
        // 配置数据
        const config = {
            resources: [
                // 基础材料
                {id: 'wood', name: '木材', icon: '🪵', desc: '基础建筑材料，用于建造和制作', rarity: 'common'},
                {id: 'stone', name: '石材', icon: '🪨', desc: '坚固的建筑材料，防御建筑必需', rarity: 'common'},
                {id: 'metal', name: '金属', icon: '⚙️', desc: '制作装备和高级建筑的材料', rarity: 'common'},
                // 生存资源
                {id: 'food', name: '食物', icon: '🥫', desc: '恢复饥饿值，维持生命', rarity: 'common'},
                {id: 'water', name: '净水', icon: '💧', desc: '恢复水分，比食物更重要', rarity: 'common'},
                {id: 'medkit', name: '医疗包', icon: '💊', desc: '恢复大量生命值', rarity: 'uncommon'},
                // 战斗资源
                {id: 'ammo', name: '弹药', icon: '🎯', desc: '远程武器消耗品', rarity: 'common'},
                // 高级材料
                {id: 'fuel', name: '燃料', icon: '⛽', desc: '高级能源，用于载具和动力甲', rarity: 'rare'},
                {id: 'electronics', name: '电子元件', icon: '💻', desc: '高科技制作材料', rarity: 'rare'},
                {id: 'crystal', name: '辐射结晶', icon: '💎', desc: '稀有强化材料，蕴含辐射能量', rarity: 'epic'},
                // 新材料
                {id: 'plastic', name: '塑料', icon: '🧴', desc: '工业材料，用于制作容器和绝缘层', rarity: 'common'},
                {id: 'circuit_board', name: '电路板', icon: '📟', desc: '高级电子制作材料', rarity: 'rare'},
                {id: 'gears', name: '齿轮组', icon: '⚙️', desc: '机械零件，用于制作精密装备', rarity: 'uncommon'},
                {id: 'cloth', name: '布料', icon: '🧵', desc: '制作护甲和绷带的基础材料', rarity: 'common'},
                {id: 'chemicals', name: '化学试剂', icon: '🧪', desc: '用于制作药品和炸药', rarity: 'uncommon'}
            ],
            
            // 随机事件库（大量事件）
            randomEvents: [
                {
                    id: 'old_safe',
                    title: '废弃保险箱',
                    desc: '你在废墟中发现了一个锈蚀的保险箱，看起来需要电子元件才能打开。',
                    choices: [
                        {text: '破解保险箱 (消耗1电子元件)', cost: {electronics: 1}, reward: {caps: 100, metal: 20, ammo: 15}},
                        {text: '用蛮力砸开 (消耗10体力)', energyCost: 10, reward: {caps: 50, metal: 10}, failChance: 0.3, failText: '保险箱损坏了，什么都没得到'}
                    ],
                    weight: 1.5
                },
                {
                    id: 'wandering_trader',
                    title: '流浪商人',
                    desc: '一个背着大包的商人在废墟中游荡，他愿意用一些物资交换你的资源。',
                    choices: [
                        {text: '用50木头换30弹药', cost: {wood: 50}, reward: {ammo: 30}},
                        {text: '用20金属换1医疗包', cost: {metal: 20}, reward: {medkit: 1}},
                        {text: '拒绝交易', reward: {}}
                    ],
                    weight: 1.2
                },
                {
                    id: 'abandoned_vehicle',
                    title: '废弃车辆',
                    desc: '一辆战前的汽车停在路边，油箱似乎还有剩余。',
                    choices: [
                        {text: '抽取燃料', reward: {fuel: 10}},
                        {text: '搜刮零件', reward: {metal: 15, electronics: 3}}
                    ],
                    weight: 1.0
                },
                {
                    id: 'radio_signal',
                    title: '神秘信号',
                    desc: '你的收音机捕捉到一个微弱的求救信号，来自北方3公里处。',
                    choices: [
                        {text: '前往调查 (消耗20体力)', energyCost: 20, reward: {caps: 200, food: 5}, risk: 'combat'},
                        {text: '忽略信号', reward: {}}
                    ],
                    weight: 0.8
                },
                {
                    id: 'rain_collector',
                    title: '酸雨降临',
                    desc: '天空下起了辐射酸雨，但你注意到你的集水器正在收集这些水。',
                    condition: 'water_collector',
                    choices: [
                        {text: '收集辐射水 (获得5水但+5辐射)', reward: {water: 5}, radiation: 5},
                        {text: '躲在避难所', reward: {}}
                    ],
                    weight: 1.0
                },
                {
                    id: 'mole_rat_nest',
                    title: '鼹鼠窝',
                    desc: '你意外发现了一个巨大的鼹鼠窝，里面似乎有它们收集的闪亮物品。',
                    choices: [
                        {text: '探索巢穴', risk: 'combat', enemy: 'mole_rat', reward: {caps: 80, crystal: 1}},
                        {text: '悄悄离开', reward: {}}
                    ],
                    weight: 1.3
                },
                {
                    id: 'broken_robot',
                    title: '损坏的机器人',
                    desc: '一个旧时代的家用机器人倒在路边，它的电路板似乎还能用。',
                    skillCheck: {skill: 'crafting', difficulty: 2},
                    choices: [
                        {text: '拆解 (需要制作等级2)', reward: {circuit_board: 2, electronics: 5}},
                        {text: '离开', reward: {}}
                    ],
                    weight: 1.0
                },
                {
                    id: 'ghoul_attack',
                    title: '食尸鬼袭击',
                    desc: '突然从阴影中冲出几只食尸鬼！你必须立刻做出反应。',
                    choices: [
                        {text: '战斗!', combat: true, enemy: 'ghoul'},
                        {text: '逃跑 (50%成功率)', flee: true}
                    ],
                    weight: 1.5,
                    danger: true
                },
                {
                    id: 'supply_drop',
                    title: '空投物资',
                    desc: '一架无人机从头顶飞过，投下一个补给箱！但看起来有其他人也发现了。',
                    choices: [
                        {text: '快速抢夺', reward: {food: 10, water: 10, ammo: 50}, risk: 'combat'},
                        {text: '谨慎接近', reward: {food: 5, water: 5}, delay: true}
                    ],
                    weight: 0.6
                },
                {
                    id: 'mysterious_shrine',
                    title: '神秘祭坛',
                    desc: '你发现一个奇怪的辐射教徒祭坛，上面摆放着发光的结晶。',
                    choices: [
                        {text: '拿走结晶 (+3辐射结晶)', reward: {crystal: 3}, radiation: 10},
                        {text: '祭拜 (-10辐射)', reward: {}, radiation: -10},
                        {text: '远离', reward: {}}
                    ],
                    weight: 0.7
                },
                {
                    id: 'wounded_soldier',
                    title: '受伤士兵',
                    desc: '一名受伤的士兵靠在墙边，他请求你给他一点水。',
                    choices: [
                        {text: '帮助 (给1水)', cost: {water: 1}, reward: {caps: 50, ammo: 20}, affection: {npc: 'soldier', amount: 20}},
                        {text: '无视', reward: {}, karma: -10},
                        {text: '搜刮他', reward: {caps: 30, ammo: 10}, karma: -30}
                    ],
                    weight: 1.0
                },
                {
                    id: 'chemical_spill',
                    title: '化学品泄漏',
                    desc: '你发现一个翻倒的化学运输车， barrels正在泄漏。',
                    choices: [
                        {text: '收集化学品 (+10辐射)', reward: {chemicals: 5}, radiation: 10},
                        {text: '封裝储存 (需要2塑料)', cost: {plastic: 2}, reward: {chemicals: 5}},
                        {text: '离开', reward: {}}
                    ],
                    weight: 0.9
                },
                {
                    id: 'lottery_ticket',
                    title: '旧彩票',
                    desc: '你在废墟中找到一张战前的彩票，虽然可能已经过期...',
                    choices: [
                        {text: '保留纪念', reward: {}},
                        {text: '扔掉', reward: {}, karma: 5}
                    ],
                    weight: 0.8
                },
                {
                    id: 'dog_fight',
                    title: '斗狗场',
                    desc: '一群强盗在废墟中举办斗狗比赛，你的伙伴看起来很兴奋。',
                    condition: 'pet',
                    choices: [
                        {text: '参加比赛 (宠物战斗)', petCombat: true, reward: {caps: 100}, risk: 'pet_injury'},
                        {text: '押注50瓶盖', cost: {caps: 50}, reward: {caps: 100}, failChance: 0.6, failText: '你押注的狗输了...'},
                        {text: '离开', reward: {}}
                    ],
                    weight: 0.7
                },
                {
                    id: 'library_cache',
                    title: '图书馆藏',
                    desc: '你发现了一个保存完好的图书馆，里面可能有有用的知识。',
                    choices: [
                        {text: '搜寻技术手册', reward: {exp: 100}, skill: {crafting: 1}},
                        {text: '搜寻生存指南', reward: {exp: 100}, skill: {survival: 1}},
                        {text: '搜寻战斗技巧', reward: {exp: 100}, skill: {combat: 1}}
                    ],
                    weight: 0.9
                }
            ],
            
            quests: [
                // 主线任务
                {
                    id: 'q1',
                    type: 'main',
                    title: '第一个夜晚',
                    desc: '在天黑前建立一个简易帐篷以度过夜晚。这是生存的第一步。',
                    target: { build: 'tent' },
                    reward: { exp: 50, caps: 100, wood: 20 },
                    completed: false
                },
                {
                    id: 'q2',
                    type: 'main',
                    title: '水源危机',
                    desc: '建造集水器确保持续的水源供应。水是生存的必需品。',
                    target: { build: 'water_collector' },
                    reward: { exp: 80, caps: 150, food: 5 },
                    completed: false
                },
                {
                    id: 'q3',
                    type: 'main',
                    title: '废土猎人',
                    desc: '击败3个敌人证明你的战斗能力。废土不相信眼泪，只相信实力。',
                    target: { kill: 3 },
                    reward: { exp: 150, caps: 300, metal: 20 },
                    progress: 0,
                    completed: false
                },
                {
                    id: 'q4',
                    type: 'main',
                    title: '建造工坊',
                    desc: '建造工坊以制作更好的装备。工欲善其事，必先利其器。',
                    target: { build: 'workshop' },
                    reward: { exp: 200, caps: 400, electronics: 10 },
                    completed: false
                },
                {
                    id: 'q5',
                    type: 'main',
                    title: '寻找伙伴',
                    desc: '在废土中找到并驯服一只宠物。孤独是最危险的敌人。',
                    target: { pet: true },
                    reward: { exp: 300, caps: 500, food: 10 },
                    completed: false
                },
                {
                    id: 'q6',
                    type: 'main',
                    title: '营地领袖',
                    desc: '招募3名NPC加入你的营地。团结就是力量。',
                    target: { recruits: 3 },
                    reward: { exp: 500, caps: 1000, crystal: 5 },
                    progress: 0,
                    completed: false
                },
                
                // 支线任务
                {
                    id: 's1',
                    type: 'side',
                    title: '木材大亨',
                    desc: '收集100个木材。(0/100)',
                    target: { resource: 'wood', amount: 100 },
                    reward: { exp: 50, caps: 100, stone: 30 },
                    progress: 0,
                    completed: false
                },
                {
                    id: 's2',
                    type: 'side',
                    title: '电子专家',
                    desc: '制作5个电子元件。(0/5)',
                    target: { craft: 'electronics', amount: 5 },
                    reward: { exp: 100, caps: 200, circuit_board: 3 },
                    progress: 0,
                    completed: false
                },
                {
                    id: 's3',
                    type: 'side',
                    title: '武器大师',
                    desc: '制作一把步枪。(0/1)',
                    target: { craft: 'rifle' },
                    reward: { exp: 200, caps: 300, ammo: 100 },
                    completed: false
                },
                
                // 日常任务
                {
                    id: 'd1',
                    type: 'daily',
                    title: '日常探索',
                    desc: '进行3次探索。(0/3)',
                    target: { explore: 3 },
                    reward: { exp: 80, caps: 150, wood: 10 },
                    progress: 0,
                    completed: false,
                    refreshDay: 0
                },
                {
                    id: 'd2',
                    type: 'daily',
                    title: '资源收集',
                    desc: '收集任意资源50个。(0/50)',
                    target: { collectAny: 50 },
                    reward: { exp: 60, caps: 100 },
                    progress: 0,
                    completed: false,
                    refreshDay: 0
                },
                {
                    id: 'd3',
                    type: 'daily',
                    title: '商人交易',
                    desc: '与商人进行1次交易。(0/1)',
                    target: { trade: 1 },
                    reward: { exp: 40, caps: 200 },
                    progress: 0,
                    completed: false,
                    refreshDay: 0
                }
            ],
            
            pets: [
                {id: 'dog', name: '阿尔法', icon: '🐕', type: 'combat', bonus: {damage: 8, defense: 2}, desc: '忠诚的军犬，增加攻击力和防御力'},
                {id: 'cat', name: '喵喵', icon: '🐈', type: 'survival', bonus: {findBonus: 0.3, stealth: 0.2}, desc: '机敏的猫，提高资源发现率和潜行能力'},
                {id: 'robot', name: 'R2-D2', icon: '🤖', type: 'utility', bonus: {craftSpeed: 0.5, storage: 20}, desc: '旧时代机器人，减少制作消耗并增加背包空间'},
                {id: 'bird', name: '小彩', icon: '🦜', type: 'scout', bonus: {avoidDanger: 0.25, findBonus: 0.2}, desc: '变异的鹦鹉，能预警危险并寻找资源'},
                {id: 'lizard', name: '辐射蜥', icon: '🦎', type: 'radiation', bonus: {radResist: 0.5, radHeal: 2}, desc: '抗辐射蜥蜴，减少辐射伤害并缓慢清除辐射'}
            ],
            
            npcs: [
                {id: 'doc', name: '医生李', icon: '👨‍⚕️', role: '医生', affection: 0, maxAffection: 100, 
                 desc: '前战地医生，可以提供医疗帮助和制作药品配方', gift: 'medkit', specialty: 'medical'},
                {id: 'merchant', name: '行商老张', icon: '👳‍♂️', role: '商人', affection: 10, maxAffection: 100,
                 desc: '废土老手，提供更好的交易价格和稀有物品', gift: 'caps', specialty: 'trade'},
                {id: 'engineer', name: '工程师王', icon: '👷‍♂️', role: '工程师', affection: 0, maxAffection: 100,
                 desc: '机械天才，帮助建造高级设施和修理装备', gift: 'electronics', specialty: 'craft'},
                {id: 'hunter', name: '猎手陈', icon: '🏹', role: '猎人', affection: 0, maxAffection: 100,
                 desc: '废土猎人，分享狩猎技巧并提供食物', gift: 'food', specialty: 'combat'},
                {id: 'scientist', name: '博士杨', icon: '👩‍🔬', role: '科学家', affection: 0, maxAffection: 100,
                 desc: '辐射研究专家，可以净化辐射和制作高级物品', gift: 'crystal', specialty: 'science'},
                {id: 'soldier', name: '老兵赵', icon: '🎖️', role: '士兵', affection: 0, maxAffection: 100,
                 desc: '退役特种兵，训练战斗技能并提供武器', gift: 'ammo', specialty: 'combat'}
            ],
            
            buildings: [
                {id: 'tent', name: '简易帐篷', icon: '⛺', cost: {wood: 15, cloth: 5}, effect: '基础庇护，每日恢复少量生命', level: 1},
                {id: 'water_collector', name: '集水器', icon: '💧', cost: {wood: 20, metal: 5, plastic: 3}, effect: '每日+2水', level: 1},
                {id: 'storage', name: '储藏室', icon: '📦', cost: {wood: 30, metal: 10}, effect: '资源容量+50', level: 1},
                {id: 'greenhouse', name: '温室', icon: '🌱', cost: {wood: 40, stone: 20, plastic: 10, water: 5}, effect: '每日+3食物', level: 2, req: 'water_collector'},
                {id: 'workshop', name: '工坊', icon: '🔨', cost: {wood: 35, stone: 25, metal: 20, electronics: 3}, effect: '解锁高级制作', level: 2},
                {id: 'medical_station', name: '医疗站', icon: '🏥', cost: {wood: 40, metal: 15, electronics: 5, chemicals: 3}, effect: '每日回血+15', level: 2, req: 'tent'},
                {id: 'armory', name: '军械库', icon: '🏰', cost: {stone: 60, metal: 50, electronics: 10}, effect: '装备强化+解锁高级武器', level: 3, req: 'workshop'},
                {id: 'bunker', name: '地下堡垒', icon: '🛡️', cost: {stone: 100, metal: 80, electronics: 20, crystal: 5}, effect: '辐射防护+营地防御+50', level: 4, req: 'armory'},
                {id: 'laboratory', name: '实验室', icon: '🔬', cost: {metal: 60, electronics: 40, chemicals: 20, circuit_board: 10}, effect: '制作药品+辐射研究', level: 3, req: 'medical_station'},
                {id: 'power_station', name: '发电站', icon: '⚡', cost: {metal: 80, electronics: 30, fuel: 20, gears: 15}, effect: '解锁电力设备制作', level: 3}
            ],
            
            // 装备系统扩展
            weapons: [
                // 近战武器
                {id: 'knife', name: '生存刀', icon: '🔪', damage: 12, cost: {wood: 5, metal: 3}, level: 0, type: 'melee'},
                {id: 'bat', name: '球棒', icon: '🏏', damage: 18, cost: {wood: 15}, level: 0, type: 'melee'},
                {id: 'machete', name: '砍刀', icon: '🗡️', damage: 25, cost: {metal: 20, wood: 5}, level: 0, type: 'melee'},
                {id: 'chainsaw', name: '电锯', icon: '🪚', damage: 45, cost: {metal: 40, fuel: 15, gears: 10}, level: 0, type: 'melee', req: 'workshop'},
                // 远程武器
                {id: 'pistol', name: '手枪', icon: '🔫', damage: 30, cost: {metal: 20, electronics: 5, ammo: 20}, level: 0, type: 'ranged'},
                {id: 'rifle', name: '步枪', icon: '🎯', damage: 50, cost: {metal: 40, electronics: 10, wood: 15, ammo: 50}, level: 0, type: 'ranged', req: 'workshop'},
                {id: 'shotgun', name: '霰弹枪', icon: '🔫', damage: 70, cost: {metal: 50, wood: 20, ammo: 30}, level: 0, type: 'ranged', req: 'workshop'},
                {id: 'sniper', name: '狙击枪', icon: '🎯', damage: 90, cost: {metal: 80, electronics: 30, circuit_board: 5, ammo: 100}, level: 0, type: 'ranged', req: 'armory'},
                // 能量武器
                {id: 'laser_pistol', name: '激光手枪', icon: '⚡', damage: 60, cost: {metal: 30, electronics: 25, crystal: 3}, level: 0, type: 'energy', req: 'laboratory'},
                {id: 'plasma_rifle', name: '等离子步枪', icon: '☄️', damage: 120, cost: {metal: 100, electronics: 60, crystal: 10, chemicals: 20}, level: 0, type: 'energy', req: 'laboratory'},
                // 特殊武器
                {id: 'fat_man', name: '胖子发射器', icon: '💣', damage: 300, cost: {metal: 200, electronics: 100, chemicals: 50, crystal: 20}, level: 0, type: 'heavy', req: 'bunker', ammo: 'mini_nuke'}
            ],
            
            armors: [
                {id: 'clothes', name: '破烂衣服', icon: '👕', defense: 2, cost: {cloth: 10}, level: 0},
                {id: 'leather', name: '皮甲', icon: '🧥', defense: 8, cost: {cloth: 15, metal: 10}, level: 0},
                {id: 'metal_armor', name: '金属甲', icon: '⛓️', defense: 20, cost: {metal: 40}, level: 0, req: 'workshop'},
                {id: 'combat_armor', name: '战斗装甲', icon: '🦺', defense: 35, cost: {metal: 60, electronics: 15, cloth: 20}, level: 0, req: 'armory'},
                {id: 'power_armor', name: '动力装甲', icon: '🤖', defense: 80, cost: {metal: 150, electronics: 80, fuel: 50, crystal: 10}, level: 0, req: 'bunker', effect: 'str+5'},
                {id: 'stealth_suit', name: '隐形服', icon: '👤', defense: 15, cost: {cloth: 30, electronics: 40, chemicals: 20}, level: 0, req: 'laboratory', effect: 'stealth+0.5'}
            ],
            
            accessories: [
                {id: 'luck_ring', name: '幸运戒指', icon: '💍', effect: 'findBonus', value: 0.15, cost: {metal: 15, crystal: 1}, desc: '增加15%稀有物品发现率'},
                {id: 'health_amulet', name: '生命护符', icon: '📿', effect: 'healthRegen', value: 3, cost: {electronics: 20, crystal: 2, chemicals: 5}, desc: '每分钟恢复3生命'},
                {id: 'rad_badge', name: '辐射徽章', icon: '☢️', effect: 'radResist', value: 0.3, cost: {metal: 20, electronics: 10, chemicals: 10}, desc: '减少30%辐射伤害'},
                {id: 'ammo_pouch', name: '弹药袋', icon: '🎒', effect: 'ammoSave', value: 0.25, cost: {cloth: 20, metal: 10}, desc: '25%概率不消耗弹药'},
                {id: 'stealth_boy', name: '隐形小子', icon: '👤', effect: 'escapeBonus', value: 0.4, cost: {electronics: 40, chemicals: 20, circuit_board: 5}, desc: '逃跑成功率+40%'},
                {id: 'geiger_counter', name: '盖革计数器', icon: '📟', effect: 'radWarning', value: 1, cost: {electronics: 25, metal: 10}, desc: '预警高辐射区域'}
            ],
            
            // 工具类物品（新）
            tools: [
                {id: 'flashlight', name: '手电筒', icon: '🔦', effect: 'nightExplore', cost: {metal: 5, electronics: 3, plastic: 2}},
                {id: 'radio', name: '收音机', icon: '📻', effect: 'eventChance', cost: {metal: 8, electronics: 8, circuit_board: 2}},
                {id: 'binoculars', name: '望远镜', icon: '🔭', effect: 'scoutBonus', cost: {metal: 15, plastic: 10, gears: 5}},
                {id: 'lockpick', name: '开锁器', icon: '🔓', effect: 'lockpicking', cost: {metal: 10, gears: 5}},
                {id: 'rope', name: '绳索', icon: '🪢', effect: 'climbAccess', cost: {cloth: 20}}
            ],
            
            enemies: [
                {name: '变异鼠', icon: '🐀', hp: 35, damage: 6, exp: 20, loot: {food: 1, cloth: 2}, type: 'animal'},
                {name: '强盗', icon: '👹', hp: 60, damage: 12, exp: 40, loot: {caps: 50, ammo: 8}, type: 'human'},
                {name: '变异犬', icon: '🐕', hp: 70, damage: 18, exp: 55, loot: {food: 3, cloth: 3}, type: 'animal'},
                {name: '食尸鬼', icon: '💀', hp: 90, damage: 22, exp: 75, loot: {medkit: 1, caps: 60}, type: 'ghoul'},
                {name: '巨蝎', icon: '🦂', hp: 110, damage: 28, exp: 95, loot: {crystal: 1, metal: 15}, type: 'animal'},
                {name: '超级变种人', icon: '🧟', hp: 180, damage: 40, exp: 180, loot: {ammo: 40, metal: 30, caps: 250}, type: 'mutant'},
                {name: '死亡爪', icon: '🦖', hp: 300, damage: 60, exp: 350, loot: {crystal: 5, caps: 500, metal: 100}, type: 'legendary'},
                {name: '辐射僵尸', icon: '☢️', hp: 130, damage: 25, exp: 110, loot: {chemicals: 3, crystal: 2}, type: 'ghoul', radDamage: 5}
            ],
            
            story: {
                intro: `核战后的第5年，你从冷冻舱中醒来。

记忆模糊，只记得战前世界的碎片。辐射尘遮蔽了天空，废土上遍布着变异生物和凶残的强盗。

你在废墟中发现了一个旧日记本，上面写着："北方的避难所还有幸存者..."

你的生存之旅，现在开始。

目标：建立庇护所，收集资源，寻找其他幸存者，在这个残酷的世界活下去。`
            }
        };
        
        // ==================== 核心系统 ====================
        
        let gameState = JSON.parse(JSON.stringify(gameData));
        let currentEnemy = null;
        let gameInterval = null;
        let tooltipTimeout = null;
        
        function init() {
            createParticles();
            initQuests();
            initNPCs();
            addDiaryEntry('intro', config.story.intro);
            
            if (!gameState.flags.introRead) {
                showModal('序章：废土觉醒', config.story.intro, [
                    {text: '🚀 开始生存', action: () => {
                        gameState.flags.introRead = true;
                        closeModal();
                        addLog('欢迎来到废土世界。建造帐篷，开始你的生存之旅。', 'story');
                        showTutorial();
                    }}
                ]);
            }
            
            startGameLoop();
            updateUI();
            setupTooltips();
        }
        
        function showTutorial() {
            setTimeout(() => {
                addLog('💡 提示：点击"探索"标签开始搜刮资源，注意保持各项状态值', 'story');
            }, 2000);
        }
        
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const p = document.createElement('div');
                p.className = `particle type-${Math.floor(Math.random() * 3) + 1}`;
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.width = p.style.height = Math.random() * 6 + 2 + 'px';
                p.style.animationDelay = Math.random() * 15 + 's';
                p.style.animationDuration = 15 + Math.random() * 20 + 's';
                container.appendChild(p);
            }
        }
        
        function setupTooltips() {
            const tooltip = document.getElementById('tooltip');
            
            document.addEventListener('mouseover', (e) => {
                const target = e.target.closest('[data-tooltip]');
                if (target) {
                    clearTimeout(tooltipTimeout);
                    const title = target.getAttribute('data-title') || '';
                    const content = target.getAttribute('data-tooltip');
                    
                    document.getElementById('tooltipTitle').textContent = title;
                    document.getElementById('tooltipContent').textContent = content;
                    
                    tooltip.classList.add('show');
                    tooltip.style.left = e.pageX + 15 + 'px';
                    tooltip.style.top = e.pageY + 15 + 'px';
                }
            });
            
            document.addEventListener('mouseout', () => {
                tooltipTimeout = setTimeout(() => {
                    tooltip.classList.remove('show');
                }, 100);
            });
            
            document.addEventListener('mousemove', (e) => {
                if (tooltip.classList.contains('show')) {
                    tooltip.style.left = e.pageX + 15 + 'px';
                    tooltip.style.top = e.pageY + 15 + 'px';
                }
            });
        }
        
        function startGameLoop() {
            gameInterval = setInterval(() => {
                if (gameState.time.paused) return;
                
                gameState.time.hour++;
                if (gameState.time.hour >= 24) {
                    gameState.time.hour = 0;
                    newDay();
                }
                
                // 更新显示
                document.getElementById('timeDisplay').textContent = 
                    `${String(gameState.time.hour).padStart(2,'0')}:00`;
                
                // 衰减属性
                if (gameState.time.hour % 2 === 0) {
                    decayStats();
                }
                
                // 检查随机事件
                if (Math.random() < 0.02) {
                    triggerRandomEvent();
                }
                
                // 更新辐射显示
                document.getElementById('radDisplay').textContent = 
                    Math.floor(gameState.player.stats.radiation);
                
                updateStatCards();
            }, 2000);
        }
        
        function decayStats() {
            // 基础衰减
            let hungerDecay = 1;
            let thirstDecay = 2;
            let energyDecay = 1;
            
            // 技能影响
            if (gameState.skills.survival > 0) {
                const bonus = gameState.skills.survival * 0.1;
                hungerDecay *= (1 - bonus);
                thirstDecay *= (1 - bonus);
            }
            
            changeStat('hunger', -hungerDecay);
            changeStat('thirst', -thirstDecay);
            changeStat('energy', -energyDecay);
            
            // 辐射伤害
            if (gameState.player.stats.radiation > 50) {
                changeStat('health', -2);
                if (Math.random() < 0.1) addLog('辐射正在侵蚀你的身体...', 'danger');
            }
            
            // 饰品回血
            const acc = config.accessories.find(a => a.id === gameState.equipment.accessory);
            if (acc?.effect === 'healthRegen') {
                changeStat('health', acc.value);
            }
            
            // 低属性惩罚
            if (gameState.player.stats.hunger <= 0) {
                changeStat('health', -3);
                if (Math.random() < 0.1) addLog('饥饿让你虚弱...', 'danger');
            }
            if (gameState.player.stats.thirst <= 0) {
                changeStat('health', -4);
                if (Math.random() < 0.1) addLog('脱水症状出现！', 'danger');
            }
            if (gameState.player.stats.energy <= 0) {
                changeStat('health', -1);
            }
        }
        
        function newDay() {
            gameState.time.day++;
            
            // 添加日记
            addDiaryEntry('daily', `第 ${gameState.time.day} 天：${getDailyReport()}`);
            
            // 建筑效果
            applyBuildingEffects();
            
            // 宠物效果
            applyPetEffects();
            
            // 营地效果
            applyCampEffects();
            
            // 刷新日常任务
            refreshDailyQuests();
            
            // 解锁检查
            checkUnlocks();
            
            updateUI();
        }
        
        function applyBuildingEffects() {
            const effects = [];
            
            if (gameState.buildings.water_collector) {
                const amount = 2 + (gameState.skills.survival * 0.5);
                gameState.resources.water += Math.floor(amount);
                effects.push(`集水器 +${Math.floor(amount)}水`);
            }
            if (gameState.buildings.greenhouse) {
                const amount = 3 + (gameState.skills.survival * 0.5);
                gameState.resources.food += Math.floor(amount);
                effects.push(`温室 +${Math.floor(amount)}食物`);
            }
            if (gameState.buildings.medical_station) {
                const heal = 15 + (gameState.skills.crafting * 2);
                changeStat('health', heal);
                effects.push(`医疗站 +${heal}生命`);
            }
            if (gameState.buildings.power_station) {
                effects.push('发电站运转正常');
            }
            
            if (effects.length > 0) {
                addLog(`每日维护: ${effects.join(', ')}`, 'success');
            }
        }
        
        function applyPetEffects() {
            if (!gameState.pet) return;
            
            if (gameState.pet.type === 'survival') {
                const bonus = Math.floor(Math.random() * 4) + 1;
                const res = ['wood', 'stone', 'metal', 'plastic'][Math.floor(Math.random() * 4)];
                gameState.resources[res] += bonus;
                addLog(`${gameState.pet.name} 带回了 ${bonus} 个${getResourceName(res)}`, 'loot');
            }
            
            if (gameState.pet.type === 'radiation') {
                gameState.player.stats.radiation = Math.max(0, gameState.player.stats.radiation - gameState.pet.bonus.radHeal);
            }
        }
        
        function applyCampEffects() {
            const level = gameState.camp.level;
            const heal = level * 3;
            changeStat('health', heal);
            
            // 防御事件
            if (Math.random() < 0.1) {
                const defense = gameState.camp.defense;
                if (defense > 30) {
                    addLog('营地成功抵御了强盗的骚扰', 'success');
                } else {
                    addLog('营地遭到袭击！损失了一些资源', 'danger');
                    loseRandomResources();
                }
            }
        }
        
        function loseRandomResources() {
            const resources = Object.keys(gameState.resources).filter(r => gameState.resources[r] > 0);
            if (resources.length === 0) return;
            
            const res = resources[Math.floor(Math.random() * resources.length)];
            const amount = Math.min(gameState.resources[res], Math.floor(Math.random() * 5) + 1);
            gameState.resources[res] -= amount;
            addLog(`失去了 ${amount} ${getResourceName(res)}`, 'danger');
        }
        
        function getDailyReport() {
            const events = [];
            if (gameState.stats.kills > 0) events.push(`击杀了 ${gameState.stats.kills} 个敌人`);
            if (gameState.stats.explores > 0) events.push(`探索了 ${gameState.stats.explores} 次`);
            if (gameState.buildings.greenhouse) events.push('温室运转良好');
            
            if (events.length === 0) return '平静的一天，幸存者们各忙各的。';
            return events.join('，') + '。';
        }
        
        function checkUnlocks() {
            if (gameState.player.level >= 5 && !gameState.flags.factoryUnlocked) {
                gameState.flags.factoryUnlocked = true;
                document.getElementById('factoryCard').style.display = 'block';
                addLog('解锁新区域：废弃工厂！', 'story');
                showAchievement('区域解锁', '废弃工厂现已开放探索');
            }
        }
        
        // ==================== 探索与战斗 ====================
        
        function explore(location) {
            const costs = {suburbs: 10, city: 20, lab: 30, factory: 40};
            const riskLevel = {suburbs: 0.3, city: 0.5, lab: 0.7, factory: 0.8};
            
            if (gameState.player.stats.energy < costs[location]) {
                addLog('体力不足！需要休息恢复', 'warning');
                return;
            }
            
            changeStat('energy', -costs[location]);
            gameState.stats.explores++;
            
            // 辐射积累
            const radGain = {suburbs: 1, city: 3, lab: 8, factory: 10}[location];
            const radResist = getRadResist();
            const finalRad = Math.max(0, radGain * (1 - radResist));
            gameState.player.stats.radiation = Math.min(100, gameState.player.stats.radiation + finalRad);
            
            // 检查遭遇
            let encounterChance = riskLevel[location];
            if (gameState.pet?.type === 'scout') encounterChance *= (1 - gameState.pet.bonus.avoidDanger);
            
            if (Math.random() < encounterChance) {
                const enemyPool = {
                    suburbs: [0, 1],
                    city: [1, 2, 3],
                    lab: [3, 4, 5],
                    factory: [4, 5, 6]
                }[location];
                
                const enemyIdx = enemyPool[Math.floor(Math.random() * enemyPool.length)];
                const enemy = {...config.enemies[enemyIdx]};
                enemy.maxHp = enemy.hp;
                enemy.level = Math.floor(gameState.player.level * 0.8) + 1;
                enemy.hp = Math.floor(enemy.hp * (1 + enemy.level * 0.1));
                enemy.damage = Math.floor(enemy.damage * (1 + enemy.level * 0.05));
                enemy.exp = Math.floor(enemy.exp * (1 + enemy.level * 0.1));
                
                startCombat(enemy);
                return;
            }
            
            // 获取资源
            const rewards = {
                suburbs: {wood: [15,30], stone: [10,20], cloth: [5,15], plastic: [3,8]},
                city: {metal: [15,30], electronics: [3,10], ammo: [15,30], caps: [30,100], gears: [2,8]},
                lab: {electronics: [10,25], chemicals: [5,15], medkit: [1,2], crystal: [1,2], circuit_board: [2,5]},
                factory: {metal: [30,50], fuel: [10,20], gears: [10,20], electronics: [15,30], plastic: [20,40]}
            };
            
            let lootText = [];
            const bonus = 1 + (gameState.skills.survival * 0.1) + (gameState.pet?.bonus.findBonus || 0);
            
            for (let [res, range] of Object.entries(rewards[location])) {
                const amount = Math.floor((rand(range[0], range[1]) * bonus));
                gameState.resources[res] += amount;
                lootText.push(`${amount}${getResourceIcon(res)}`);
            }
            
            addLog(`探索成功！获得: ${lootText.join(' ')}`, 'loot');
            gainExp(15 * (location === 'factory' ? 2 : 1));
            updateQuestProgress('explore', 1);
            updateQuestProgress('collectAny', rewards[location].length);
            updateUI();
        }
        
        function getRadResist() {
            let resist = 0;
            if (gameState.buildings.bunker) resist += 0.3;
            const acc = config.accessories.find(a => a.id === gameState.equipment.accessory);
            if (acc?.effect === 'radResist') resist += acc.value;
            if (gameState.pet?.type === 'radiation') resist += gameState.pet.bonus.radResist;
            return Math.min(0.8, resist);
        }
        
        function startCombat(enemy) {
            currentEnemy = enemy;
            
            const combatHTML = `
                <div class="combat-arena">
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #ff416c; text-shadow: 0 0 20px rgba(255,65,108,0.8);">
                        ⚔️ 战斗开始 - ${enemy.name} Lv.${enemy.level}
                    </div>
                    <div class="enemy-sprite">${enemy.icon}</div>
                    <div class="enemy-name">${enemy.name}</div>
                    <div style="color: #888; margin-bottom: 20px; font-size: 14px;">
                        攻击力: ${enemy.damage} | 类型: ${enemy.type}
                    </div>
                    <div class="enemy-hp-bar">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                            <span>HP</span>
                            <span id="enemyHpText">${enemy.hp}/${enemy.maxHp}</span>
                        </div>
                        <div style="height: 24px; background: rgba(0,0,0,0.5); border-radius: 12px; overflow: hidden; border: 2px solid rgba(255,65,108,0.3);">
                            <div id="enemyHpBar" style="width: 100%; height: 100%; background: linear-gradient(90deg, #ff416c, #ff6b6b); transition: width 0.3s; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite;"></div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                        <button class="action-btn" onclick="playerAttack()">⚔️ 攻击</button>
                        <button class="action-btn info" onclick="useSkill()">⚡ 技能</button>
                        <button class="action-btn" onclick="useItem('medkit')">💊 治疗</button>
                        <button class="action-btn danger" onclick="flee()">🏃 逃跑</button>
                    </div>
                    ${gameState.pet ? `<div style="margin-top: 20px; color: #888; font-size: 13px;">${gameState.pet.name} 正在协助战斗</div>` : ''}
                </div>
            `;
            
            document.getElementById('combatArea').innerHTML = combatHTML;
            document.getElementById('combatArea').style.display = 'block';
            addLog(`遭遇 Lv.${enemy.level} ${enemy.name}！`, 'danger');
        }
        
        function playerAttack() {
            if (!currentEnemy) return;
            
            const weapon = config.weapons.find(w => w.id === gameState.equipment.weapon);
            let damage = 8 + (gameState.skills.combat * 4);
            
            // 武器加成
            if (weapon) {
                damage += weapon.damage + (weapon.level * 5);
            }
            
            // 宠物加成
            if (gameState.pet?.type === 'combat') {
                damage += gameState.pet.bonus.damage;
            }
            
            // 随机波动
            damage = Math.floor(damage * (0.9 + Math.random() * 0.2));
            
            // 暴击
            const critChance = 0.08 + (gameState.skills.combat * 0.03);
            const isCrit = Math.random() < critChance;
            if (isCrit) {
                damage = Math.floor(damage * 2);
                addLog('💥 暴击！', 'warning');
            }
            
            currentEnemy.hp -= damage;
            showDamage(damage, document.querySelector('.enemy-sprite'), isCrit);
            
            if (currentEnemy.hp <= 0) {
                setTimeout(() => winCombat(), 600);
                return;
            }
            
            updateCombatUI();
            
            // 宠物反击
            if (gameState.pet?.type === 'combat') {
                setTimeout(() => petAttack(), 400);
            }
            
            setTimeout(() => enemyAttack(), 800);
        }
        
        function petAttack() {
            if (!currentEnemy || !gameState.pet) return;
            const dmg = Math.floor(gameState.pet.bonus.damage * (0.8 + Math.random() * 0.4));
            currentEnemy.hp -= dmg;
            addLog(`${gameState.pet.name} 造成 ${dmg} 点伤害`, 'loot');
            updateCombatUI();
            
            if (currentEnemy.hp <= 0) {
                setTimeout(() => winCombat(), 400);
            }
        }
        
        function enemyAttack() {
            if (!currentEnemy) return;
            
            let damage = currentEnemy.damage;
            
            // 护甲减伤
            const armor = config.armors.find(a => a.id === gameState.equipment.armor);
            if (armor) {
                const defense = armor.defense + (armor.level * 3);
                damage = Math.max(1, damage - defense);
            }
            
            // 宠物防御
            if (gameState.pet?.bonus.defense) {
                damage = Math.max(1, damage - gameState.pet.bonus.defense);
            }
            
            // 闪避
            const dodgeChance = gameState.skills.combat * 0.02;
            if (Math.random() < dodgeChance) {
                addLog('闪避成功！', 'success');
                return;
            }
            
            changeStat('health', -damage);
            
            // 辐射伤害
            if (currentEnemy.radDamage) {
                gameState.player.stats.radiation += currentEnemy.radDamage;
                addLog(`受到 ${currentEnemy.radDamage} 点辐射伤害！`, 'danger');
            }
            
            document.body.classList.add('flash');
            setTimeout(() => document.body.classList.remove('flash'), 300);
            
            addLog(`${currentEnemy.name} 造成 ${damage} 点伤害！`, 'danger');
        }
        
        function winCombat() {
            const enemy = currentEnemy;
            addLog(`🎉 击败了 ${enemy.name}！获得 ${enemy.exp} 经验`, 'success');
            
            // 战利品
            for (let [item, amount] of Object.entries(enemy.loot)) {
                const bonus = 1 + (gameState.skills.survival * 0.1);
                const finalAmount = Math.floor(amount * bonus);
                gameState.resources[item] = (gameState.resources[item] || 0) + finalAmount;
                addLog(`获得 ${finalAmount} ${getResourceName(item)}`, 'loot');
            }
            
            // 额外掉落
            if (Math.random() < 0.1) {
                gameState.caps += 50;
                addLog('幸运掉落：50 瓶盖！', 'loot');
            }
            
            gameState.stats.kills++;
            gainExp(enemy.exp);
            updateQuestProgress('kill', 1);
            
            // 宠物经验
            if (gameState.pet) {
                gameState.pet.exp += Math.floor(enemy.exp / 2);
                if (gameState.pet.exp >= 100 * (Math.floor(gameState.pet.exp / 100) + 1)) {
                    addLog(`${gameState.pet.name} 升级了！`, 'success');
                }
            }
            
            // 特殊事件
            if (enemy.name === '变异犬' && !gameState.pet && Math.random() < 0.4) {
                setTimeout(() => {
                    showModal('驯服机会', '这只变异犬似乎认出了你作为新的主人。要收养它吗？', [
                        {text: '✅ 收养', action: () => { acquirePet('dog'); closeModal(); }},
                        {text: '❌ 离开', action: closeModal }
                    ]);
                }, 500);
            }
            
            endCombat();
        }
        
        function flee() {
            let chance = 0.4 + (gameState.skills.survival * 0.05);
            const acc = config.accessories.find(a => a.id === gameState.equipment.accessory);
            if (acc?.effect === 'escapeBonus') chance += acc.value;
            
            if (Math.random() < chance) {
                addLog('成功逃脱！', 'success');
                endCombat();
            } else {
                addLog('逃跑失败！', 'danger');
                enemyAttack();
            }
        }
        
        function endCombat() {
            currentEnemy = null;
            document.getElementById('combatArea').style.display = 'none';
            updateUI();
        }
        
        function updateCombatUI() {
            if (!currentEnemy) return;
            const pct = Math.max(0, (currentEnemy.hp / currentEnemy.maxHp) * 100);
            document.getElementById('enemyHpBar').style.width = pct + '%';
            document.getElementById('enemyHpText').textContent = `${Math.max(0, currentEnemy.hp)}/${currentEnemy.maxHp}`;
        }
        
        function showDamage(amount, target, isCrit = false) {
            const dmg = document.createElement('div');
            dmg.className = 'damage-number' + (isCrit ? ' critical' : '');
            dmg.textContent = (isCrit ? '暴击! ' : '-') + amount;
            dmg.style.left = '50%';
            dmg.style.top = '40%';
            dmg.style.transform = 'translateX(-50%)';
            target.parentElement.appendChild(dmg);
            setTimeout(() => dmg.remove(), 1200);
        }
        
        // ==================== 随机事件系统 ====================
        
        function triggerRandomEvent() {
            // 检查冷却
            if (gameState.eventCooldowns.lastEvent && 
                gameState.time.day - gameState.eventCooldowns.lastEvent < 1) return;
            
            const availableEvents = config.randomEvents.filter(e => {
                if (e.condition && !gameState.buildings[e.condition] && !gameState[e.condition]) return false;
                if (e.skillCheck && gameState.skills[e.skillCheck.skill] < e.skillCheck.difficulty) return false;
                return true;
            });
            
            if (availableEvents.length === 0) return;
            
            const event = availableEvents[Math.floor(Math.random() * availableEvents.length)];
            gameState.eventCooldowns.lastEvent = gameState.time.day;
            
            showModal(event.title, event.desc, event.choices.map(c => ({
                text: c.text + (c.cost ? ` (${formatCost(c.cost)})` : ''),
                action: () => {
                    // 处理消耗
                    if (c.energyCost) changeStat('energy', -c.energyCost);
                    if (c.cost) {
                        for (let [res, amount] of Object.entries(c.cost)) {
                            gameState.resources[res] -= amount;
                        }
                    }
                    
                    // 处理失败
                    if (c.failChance && Math.random() < c.failChance) {
                        addLog(c.failText || '行动失败！', 'danger');
                        closeModal();
                        return;
                    }
                    
                    // 处理奖励
                    if (c.reward) {
                        for (let [res, amount] of Object.entries(c.reward)) {
                            gameState.resources[res] = (gameState.resources[res] || 0) + amount;
                        }
                        if (c.reward.exp) gainExp(c.reward.exp);
                    }
                    
                    // 处理辐射
                    if (c.radiation) {
                        gameState.player.stats.radiation = Math.max(0, gameState.player.stats.radiation + c.radiation);
                        if (c.radiation > 0) addLog(`受到 ${c.radiation} 点辐射`, 'danger');
                    }
                    
                    // 处理好感
                    if (c.affection) {
                        const npc = gameState.npcs.find(n => n.id === c.affection.npc);
                        if (npc) {
                            npc.affection = Math.min(npc.maxAffection, npc.affection + c.affection.amount);
                            addLog(`${npc.name} 好感度 +${c.affection.amount}`, 'success');
                        }
                    }
                    
                    // 处理技能提升
                    if (c.skill) {
                        for (let [skill, amount] of Object.entries(c.skill)) {
                            gameState.skills[skill] += amount;
                            addLog(`${skill} 技能 +${amount}`, 'success');
                        }
                    }
                    
                    // 处理战斗
                    if (c.combat) {
                        closeModal();
                        const enemy = config.enemies.find(e => e.name.includes(c.enemy) || e.type === c.enemy);
                        if (enemy) {
                            const copy = {...enemy, maxHp: enemy.hp};
                            setTimeout(() => startCombat(copy), 300);
                        }
                        return;
                    }
                    
                    closeModal();
                    updateUI();
                }
            })));
            
            addLog(`🎲 随机事件：${event.title}`, 'event');
        }
        
        // ==================== 任务系统 ====================
        
        function initQuests() {
            gameState.quests = JSON.parse(JSON.stringify(config.quests));
        }
        
        function updateQuestProgress(type, amount) {
            let updated = false;
            gameState.quests.forEach(quest => {
                if (quest.completed) return;
                
                if (type === 'kill' && quest.target?.kill) {
                    quest.progress = (quest.progress || 0) + amount;
                    if (quest.progress >= quest.target.kill) completeQuest(quest);
                }
                if (type === 'explore' && quest.target?.explore) {
                    quest.progress = (quest.progress || 0) + amount;
                    if (quest.progress >= quest.target.explore) completeQuest(quest);
                }
                if (type === 'build' && quest.target?.build && amount === quest.target.build) {
                    completeQuest(quest);
                }
                if (type === 'craft' && quest.target?.craft && amount === quest.target.craft) {
                    completeQuest(quest);
                }
                if (type === 'collectAny') {
                    quest.progress = (quest.progress || 0) + amount;
                    if (quest.progress >= quest.target.collectAny) completeQuest(quest);
                }
                if (type === 'resource' && quest.target?.resource) {
                    const current = gameState.resources[quest.target.resource] || 0;
                    if (current >= quest.target.amount) completeQuest(quest);
                }
                if (type === 'pet' && quest.target?.pet && gameState.pet) {
                    completeQuest(quest);
                }
                if (type === 'recruits' && quest.target?.recruits) {
                    const count = gameState.camp.members.filter(m => m !== 'player').length;
                    if (count >= quest.target.recruits) completeQuest(quest);
                }
            });
            if (updated) renderQuests();
        }
        
        function completeQuest(quest) {
            quest.completed = true;
            gameState.completedQuests.push(quest.id);
            gameState.stats.quests++;
            
            // 发放奖励
            const reward = quest.reward;
            if (reward.exp) gainExp(reward.exp);
            if (reward.caps) gameState.caps += reward.caps;
            for (let [res, amount] of Object.entries(reward)) {
                if (!['exp', 'caps'].includes(res)) {
                    gameState.resources[res] = (gameState.resources[res] || 0) + amount;
                }
            }
            
            showAchievement(`任务完成: ${quest.title}`, formatReward(reward));
            addLog(`✅ 完成任务: ${quest.title}`, 'success');
            addDiaryEntry('quest', `完成了"${quest.title}"，获得了丰厚奖励。`);
            updateUI();
        }
        
        function refreshDailyQuests() {
            gameState.quests.forEach(q => {
                if (q.type === 'daily' && q.completed && gameState.time.day > (q.refreshDay || 0)) {
                    q.completed = false;
                    q.progress = 0;
                    q.refreshDay = gameState.time.day + 1;
                }
            });
        }
        
        function renderQuests() {
            const list = document.getElementById('questList');
            list.innerHTML = '';
            
            const activeQuests = gameState.quests.filter(q => !q.completed);
            
            if (activeQuests.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #666; padding: 60px 20px;"><div style="font-size: 48px; margin-bottom: 20px;">📭</div>当前没有进行中的任务<br><span style="font-size: 13px; opacity: 0.7;">继续探索可能会触发新任务</span></div>';
                return;
            }
            
            activeQuests.forEach(quest => {
                const div = document.createElement('div');
                div.className = 'quest-item';
                
                let progressText = '';
                let progressPct = 0;
                
                if (quest.target?.kill) {
                    progressText = `${quest.progress || 0}/${quest.target.kill}`;
                    progressPct = Math.min(100, ((quest.progress || 0) / quest.target.kill) * 100);
                } else if (quest.target?.explore) {
                    progressText = `${quest.progress || 0}/${quest.target.explore}`;
                    progressPct = Math.min(100, ((quest.progress || 0) / quest.target.explore) * 100);
                } else if (quest.target?.resource) {
                    const current = gameState.resources[quest.target.resource] || 0;
                    progressText = `${current}/${quest.target.amount}`;
                    progressPct = Math.min(100, (current / quest.target.amount) * 100);
                } else if (quest.target?.collectAny) {
                    progressText = `${quest.progress || 0}/${quest.target.collectAny}`;
                    progressPct = Math.min(100, ((quest.progress || 0) / quest.target.collectAny) * 100);
                }
                
                const typeColors = {main: 'var(--neon-blue)', side: 'var(--neon-green)', daily: 'var(--neon-orange)'};
                
                div.innerHTML = `
                    <div class="quest-header">
                        <div class="quest-title">${quest.title}</div>
                        <span class="quest-type" style="background: ${typeColors[quest.type]}20; color: ${typeColors[quest.type]};">
                            ${quest.type === 'main' ? '主线' : quest.type === 'daily' ? '日常' : '支线'}
                        </span>
                    </div>
                    <div class="quest-desc">${quest.desc}</div>
                    ${progressText ? `
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-top: 10px;">
                            <span>进度</span>
                            <span style="color: #fff; font-weight: 600;">${progressText}</span>
                        </div>
                        <div class="quest-progress">
                            <div class="quest-progress-fill" style="width: ${progressPct}%"></div>
                        </div>
                    ` : ''}
                    <div class="quest-reward">🎁 ${formatReward(quest.reward)}</div>
                `;
                list.appendChild(div);
            });
        }
        
        // ==================== 建造系统 ====================
        
        function renderBuildings() {
            const grid = document.getElementById('buildGrid');
            grid.innerHTML = '';
            
            config.buildings.forEach(build => {
                const hasBuilt = gameState.buildings[build.id];
                const canBuild = checkCost(build.cost) && (!build.req || gameState.buildings[build.req]);
                const missingReq = build.req && !gameState.buildings[build.req];
                
                const div = document.createElement('div');
                div.className = 'build-card' + (hasBuilt ? ' built' : '');
                
                let statusText = '';
                if (hasBuilt) {
                    statusText = '<div style="color: var(--neon-green); font-weight: bold; margin-top: 10px;">✓ 已建造</div>';
                } else if (missingReq) {
                    statusText = `<div style="color: #ff416c; font-size: 11px; margin-top: 10px;">🔒 需要: ${config.buildings.find(b => b.id === build.req)?.name || build.req}</div>`;
                } else {
                    statusText = `<div style="font-size: 11px; color: ${canBuild ? 'var(--neon-green)' : '#ff416c'}; margin-top: 10px;">${formatCost(build.cost)}</div>`;
                }
                
                div.innerHTML = `
                    <div class="build-icon">${build.icon}</div>
                    <div class="build-name">${build.name}</div>
                    <div class="build-effect">${build.effect}</div>
                    ${statusText}
                `;
                
                if (!hasBuilt && canBuild) {
                    div.onclick = () => build(build);
                } else if (!hasBuilt && !missingReq) {
                    div.style.opacity = '0.6';
                } else if (missingReq) {
                    div.style.opacity = '0.4';
                }
                
                grid.appendChild(div);
            });
        }
        
        function build(building) {
            if (!checkCost(building.cost)) return;
            
            for (let [res, amount] of Object.entries(building.cost)) {
                gameState.resources[res] -= amount;
            }
            
            gameState.buildings[building.id] = true;
            gameState.stats.builds++;
            addLog(`🏗️ 建造完成: ${building.name}`, 'success');
            addDiaryEntry('build', `建造了${building.name}，基地的${building.effect}。`);
            updateQuestProgress('build', building.id);
            
            // 解锁检查
            if (building.id === 'workshop') {
                showAchievement('工坊解锁', '现在可以制作高级装备了！');
            }
            
            updateUI();
        }
        
        // ==================== 制作系统 ====================
        
        function renderCrafting() {
            const list = document.getElementById('craftList');
            list.innerHTML = '';
            
            const categories = [
                {id: 'weapons', name: '⚔️ 武器', items: config.weapons},
                {id: 'armors', name: '🛡️ 护甲', items: config.armors},
                {id: 'accessories', name: '💍 饰品', items: config.accessories},
                {id: 'tools', name: '🔧 工具', items: config.tools}
            ];
            
            categories.forEach(cat => {
                if (cat.items.length === 0) return;
                
                const div = document.createElement('div');
                div.className = 'craft-category';
                div.innerHTML = `<div class="craft-header"><h3 style="color: var(--neon-blue);">${cat.name}</h3></div>`;
                
                const itemsDiv = document.createElement('div');
                itemsDiv.className = 'craft-items';
                
                cat.items.forEach(item => {
                    const canCraft = checkCost(item.cost) && (!item.req || gameState.buildings[item.req]);
                    const isEquipped = Object.values(gameState.equipment).includes(item.id);
                    const level = item.level || 0;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'craft-item';
                    
                    let stats = '';
                    if (item.damage) stats = `攻击力: ${item.damage + (level * 5)}`;
                    if (item.defense) stats = `防御力: ${item.defense + (level * 3)}`;
                    if (item.effect) stats = `特殊: ${item.desc || item.effect}`;
                    
                    let reqText = '';
                    if (item.req && !gameState.buildings[item.req]) {
                        reqText = `<div style="color: #ff416c; font-size: 10px;">需要: ${config.buildings.find(b => b.id === item.req)?.name}</div>`;
                    }
                    
                    itemDiv.innerHTML = `
                        <div class="craft-info">
                            <div class="craft-icon">${item.icon}</div>
                            <div class="craft-details">
                                <h4>${item.name} ${level > 0 ? '+' + level : ''} ${isEquipped ? '✓' : ''}</h4>
                                <div class="craft-stats">${stats}</div>
                                <div class="craft-requirements">${formatCost(item.cost)}</div>
                                ${reqText}
                            </div>
                        </div>
                        <div class="craft-actions">
                            ${!isEquipped && canCraft ? `<button class="action-btn" onclick="craft('${item.id}', '${cat.id}')">制作</button>` : ''}
                            ${isEquipped && gameState.buildings.armory && (item.damage || item.defense) ? 
                                `<button class="action-btn warning" onclick="upgradeItem('${item.id}')">强化</button>` : ''}
                        </div>
                    `;
                    itemsDiv.appendChild(itemDiv);
                });
                
                div.appendChild(itemsDiv);
                list.appendChild(div);
            });
        }
        
        function craft(itemId, category) {
            let item;
            if (category === 'weapons') item = config.weapons.find(i => i.id === itemId);
            else if (category === 'armors') item = config.armors.find(i => i.id === itemId);
            else if (category === 'accessories') item = config.accessories.find(i => i.id === itemId);
            else if (category === 'tools') item = config.tools.find(i => i.id === itemId);
            
            if (!item || !checkCost(item.cost)) return;
            
            // 制作技能减少消耗
            const discount = gameState.skills.crafting * 0.05;
            for (let [res, amount] of Object.entries(item.cost)) {
                gameState.resources[res] -= Math.floor(amount * (1 - discount));
            }
            
            // 装备或获得
            if (category === 'tools') {
                addLog(`制作了 ${item.name}`, 'success');
                // 工具效果直接应用
            } else {
                const type = item.damage ? 'weapon' : item.defense ? 'armor' : 'accessory';
                gameState.equipment[type] = itemId;
                addLog(`制作并装备了 ${item.name}`, 'success');
            }
            
            gameState.stats.crafts++;
            updateQuestProgress('craft', itemId);
            updateUI();
        }
        
        function upgradeItem(itemId) {
            if ((gameState.resources.crystal || 0) < 1) {
                addLog('需要辐射结晶！', 'warning');
                return;
            }
            
            const item = [...config.weapons, ...config.armors].find(i => i.id === itemId);
            if (!item || item.level >= 5) {
                addLog('已达到最大强化等级！', 'warning');
                return;
            }
            
            gameState.resources.crystal--;
            item.level++;
            addLog(`✨ ${item.name} 强化到 +${item.level}！`, 'success');
            
            // 特效
            const slot = document.getElementById(item.damage ? 'slot-weapon' : 'slot-armor');
            slot.style.animation = 'pulse 0.5s';
            setTimeout(() => slot.style.animation = '', 500);
            
            updateUI();
        }
        
        function unequip(type) {
            if (!gameState.equipment[type]) return;
            gameState.equipment[type] = null;
            updateUI();
        }
        
        // ==================== 宠物系统 ====================
        
        function acquirePet(petId) {
            const petConfig = config.pets.find(p => p.id === petId);
            gameState.pet = {
                ...petConfig, 
                loyalty: 50, 
                exp: 0,
                level: 1
            };
            gameState.equipment.pet = petId;
            addLog(`🎉 收养了 ${petConfig.name}！`, 'success');
            addDiaryEntry('pet', `在废墟中遇到了忠诚的伙伴${petConfig.name}，它成为了我的家人。`);
            updateQuestProgress('pet', true);
            renderPet();
            updateUI();
        }
        
        function renderPet() {
            const container = document.getElementById('petDisplay');
            if (!gameState.pet) {
                container.innerHTML = `
                    <div style="color: #666; padding: 60px 40px; font-size: 16px;">
                        <div style="font-size: 60px; margin-bottom: 20px;">🐾</div>
                        你还没有伙伴<br>
                        <span style="font-size: 14px; opacity: 0.7;">探索废土时可能会遇到可驯服的动物...</span>
                    </div>
                `;
                return;
            }
            
            const pet = gameState.pet;
            const level = Math.floor(pet.exp / 100) + 1;
            const expPct = (pet.exp % 100);
            
            container.innerHTML = `
                <div class="pet-avatar">${pet.icon}</div>
                <div style="font-size: 28px; font-weight: bold; color: var(--neon-orange); margin: 15px 0;">${pet.name}</div>
                <div style="color: #888; margin-bottom: 30px; font-size: 15px;">${pet.desc}</div>
                
                <div style="max-width: 300px; margin: 0 auto 30px;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 8px;">
                        <span>等级 ${level}</span>
                        <span>${expPct}/100 EXP</span>
                    </div>
                    <div style="height: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; overflow: hidden;">
                        <div style="width: ${expPct}%; height: 100%; background: linear-gradient(90deg, var(--neon-orange), var(--neon-yellow)); transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div class="pet-stats-grid">
                    <div class="pet-stat-card">
                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">忠诚度</div>
                        <div class="pet-stat-value">${pet.loyalty}%</div>
                        <div style="font-size: 24px; margin-top: 5px;">${pet.loyalty > 80 ? '😄' : pet.loyalty > 50 ? '🙂' : '😢'}</div>
                    </div>
                    <div class="pet-stat-card">
                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">类型</div>
                        <div class="pet-stat-value" style="font-size: 20px;">${pet.type}</div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">${getPetTypeDesc(pet.type)}</div>
                    </div>
                    <div class="pet-stat-card">
                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">心情</div>
                        <div class="pet-stat-value" style="font-size: 20px;">
                            ${pet.loyalty > 80 ? '兴奋' : pet.loyalty > 50 ? '平静' : '低落'}
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="action-btn" onclick="feedPet()">🥩 喂食 (${gameState.resources.food || 0}食物)</button>
                    <button class="action-btn warning" onclick="playWithPet()">🎾 玩耍</button>
                    <button class="action-btn info" onclick="trainPet()">📚 训练</button>
                </div>
            `;
        }
        
        function getPetTypeDesc(type) {
            const descs = {
                combat: '战斗辅助型',
                survival: '资源收集型',
                utility: '功能辅助型',
                scout: '侦查预警型',
                radiation: '辐射防护型'
            };
            return descs[type] || '未知类型';
        }
        
        function feedPet() {
            if (gameState.resources.food <= 0) {
                addLog('没有食物了！', 'warning');
                return;
            }
            gameState.resources.food--;
            gameState.pet.loyalty = Math.min(100, gameState.pet.loyalty + 12);
            gameState.pet.exp += 15;
            addLog(`${gameState.pet.name} 开心地吃着食物！忠诚度+12`, 'success');
            renderPet();
        }
        
        function playWithPet() {
            gameState.pet.loyalty = Math.min(100, gameState.pet.loyalty + 8);
            gameState.pet.exp += 10;
            changeStat('energy', -5);
            addLog(`和 ${gameState.pet.name} 玩耍，心情变好了！忠诚度+8`, 'success');
            renderPet();
        }
        
        function trainPet() {
            if (gameState.player.stats.energy < 20) {
                addLog('体力不足，无法训练', 'warning');
                return;
            }
            changeStat('energy', -20);
            gameState.pet.exp += 30;
            addLog(`训练了 ${gameState.pet.name}，它变得更强了！`, 'success');
            renderPet();
        }
        
        function showPetDetail() {
            switchTab('pet');
        }
        
        // ==================== NPC与社交 ====================
        
        function initNPCs() {
            gameState.npcs = JSON.parse(JSON.stringify(config.npcs));
        }
        
        function renderNPCs() {
            const list = document.getElementById('npcList');
            list.innerHTML = '';
            
            gameState.npcs.forEach(npc => {
                const div = document.createElement('div');
                div.className = 'npc-card';
                const hearts = Array(5).fill(0).map((_, i) => 
                    `<span class="heart ${i < Math.floor(npc.affection / 20) ? 'filled' : 'empty'}">❤️</span>`
                ).join('');
                
                div.innerHTML = `
                    <div class="npc-avatar">${npc.icon}</div>
                    <div class="npc-info">
                        <div class="npc-name">${npc.name}</div>
                        <div class="npc-role">${npc.role} · ${npc.specialty}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px; line-height: 1.4;">${npc.desc}</div>
                    </div>
                    <div class="npc-affection">${hearts}</div>
                `;
                
                div.onclick = () => interactNPC(npc);
                list.appendChild(div);
            });
            
            // 营地成员
            const campList = document.getElementById('campMembersList');
            campList.innerHTML = '';
            gameState.camp.members.forEach(member => {
                if (member === 'player') {
                    campList.innerHTML += `
                        <div class="camp-member">
                            <div class="member-avatar" style="background: linear-gradient(135deg, #667eea, #764ba2);">👤</div>
                            <div style="font-size: 12px; font-weight: 600;">你</div>
                            <div style="font-size: 10px; color: #888;">领袖</div>
                        </div>
                    `;
                } else {
                    const npc = gameState.npcs.find(n => n.id === member);
                    campList.innerHTML += `
                        <div class="camp-member">
                            <div class="member-avatar">${npc.icon}</div>
                            <div style="font-size: 12px; font-weight: 600;">${npc.name}</div>
                            <div style="font-size: 10px; color: #888;">${npc.specialty}</div>
                        </div>
                    `;
                }
            });
        }
        
        function interactNPC(npc) {
            const actions = [
                {text: '💬 交谈', action: () => {
                    npc.affection = Math.min(npc.maxAffection, npc.affection + 8);
                    addLog(`与${npc.name}交谈，好感度+8`, 'success');
                    checkRecruit(npc);
                    updateUI();
                    closeModal();
                }}
            ];
            
            if (npc.affection >= 30) {
                actions.push({
                    text: `🎁 请求礼物 (${npc.gift})`, 
                    action: () => {
                        if (npc.gift === 'caps') gameState.caps += 100;
                        else gameState.resources[npc.gift] = (gameState.resources[npc.gift] || 0) + 3;
                        addLog(`${npc.name} 给了你礼物！`, 'loot');
                        npc.affection -= 10; // 消耗好感
                        updateUI();
                        closeModal();
                    }
                });
            }
            
            if (npc.affection >= 50 && npc.specialty === 'trade') {
                actions.push({
                    text: '💰 特殊交易',
                    action: () => {
                        // 打开特殊交易界面
                        addLog('打开了特殊交易商店', 'success');
                        closeModal();
                    }
                });
            }
            
            if (npc.specialty === 'medical' && npc.affection >= 20) {
                actions.push({
                    text: '🏥 治疗服务',
                    action: () => {
                        if (gameState.caps >= 50) {
                            gameState.caps -= 50;
                            changeStat('health', 50);
                            changeStat('radiation', -20);
                            addLog('接受了专业治疗', 'success');
                        } else {
                            addLog('瓶盖不足', 'warning');
                        }
                        closeModal();
                    }
                });
            }
            
            actions.push({text: '👋 离开', action: closeModal});
            
            showModal(npc.name, `${npc.desc}\n\n当前好感度: ${npc.affection}/${npc.maxAffection}\n\n"${getNPCDialogue(npc)}"`, actions);
        }
        
        function getNPCDialogue(npc) {
            const dialogues = {
                doc: ['健康是最重要的财富。', '我这里有最好的药品。', '小心辐射病。'],
                merchant: ['一分钱一分货。', '我这里的货色绝对正宗。', '要看看新到的货吗？'],
                engineer: ['机械就是生命。', '需要修理什么吗？', '我在找稀有的零件。'],
                hunter: ['废土上最危险的是人。', '我追踪那只死亡爪已经一周了。', '要学学怎么设陷阱吗？'],
                scientist: ['知识就是力量。', '辐射也有其利用价值。', '我在研究净化技术。'],
                soldier: ['警惕，永远保持警惕。', '以前的军队？不存在的。', '教你几招防身术？']
            };
            const lines = dialogues[npc.id] || ['...'];
            return lines[Math.floor(Math.random() * lines.length)];
        }
        
        function checkRecruit(npc) {
            if (npc.affection >= 80 && !gameState.camp.members.includes(npc.id) && gameState.camp.members.length < gameState.camp.maxMembers) {
                gameState.camp.members.push(npc.id);
                gameState.camp.prosperity += 50;
                gameState.camp.defense += 15;
                showAchievement('新居民加入', `${npc.name}加入了你的营地！`);
                addLog(`${npc.name} 被你的魅力折服，决定加入营地！`, 'success');
            }
        }
        
        function upgradeCamp() {
            const cost = {
                caps: 500 * gameState.camp.level,
                wood: 100 * gameState.camp.level,
                stone: 80 * gameState.camp.level,
                metal: 50 * gameState.camp.level
            };
            
            if (!checkCost(cost)) {
                addLog('资源不足！', 'warning');
                return;
            }
            
            for (let [res, amount] of Object.entries(cost)) {
                gameState.resources[res] -= amount;
            }
            
            gameState.camp.level++;
            gameState.camp.maxMembers += 2;
            gameState.camp.prosperity += 200;
            gameState.camp.defense += 20;
            
            addLog(`🏕️ 营地升级到 Lv.${gameState.camp.level}！`, 'success');
            showAchievement('营地升级', `最大居民数: ${gameState.camp.maxMembers}`);
            updateUI();
        }
        
        // ==================== 日记系统 ====================
        
        function addDiaryEntry(type, content) {
            const entry = {
                day: gameState.time.day,
                time: `${String(gameState.time.hour).padStart(2,'0')}:00`,
                type,
                content
            };
            gameState.diary.unshift(entry);
            if (gameState.diary.length > 50) gameState.diary.pop();
            renderDiary();
        }
        
        function renderDiary() {
            const container = document.getElementById('diaryEntries');
            if (gameState.diary.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">暂无日记记录</div>';
                return;
            }
            
            container.innerHTML = gameState.diary.map(entry => {
                const typeNames = {
                    intro: '序章', daily: '日常', quest: '任务', build: '建造',
                    pet: '伙伴', combat: '战斗', event: '事件', rest: '休息', system: '系统'
                };
                const typeColors = {
                    intro: 'var(--neon-pink)', daily: 'var(--neon-blue)', quest: 'var(--neon-green)',
                    build: 'var(--neon-orange)', pet: '#ff6b6b', combat: '#ff416c',
                    event: 'var(--neon-purple)', rest: '#f2c94c', system: '#888'
                };
                
                return `
                    <div class="diary-entry">
                        <div class="diary-date">
                            <span>第 ${entry.day} 天 ${entry.time}</span>
                            <span class="diary-type" style="color: ${typeColors[entry.type] || '#fff'}; background: ${typeColors[entry.type] || '#fff'}20;">
                                ${typeNames[entry.type] || entry.type}
                            </span>
                        </div>
                        <div>${entry.content}</div>
                    </div>
                `;
            }).join('');
        }
        
        // ==================== 技能系统 ====================
        
        function renderSkills() {
            const tree = document.getElementById('skillTree');
            tree.innerHTML = '';
            
            const skills = [
                {id: 'combat', name: '战斗专精', icon: '⚔️', desc: '攻击+4/级，暴击+3%/级'},
                {id: 'survival', name: '生存专家', icon: '🌲', desc: '资源+10%/级，消耗-5%/级'},
                {id: 'crafting', name: '工艺大师', icon: '🔨', desc: '制作-10%消耗/级'},
                {id: 'barter', name: '交易大师', icon: '💰', desc: '买卖价格优化+10%/级'},
                {id: 'leadership', name: '领袖魅力', icon: '👑', desc: '营地繁荣+30/级，招募+10%/级'}
            ];
            
            skills.forEach(skill => {
                const level = gameState.skills[skill.id];
                const div = document.createElement('div');
                div.className = 'skill-card' + (level > 0 ? ' active' : '') + (level >= 5 ? ' maxed' : '');
                
                div.innerHTML = `
                    <span class="skill-icon">${skill.icon}</span>
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-level">${level >= 5 ? 'MAX' : 'Lv.' + level}</div>
                    <div class="skill-desc">${skill.desc}</div>
                `;
                
                if (gameState.skillPoints > 0 && level < 5) {
                    div.onclick = () => {
                        gameState.skills[skill.id]++;
                        gameState.skillPoints--;
                        addLog(`🆙 升级技能: ${skill.name} Lv.${gameState.skills[skill.id]}`, 'success');
                        updateUI();
                    };
                }
                
                tree.appendChild(div);
            });
            
            document.getElementById('skillPoints').textContent = gameState.skillPoints;
        }
        
        // ==================== 辅助系统 ====================
        
        function rest() {
            if (gameState.resources.food < 2 || gameState.resources.water < 2) {
                addLog('需要2份食物和2份水才能休息！', 'warning');
                return;
            }
            
            gameState.resources.food -= 2;
            gameState.resources.water -= 2;
            
            // 恢复计算
            const healAmount = 50 + (gameState.camp.level * 10);
            const energyAmount = 100;
            const radHeal = 10 + (gameState.buildings.bunker ? 20 : 0);
            
            changeStat('energy', energyAmount);
            changeStat('health', healAmount);
            gameState.player.stats.radiation = Math.max(0, gameState.player.stats.radiation - radHeal);
            gameState.time.hour = 8;
            
            addLog('🌅 经过一夜的休息，你感觉焕然一新！', 'success');
            addDiaryEntry('rest', `在营地度过了一个平静的夜晚，恢复了${healAmount}点生命值。`);
            updateUI();
        }
        
        function quickEat() {
            useItem('food');
        }
        
        function quickDrink() {
            useItem('water');
        }
        
        function quickHeal() {
            useItem('medkit');
        }
        
        function toggleTime() {
            gameState.time.paused = !gameState.time.paused;
            document.getElementById('timeBtn').textContent = gameState.time.paused ? '▶️ 继续' : '⏸️ 暂停';
            addLog(gameState.time.paused ? '游戏已暂停' : '游戏继续', 'story');
        }
        
        function useItem(item) {
            if ((gameState.resources[item] || 0) <= 0) {
                addLog(`没有${getResourceName(item)}了！`, 'warning');
                return;
            }
            
            gameState.resources[item]--;
            
            switch(item) {
                case 'food':
                    changeStat('hunger', 35);
                    addLog('🥫 食用了罐头，饥饿值恢复', 'success');
                    break;
                case 'water':
                    changeStat('thirst', 45);
                    addLog('💧 饮用净水，水分恢复', 'success');
                    break;
                case 'medkit':
                    changeStat('health', 60);
                    gameState.player.stats.radiation = Math.max(0, gameState.player.stats.radiation - 10);
                    addLog('💊 使用医疗包，生命值大幅恢复，辐射略微降低', 'success');
                    break;
            }
            updateUI();
        }
        
        function gainExp(amount) {
            // 经验加成
            const bonus = 1 + (gameState.skills.leadership * 0.05);
            const finalAmount = Math.floor(amount * bonus);
            
            gameState.player.exp += finalAmount;
            
            // 升级检查
            while (gameState.player.exp >= gameState.player.maxExp) {
                gameState.player.exp -= gameState.player.maxExp;
                gameState.player.level++;
                gameState.player.maxExp = Math.floor(gameState.player.maxExp * 1.4);
                gameState.skillPoints += 2;
                gameState.player.stats.maxHealth += 15;
                gameState.player.stats.health = gameState.player.stats.maxHealth;
                
                showAchievement('升级！', `达到等级 ${gameState.player.level}，获得2技能点`);
                addLog(`🎊 升级！达到 Lv.${gameState.player.level}，最大生命值+15`, 'success');
                
                // 解锁检查
                if (gameState.player.level === 3) {
                    addLog('💡 提示：升级工坊可以制作更好的装备', 'story');
                }
            }
            updateUI();
        }
        
        // ==================== UI更新 ====================
        
        function updateUI() {
            // 玩家等级
            document.getElementById('playerLevel').textContent = gameState.player.level;
            document.getElementById('playerExp').textContent = gameState.player.exp;
            document.getElementById('playerMaxExp').textContent = gameState.player.maxExp;
            document.getElementById('dayDisplay').textContent = gameState.time.day;
            document.getElementById('capCount').textContent = gameState.caps;
            
            // 状态条
            updateBar('health', gameState.player.stats.health, gameState.player.stats.maxHealth);
            updateBar('hunger', gameState.player.stats.hunger, 100);
            updateBar('thirst', gameState.player.stats.thirst, 100);
            updateBar('energy', gameState.player.stats.energy, 100);
            
            // 资源
            const resGrid = document.getElementById('resourcesGrid');
            resGrid.innerHTML = '';
            config.resources.forEach(res => {
                const count = gameState.resources[res.id] || 0;
                if (count > 0 || res.id === 'food' || res.id === 'water' || res.id === 'medkit') {
                    const div = document.createElement('div');
                    div.className = 'resource-card' + (res.rarity === 'rare' ? ' rare' : res.rarity === 'epic' ? ' epic' : '');
                    div.setAttribute('data-title', res.name);
                    div.setAttribute('data-tooltip', res.desc);
                    
                    if (['food', 'water', 'medkit'].includes(res.id)) {
                        div.onclick = () => useItem(res.id);
                        div.style.cursor = 'pointer';
                    }
                    
                    div.innerHTML = `
                        <span class="resource-icon">${res.icon}</span>
                        <div class="resource-name">${res.name}</div>
                        <div class="resource-count">${count}</div>
                    `;
                    resGrid.appendChild(div);
                }
            });
            
            // 装备
            updateEquipment('weapon', config.weapons);
            updateEquipment('armor', config.armors);
            updateEquipment('accessory', config.accessories);
            document.getElementById('petSlotName').textContent = gameState.pet ? gameState.pet.name : '无';
            
            // 统计
            document.getElementById('statKills').textContent = gameState.stats.kills;
            document.getElementById('statExplores').textContent = gameState.stats.explores;
            document.getElementById('statQuests').textContent = gameState.stats.quests;
            document.getElementById('statBuilds').textContent = gameState.stats.builds;
            
            const score = calculateScore();
            document.getElementById('statScore').textContent = score;
            
            // 营地
            document.getElementById('campLevel').textContent = gameState.camp.level;
            document.getElementById('campMembers').textContent = gameState.camp.members.length;
            document.getElementById('campMaxMembers').textContent = gameState.camp.maxMembers;
            document.getElementById('campProsperity').textContent = gameState.camp.prosperity;
            document.getElementById('campDefense').textContent = gameState.camp.defense;
            
            const campEffects = [];
            if (gameState.camp.level >= 1) campEffects.push(`每日恢复${gameState.camp.level * 5}生命`);
            if (gameState.camp.level >= 2) campEffects.push('制作速度+10%');
            if (gameState.camp.level >= 3) campEffects.push('资源产出+15%');
            document.getElementById('campEffects').textContent = campEffects.join('，');
            
            // 日志计数
            document.getElementById('logCount').textContent = document.querySelectorAll('.log-entry').length + ' 条记录';
            
            // 渲染各标签
            renderQuests();
            renderBuildings();
            renderCrafting();
            renderSkills();
            renderNPCs();
            renderPet();
            
            updateStatCards();
        }
        
        function calculateScore() {
            return Math.floor(
                gameState.stats.kills * 100 + 
                gameState.time.day * 60 + 
                gameState.stats.quests * 300 + 
                gameState.stats.builds * 200 +
                gameState.player.level * 600 +
                gameState.camp.prosperity * 2
            );
        }
        
        function updateBar(id, value, max) {
            const pct = Math.max(0, Math.min(100, (value / max) * 100));
            const bar = document.getElementById(id + 'Bar');
            const val = document.getElementById(id + 'Val');
            
            if (bar) bar.style.width = pct + '%';
            if (val) val.textContent = Math.floor(value);
        }
        
        function updateStatCards() {
            // 检查危急状态
            const stats = ['health', 'hunger', 'thirst', 'energy'];
            stats.forEach(stat => {
                const card = document.getElementById(stat + 'Card');
                const value = gameState.player.stats[stat];
                const max = stat === 'health' ? gameState.player.stats.maxHealth : 100;
                
                if (value / max < 0.2) {
                    card.classList.add('critical');
                } else {
                    card.classList.remove('critical');
                }
            });
        }
        
        function updateEquipment(type, configArray) {
            const id = gameState.equipment[type];
            const slot = document.getElementById('slot-' + type);
            const nameEl = document.getElementById(type + 'Name');
            
            if (id) {
                const item = configArray.find(i => i.id === id);
                if (item) {
                    nameEl.textContent = item.name + (item.level > 0 ? ` +${item.level}` : '');
                    slot.classList.add('filled');
                    
                    // 更新等级标记
                    const existingLevel = slot.querySelector('.equipment-level');
                    if (existingLevel) existingLevel.remove();
                    
                    if (item.level > 0) {
                        const levelDiv = document.createElement('div');
                        levelDiv.className = 'equipment-level';
                        levelDiv.textContent = '+' + item.level;
                        slot.appendChild(levelDiv);
                    }
                }
            } else {
                nameEl.textContent = '未装备';
                slot.classList.remove('filled');
                const existingLevel = slot.querySelector('.equipment-level');
                if (existingLevel) existingLevel.remove();
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // 刷新特定标签内容
            if (tabName === 'quest') renderQuests();
            if (tabName === 'build') renderBuildings();
            if (tabName === 'craft') renderCrafting();
            if (tabName === 'pet') renderPet();
            if (tabName === 'social') renderNPCs();
            if (tabName === 'diary') renderDiary();
        }
        
        function changeStat(stat, amount) {
            const max = stat === 'health' ? gameState.player.stats.maxHealth : 100;
            gameState.player.stats[stat] = Math.max(0, Math.min(gameState.player.stats[stat] + amount, max));
            
            if (stat === 'health' && gameState.player.stats.health <= 0) {
                gameOver();
            }
            updateUI();
        }
        
        // ==================== 存档系统 ====================
        
        function saveGame() {
            const data = JSON.stringify(gameState);
            localStorage.setItem('wasteland_v3_save', data);
            localStorage.setItem('wasteland_v3_backup', btoa(encodeURIComponent(data)));
            
            // 显示保存动画
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '✅ 已保存！';
            setTimeout(() => btn.innerHTML = originalText, 2000);
            
            addLog('💾 游戏进度已保存！', 'success');
            showAchievement('存档完成', '你的生存进度已安全存储');
        }
        
        function loadGame() {
            const save = localStorage.getItem('wasteland_v3_save');
            if (!save) {
                addLog('没有找到存档！', 'warning');
                return;
            }
            
            try {
                const loaded = JSON.parse(save);
                // 数据迁移
                gameState = {...gameData, ...loaded};
                
                // 确保新字段存在
                if (!gameState.resources.plastic) gameState.resources.plastic = 0;
                if (!gameState.resources.circuit_board) gameState.resources.circuit_board = 0;
                if (!gameState.resources.gears) gameState.resources.gears = 0;
                if (!gameState.resources.cloth) gameState.resources.cloth = 0;
                if (!gameState.resources.chemicals) gameState.resources.chemicals = 0;
                
                addLog('📂 存档已读取，欢迎回来，幸存者！', 'success');
                addDiaryEntry('system', `读取存档，继续第 ${gameState.time.day} 天的生存。`);
                
                if (gameState.flags.factoryUnlocked) {
                    document.getElementById('factoryCard').style.display = 'block';
                }
                
                updateUI();
            } catch(e) {
                addLog('存档损坏或版本不兼容！', 'danger');
                console.error(e);
            }
        }
        
        function resetGame() {
            if (!confirm('⚠️ 确定要重新开始吗？所有进度将永久丢失！')) return;
            if (!confirm('再次确认：这将清除所有存档数据，无法恢复！')) return;
            
            localStorage.removeItem('wasteland_v3_save');
            localStorage.removeItem('wasteland_v3_backup');
            location.reload();
        }
        
        // ==================== 工具函数 ====================
        
        function addLog(msg, type = 'info') {
            const logArea = document.getElementById('logArea');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = `${String(gameState.time.hour).padStart(2,'0')}:00`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
            
            // 限制条目数
            while (logArea.children.length > 100) {
                logArea.removeChild(logArea.firstChild);
            }
        }
        
        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }
        
        function checkCost(cost) {
            for (let [res, amount] of Object.entries(cost)) {
                if ((gameState.resources[res] || 0) < amount) return false;
            }
            return true;
        }
        
        function formatCost(cost) {
            if (!cost || Object.keys(cost).length === 0) return '免费';
            return Object.entries(cost).map(([res, amt]) => `${amt}${getResourceIcon(res)}`).join(' ');
        }
        
        function formatReward(reward) {
            if (!reward) return '';
            const parts = [];
            if (reward.exp) parts.push(`${reward.exp}经验`);
            if (reward.caps) parts.push(`${reward.caps}瓶盖`);
            for (let [k, v] of Object.entries(reward)) {
                if (!['exp', 'caps'].includes(k)) parts.push(`${v}${getResourceIcon(k)}`);
            }
            return parts.join('，');
        }
        
        function getResourceName(id) {
            return config.resources.find(r => r.id === id)?.name || id;
        }
        
        function getResourceIcon(id) {
            return config.resources.find(r => r.id === id)?.icon || '📦';
        }
        
        function rand(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        // ==================== 模态框系统 ====================
        
        function showModal(title, text, choices) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            
            const choicesDiv = document.getElementById('modalChoices');
            choicesDiv.innerHTML = '';
            
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'modal-choice-btn';
                btn.innerHTML = `
                    ${choice.text}
                    ${choice.cost ? `<div class="choice-cost">消耗: ${formatCost(choice.cost)}</div>` : ''}
                `;
                btn.onclick = choice.action;
                choicesDiv.appendChild(btn);
            });
            
            document.getElementById('gameModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('gameModal').classList.remove('active');
        }
        
        function showAchievement(title, desc) {
            const toast = document.getElementById('achievementToast');
            document.getElementById('achievementText').innerHTML = `
                <strong style="font-size: 18px; display: block; margin-bottom: 5px;">${title}</strong>
                <span style="font-size: 14px; opacity: 0.9;">${desc}</span>
            `;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }
        
        function gameOver() {
            clearInterval(gameInterval);
            const score = calculateScore();
            const days = gameState.time.day;
            
            let rank = '废土流浪者';
            if (score > 5000) rank = '废土传奇';
            else if (score > 3000) rank = '避难所领袖';
            else if (score > 1500) rank = '生存专家';
            else if (score > 800) rank = '拾荒者';
            
            showModal('☠️ 你死了', 
                `你在废土上生存了 ${days} 天\n最终得分: ${score}\n评价: ${rank}\n\n"${getEpitaph()}"\n\n你的故事结束了，但废土永存。`, 
                [
                    {text: '🔄 重新开始', action: resetGame},
                    {text: '💾 读取存档', action: () => { closeModal(); loadGame(); }}
                ]
            );
        }
        
        function getEpitaph() {
            const texts = [
                '又一个消失在废土中的灵魂...',
                '核冬天没有怜悯。',
                '你的故事结束了，但废土永存。',
                '也许下一个幸存者会更幸运。',
                '死亡只是另一种开始。',
                '在辐射中，万物终将腐朽。'
            ];
            return texts[Math.floor(Math.random() * texts.length)];
        }
        
        // 启动游戏
        window.onload = init;
        
        // 防止意外关闭
        window.onbeforeunload = function() {
            if (gameState.time.day > 1) {
                return "你确定要离开吗？未保存的进度将会丢失。";
            }
        };
    </script>
</body>
</html>
