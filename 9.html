<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>辐射避难所：废墟纪元 v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-green: #39ff14;
            --neon-orange: #ff8c00;
            --neon-yellow: #fff700;
            --neon-purple: #b829ff;
            --neon-red: #ff416c;
            --dark-bg: #0a0a0f;
            --menu-height: 70px;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: var(--dark-bg);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: var(--menu-height);
        }
        
        /* 公告栏 */
        .announcement-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, rgba(255, 0, 255, 0.95), rgba(0, 243, 255, 0.95));
            padding: 10px 50px 10px 15px;
            z-index: 2001;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .announcement-bar.hidden {
            display: none;
        }
        
        .announcement-bar .close-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.3);
            border: none;
            color: #fff;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }
        
        .announcement-bar .close-btn:hover {
            background: rgba(0,0,0,0.5);
        }
        
        .announcement-bar .version-tag {
            background: rgba(0,0,0,0.5);
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .announcement-bar .update-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            padding: 5px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
        }
        
        /* 主内容 */
        .main-container {
            margin-top: 45px;
            padding: 15px;
        }
        
        /* 顶部状态栏 */
        .top-status-bar {
            background: linear-gradient(135deg, rgba(45, 19, 44, 0.95), rgba(128, 19, 54, 0.95));
            padding: 12px 15px;
            border-radius: 16px;
            margin-bottom: 15px;
            border: 1px solid var(--neon-pink);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .game-title {
            font-size: 20px;
            font-weight: 900;
            color: var(--neon-blue);
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.8);
        }
        
        .time-display {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .time-item {
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        /* 状态面板 */
        .status-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: linear-gradient(145deg, rgba(40, 45, 65, 0.9), rgba(25, 30, 45, 0.95));
            padding: 12px 8px;
            border-radius: 14px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-card.health { border-color: rgba(255, 65, 108, 0.3); }
        .stat-card.hunger { border-color: rgba(242, 153, 74, 0.3); }
        .stat-card.thirst { border-color: rgba(86, 204, 242, 0.3); }
        .stat-card.energy { border-color: rgba(56, 239, 125, 0.3); }
        
        .stat-card.critical {
            animation: criticalPulse 1s infinite;
            border-color: #ff416c;
        }
        
        @keyframes criticalPulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 65, 108, 0.4); }
            50% { box-shadow: 0 0 30px rgba(255, 65, 108, 0.6); }
        }
        
        .stat-icon { font-size: 22px; margin-bottom: 3px; }
        
        .stat-value {
            font-size: 18px;
            font-weight: 900;
            color: var(--neon-blue);
        }
        
        .stat-bar-container {
            margin-top: 6px;
            height: 6px;
            background: rgba(0,0,0,0.5);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .stat-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s;
        }
        
        /* 玻璃面板 */
        .glass-panel {
            background: linear-gradient(135deg, rgba(30, 30, 50, 0.9), rgba(20, 20, 35, 0.95));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .panel-title {
            color: var(--neon-blue);
            font-size: 16px;
            font-weight: bold;
        }
        
        /* 页面切换 */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--menu-height);
            background: linear-gradient(180deg, rgba(20, 20, 35, 0.98), rgba(10, 10, 20, 0.98));
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: #888;
            min-width: 50px;
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: #ccc;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            color: var(--neon-blue);
        }
        
        .nav-item .icon {
            font-size: 24px;
            line-height: 1;
        }
        
        .nav-item .label {
            font-size: 10px;
            margin-top: 3px;
        }
        
        /* 探索卡片 */
        .explore-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .explore-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .explore-card:hover {
            transform: translateY(-4px);
            border-color: var(--neon-blue);
        }
        
        .explore-icon { font-size: 36px; margin-bottom: 8px; display: block; }
        .explore-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        .explore-info { font-size: 11px; color: #888; line-height: 1.5; }
        
        .risk-low { color: var(--neon-green); }
        .risk-med { color: #f2c94c; }
        .risk-high { color: #ff416c; }
        
        /* 按钮 */
        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .action-btn.danger {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
        }
        
        .action-btn.success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: #000;
        }
        
        .action-btn.warning {
            background: linear-gradient(135deg, #f2994a, #f2c94c);
            color: #000;
        }
        
        /* 资源网格 */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
            gap: 8px;
        }
        
        .resource-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .resource-card:hover {
            border-color: var(--neon-blue);
        }
        
        .resource-icon { font-size: 24px; margin-bottom: 3px; display: block; }
        .resource-count { font-size: 16px; font-weight: bold; color: var(--neon-green); }
        .resource-name { font-size: 9px; color: #888; margin-top: 2px; }
        
        /* 日志 */
        .log-container {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            height: 180px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 4px 0;
            padding: 6px 10px;
            border-radius: 6px;
            border-left: 2px solid transparent;
        }
        
        .log-entry.success { background: rgba(56, 239, 125, 0.1); border-left-color: var(--neon-green); }
        .log-entry.danger { background: rgba(255, 65, 108, 0.1); border-left-color: #ff416c; }
        .log-entry.warning { background: rgba(242, 201, 76, 0.1); border-left-color: #f2c94c; }
        .log-entry.loot { background: rgba(255, 217, 61, 0.1); border-left-color: var(--neon-orange); }
        .log-entry.story { background: rgba(0, 243, 255, 0.1); border-left-color: var(--neon-blue); }
        .log-entry.night { background: rgba(100, 50, 150, 0.2); border-left-color: var(--neon-purple); }
        
        .log-time { font-size: 9px; color: #666; margin-right: 6px; }
        
        /* 任务 */
        .quest-list { max-height: 350px; overflow-y: auto; }
        
        .quest-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border-left: 3px solid var(--neon-orange);
            padding: 12px;
            margin: 8px 0;
            border-radius: 0 10px 10px 0;
        }
        
        .quest-title { font-weight: bold; color: var(--neon-orange); font-size: 13px; }
        .quest-desc { font-size: 11px; color: #888; margin: 4px 0; }
        .quest-progress {
            height: 5px;
            background: rgba(0,0,0,0.4);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }
        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-orange), var(--neon-pink));
            transition: width 0.4s;
        }
        
        /* 建造 */
        .build-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
        }
        
        .build-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 130px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .build-card.built {
            border-color: var(--neon-green);
            background: rgba(57, 255, 20, 0.1);
        }
        
        .build-card:hover:not(.built) {
            border-color: var(--neon-blue);
        }
        
        .build-icon { font-size: 32px; }
        .build-name { font-weight: bold; font-size: 13px; margin: 6px 0; }
        .build-effect { font-size: 10px; color: #888; }
        .build-cost { font-size: 9px; color: #666; margin-top: 6px; }
        
        /* 制作 */
        .craft-category { margin-bottom: 20px; }
        .craft-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .craft-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
        }
        
        .craft-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .craft-info { display: flex; align-items: center; gap: 10px; }
        .craft-icon { font-size: 28px; }
        .craft-details h4 { font-size: 13px; margin-bottom: 2px; }
        .craft-stats { font-size: 10px; color: #888; }
        .craft-requirements { font-size: 9px; color: #666; }
        
        /* 宠物 */
        .pet-container { text-align: center; padding: 15px; }
        .pet-avatar {
            font-size: 70px;
            margin: 15px 0;
            display: inline-block;
            animation: petBounce 3s infinite ease-in-out;
        }
        
        @keyframes petBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        /* NPC */
        .npc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .npc-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .npc-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: var(--neon-blue);
        }
        
        .npc-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .npc-name { font-weight: bold; color: var(--neon-blue); font-size: 14px; }
        .npc-role { font-size: 11px; color: #888; }
        
        /* 装备栏 */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .equipment-slot {
            background: rgba(0,0,0,0.3);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 14px;
            padding: 15px;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .equipment-slot.filled {
            border-style: solid;
            border-color: var(--neon-orange);
            background: rgba(255, 140, 0, 0.15);
        }
        
        .equipment-icon { font-size: 32px; margin-bottom: 3px; }
        
        /* 技能 */
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
        }
        
        .skill-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .skill-card.active { border-color: var(--neon-green); background: rgba(57, 255, 20, 0.1); }
        .skill-card.maxed { border-color: var(--neon-yellow); opacity: 0.8; }
        .skill-card:hover:not(.maxed) { border-color: var(--neon-blue); }
        
        .skill-icon { font-size: 24px; margin-bottom: 3px; }
        .skill-name { font-weight: bold; font-size: 11px; }
        .skill-level { font-size: 10px; color: var(--neon-blue); }
        
        /* 日记 */
        .diary-entries { max-height: 350px; overflow-y: auto; }
        .diary-entry {
            background: linear-gradient(135deg, rgba(255,0,255,0.05), transparent);
            border-left: 3px solid var(--neon-pink);
            padding: 12px;
            margin: 8px 0;
            border-radius: 0 10px 10px 0;
            font-size: 12px;
        }
        .diary-date { color: var(--neon-pink); font-size: 11px; margin-bottom: 4px; font-weight: bold; }
        
        /* 模态框 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid var(--neon-blue);
            border-radius: 16px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 18px;
            color: var(--neon-blue);
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .modal-body {
            line-height: 1.7;
            color: #ccc;
            font-size: 14px;
            margin-bottom: 20px;
            white-space: pre-line;
        }
        
        .modal-choices { display: flex; flex-direction: column; gap: 8px; }
        
        .modal-choice-btn {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border: 1px solid rgba(102, 126, 234, 0.5);
            color: #fff;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 13px;
        }
        
        .modal-choice-btn:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.4), rgba(118, 75, 162, 0.4));
            border-color: var(--neon-blue);
        }
        
        /* 战斗 */
        .combat-arena {
            background: radial-gradient(circle at center, rgba(255,65,108,0.2) 0%, transparent 70%);
            border: 2px solid #ff416c;
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            margin-top: 15px;
        }
        
        .enemy-sprite { font-size: 70px; margin: 15px 0; }
        .enemy-name { font-size: 20px; font-weight: bold; color: #ff6b6b; margin-bottom: 12px; }
        
        .enemy-hp-bar {
            background: rgba(0,0,0,0.5);
            padding: 12px;
            border-radius: 10px;
            margin: 15px auto;
            max-width: 350px;
        }
        
        /* 成就通知 */
        .achievement-toast {
            position: fixed;
            top: 50px;
            right: -350px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 140, 0, 0.95));
            color: #000;
            padding: 15px;
            border-radius: 14px;
            transition: right 0.4s;
            z-index: 3000;
            max-width: 280px;
        }
        
        .achievement-toast.show { right: 15px; }
        .achievement-icon { font-size: 28px; margin-bottom: 5px; }
        .achievement-title { font-weight: 900; font-size: 14px; }
        .achievement-desc { font-size: 12px; }
        
        /* 夜间遮罩 */
        .night-overlay {
            position: fixed;
            top: 45px;
            left: 0;
            right: 0;
            bottom: var(--menu-height);
            background: rgba(20, 10, 40, 0.6);
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 1s;
        }
        
        .night-overlay.active { opacity: 1; }
        
        .sleep-indicator {
            position: fixed;
            bottom: 85px;
            right: 15px;
            background: linear-gradient(135deg, rgba(100, 50, 150, 0.9), rgba(80, 40, 120, 0.9));
            padding: 12px 20px;
            border-radius: 14px;
            border: 1px solid var(--neon-purple);
            z-index: 100;
            display: none;
        }
        
        .sleep-indicator.active { display: block; }
        
        /* 滚动条 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--neon-blue), var(--neon-pink)); border-radius: 3px; }
        
        /* 响应式 */
        @media (max-width: 768px) {
            .status-panel { grid-template-columns: repeat(2, 1fr); }
            .game-title { font-size: 16px; }
            .explore-grid { grid-template-columns: repeat(2, 1fr); }
            .nav-item { min-width: 45px; padding: 6px 8px; }
            .nav-item .icon { font-size: 20px; }
            .nav-item .label { font-size: 9px; }
        }
        
        @media (max-width: 480px) {
            .main-container { padding: 10px; margin-top: 40px; }
            .explore-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- 公告栏 -->
    <div class="announcement-bar" id="announcementBar">
        <span class="version-tag">v2.0</span>
        <span style="font-size: 12px;">全新菜单导航、蝴蝶效应、夜间休息</span>
        <button class="update-btn" onclick="showUpdateLog()">更新日志</button>
        <button class="close-btn" onclick="closeAnnouncement()">&times;</button>
    </div>
    
    <!-- 夜间遮罩 -->
    <div class="night-overlay" id="nightOverlay"></div>
    
    <!-- 睡眠指示器 -->
    <div class="sleep-indicator" id="sleepIndicator">
        <div style="font-size: 20px; text-align: center;">&#127769;</div>
        <div style="font-size: 12px; color: var(--neon-purple);">正在休息...</div>
    </div>
    
    <!-- 成就通知 -->
    <div class="achievement-toast" id="achievementToast">
        <div class="achievement-icon">&#127942;</div>
        <div class="achievement-title">成就解锁</div>
        <div class="achievement-desc" id="achievementText"></div>
    </div>
    
    <!-- 主内容 -->
    <main class="main-container" id="mainContainer">
        <!-- 顶部状态栏 -->
        <div class="top-status-bar">
            <div class="game-title">&#9762; 废墟纪元</div>
            <div class="time-display">
                <span class="time-item">&#128197; <span id="dayDisplay">1</span></span>
                <span class="time-item" id="timeDisplay">08:00</span>
                <span class="time-item">&#9762; <span id="radDisplay">0</span>%</span>
                <span class="time-item" style="color: var(--neon-blue);">Lv.<span id="playerLevel">1</span></span>
                <span class="time-item" style="color: var(--neon-green);">&#128181; <span id="capCount">50</span></span>
            </div>
        </div>
        
        <!-- 状态面板 -->
        <div class="status-panel">
            <div class="stat-card health" id="healthCard">
                <span class="stat-icon">&#10084;</span>
                <div class="stat-value" id="healthVal">100</div>
                <div class="stat-bar-container">
                    <div class="stat-bar-fill" id="healthBar" style="width: 100%; background: linear-gradient(90deg, #ff416c, #ff6b6b);"></div>
                </div>
            </div>
            <div class="stat-card hunger" id="hungerCard">
                <span class="stat-icon">&#127830;</span>
                <div class="stat-value" id="hungerVal">100</div>
                <div class="stat-bar-container">
                    <div class="stat-bar-fill" id="hungerBar" style="width: 100%; background: linear-gradient(90deg, #f2994a, #f2c94c);"></div>
                </div>
            </div>
            <div class="stat-card thirst" id="thirstCard">
                <span class="stat-icon">&#128167;</span>
                <div class="stat-value" id="thirstVal">100</div>
                <div class="stat-bar-container">
                    <div class="stat-bar-fill" id="thirstBar" style="width: 100%; background: linear-gradient(90deg, #56ccf2, #2f80ed);"></div>
                </div>
            </div>
            <div class="stat-card energy" id="energyCard">
                <span class="stat-icon">&#9889;</span>
                <div class="stat-value" id="energyVal">100</div>
                <div class="stat-bar-container">
                    <div class="stat-bar-fill" id="energyBar" style="width: 100%; background: linear-gradient(90deg, #11998e, #38ef7d);"></div>
                </div>
            </div>
        </div>
        
        <!-- 探索页面 -->
        <div class="page-content active" id="page-explore">
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#128506; 探索废土</div>
                </div>
                
                <div style="margin-bottom: 15px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 12px; color: #888;">
                        <span>位置: <span style="color: var(--neon-blue);">避难所</span></span>
                        <span>辐射: <span style="color: var(--neon-pink);">低</span></span>
                        <span>安全: <span style="color: var(--neon-green);">安全</span></span>
                    </div>
                </div>
                
                <div class="explore-grid">
                    <div class="explore-card" onclick="explore('suburbs')">
                        <span class="explore-icon">&#127968;</span>
                        <div class="explore-title">郊区废墟</div>
                        <div class="explore-info">
                            <span class="risk-low">&#9679;</span> 低风险<br>
                            基础资源<br>
                            消耗: <span style="color: var(--neon-green);">10&#9889;</span>
                        </div>
                    </div>
                    <div class="explore-card" onclick="explore('city')">
                        <span class="explore-icon">&#127970;</span>
                        <div class="explore-title">城市中心</div>
                        <div class="explore-info">
                            <span class="risk-med">&#9679;</span> 中风险<br>
                            高级物资<br>
                            消耗: <span style="color: #f2c94c;">20&#9889;</span>
                        </div>
                    </div>
                    <div class="explore-card" onclick="explore('lab')">
                        <span class="explore-icon">&#127973;</span>
                        <div class="explore-title">废弃医院</div>
                        <div class="explore-info">
                            <span class="risk-high">&#9679;</span> 高风险<br>
                            稀有物品<br>
                            消耗: <span style="color: #ff416c;">30&#9889;</span>
                        </div>
                    </div>
                    <div class="explore-card" onclick="explore('factory')" id="explore-factory" style="display: none;">
                        <span class="explore-icon">&#127981;</span>
                        <div class="explore-title">废弃工厂</div>
                        <div class="explore-info">
                            <span class="risk-high">&#9679;</span> 极高风险<br>
                            工业材料<br>
                            消耗: <span style="color: #ff416c;">40&#9889;</span>
                        </div>
                    </div>
                    <div class="explore-card" onclick="rest()" style="border-color: var(--neon-yellow);">
                        <span class="explore-icon">&#9978;</span>
                        <div class="explore-title">营地休息</div>
                        <div class="explore-info">
                            <span style="color: var(--neon-yellow);">恢复状态</span><br>
                            恢复生命/体力<br>
                            消耗: <span style="color: #f2c94c;">2&#127830; 2&#128167;</span>
                        </div>
                    </div>
                </div>
                <div id="combatArea" style="display: none;"></div>
            </div>
            
            <!-- 资源面板 -->
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#128230; 资源储备</div>
                    <div style="color: var(--neon-green); font-size: 14px;">
                        EXP: <span id="playerExp">0</span>/<span id="playerMaxExp">100</span>
                    </div>
                </div>
                <div class="resource-grid" id="resourcesGrid"></div>
            </div>
            
            <!-- 日志 -->
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#128220; 生存日志</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn" onclick="quickEat()" style="padding: 6px 12px; font-size: 11px;">&#127830; 进食</button>
                        <button class="action-btn" onclick="quickDrink()" style="padding: 6px 12px; font-size: 11px;">&#128167; 饮水</button>
                        <button class="action-btn" onclick="quickHeal()" style="padding: 6px 12px; font-size: 11px;">&#128138; 治疗</button>
                        <button class="action-btn warning" onclick="toggleTime()" style="padding: 6px 12px; font-size: 11px;" id="timeBtn">&#9208;</button>
                    </div>
                </div>
                <div class="log-container" id="logArea"></div>
            </div>
        </div>
        
        <!-- 任务页面 -->
        <div class="page-content" id="page-quest">
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#128220; 任务列表</div>
                </div>
                <div class="quest-list" id="questList"></div>
            </div>
        </div>
        
        <!-- 建造页面 -->
        <div class="page-content" id="page-build">
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#127959; 建造设施</div>
                </div>
                <div style="margin-bottom: 12px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 12px; color: #888;">
                    <strong style="color: var(--neon-blue);">&#128161;</strong> 建造高级建筑需要先解锁前置建筑
                </div>
                <div class="build-grid" id="buildGrid"></div>
            </div>
        </div>
        
        <!-- 制作页面 -->
        <div class="page-content" id="page-craft">
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#128295; 制作装备</div>
                </div>
                <div id="craftList"></div>
            </div>
        </div>
        
        <!-- 伙伴页面 -->
        <div class="page-content" id="page-pet">
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#128021; 我的伙伴</div>
                </div>
                <div class="pet-container" id="petDisplay"></div>
            </div>
            
            <!-- 装备栏 -->
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#127890; 装备栏</div>
                </div>
                <div class="equipment-grid">
                    <div class="equipment-slot" id="slot-weapon" onclick="unequip('weapon')">
                        <div class="equipment-icon">&#128298;</div>
                        <div style="font-size: 10px; color: #888;">武器</div>
                        <div style="font-size: 9px; color: #666; margin-top: 2px;" id="weaponName">未装备</div>
                    </div>
                    <div class="equipment-slot" id="slot-armor" onclick="unequip('armor')">
                        <div class="equipment-icon">&#128085;</div>
                        <div style="font-size: 10px; color: #888;">护甲</div>
                        <div style="font-size: 9px; color: #666; margin-top: 2px;" id="armorName">未装备</div>
                    </div>
                    <div class="equipment-slot" id="slot-accessory" onclick="unequip('accessory')">
                        <div class="equipment-icon">&#128141;</div>
                        <div style="font-size: 10px; color: #888;">饰品</div>
                        <div style="font-size: 9px; color: #666; margin-top: 2px;" id="accessoryName">未装备</div>
                    </div>
                    <div class="equipment-slot" id="slot-pet" onclick="switchPage('pet')">
                        <div class="equipment-icon">&#128062;</div>
                        <div style="font-size: 10px; color: #888;">伙伴</div>
                        <div style="font-size: 9px; color: #666; margin-top: 2px;" id="petSlotName">无</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 营地页面 -->
        <div class="page-content" id="page-camp">
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#9978; 幸存者营地</div>
                    <button class="action-btn success" onclick="upgradeCamp()" style="padding: 6px 14px; font-size: 11px;">&#11014; 升级</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                        <div style="font-size: 20px; font-weight: bold; color: var(--neon-green);" id="campLevel">1</div>
                        <div style="font-size: 10px; color: #888;">等级</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                        <div style="font-size: 20px; font-weight: bold; color: var(--neon-blue);"><span id="campMembers">1</span>/<span id="campMaxMembers">5</span></div>
                        <div style="font-size: 10px; color: #888;">居民</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                        <div style="font-size: 20px; font-weight: bold; color: var(--neon-orange);" id="campProsperity">100</div>
                        <div style="font-size: 10px; color: #888;">繁荣</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                        <div style="font-size: 20px; font-weight: bold; color: var(--neon-purple);" id="campDefense">10</div>
                        <div style="font-size: 10px; color: #888;">防御</div>
                    </div>
                </div>
                <h4 style="color: var(--neon-blue); margin-bottom: 12px; font-size: 14px;">&#128506; 附近幸存者</h4>
                <div class="npc-grid" id="npcList"></div>
            </div>
            
            <!-- 技能 -->
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#129516; 技能</div>
                    <div style="color: var(--neon-green); font-size: 18px; font-weight: bold;" id="skillPoints">0</div>
                </div>
                <div class="skill-grid" id="skillTree"></div>
            </div>
        </div>
        
        <!-- 日记页面 -->
        <div class="page-content" id="page-diary">
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#128214; 生存日记</div>
                </div>
                <div class="diary-entries" id="diaryEntries"></div>
            </div>
            
            <!-- 统计 -->
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">&#128202; 统计数据</div>
                    <div style="color: var(--neon-orange); font-weight: bold; font-size: 20px;" id="statScore">0</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 12px;">
                    <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: #fff;" id="statKills">0</div>
                        <div style="color: #888; font-size: 10px;">击杀</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: #fff;" id="statExplores">0</div>
                        <div style="color: #888; font-size: 10px;">探索</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: #fff;" id="statQuests">0</div>
                        <div style="color: #888; font-size: 10px;">任务</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: #fff;" id="statBuilds">0</div>
                        <div style="color: #888; font-size: 10px;">建造</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 底部导航 -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('explore')" data-page="explore">
            <span class="icon">&#128506;</span>
            <span class="label">探索</span>
        </div>
        <div class="nav-item" onclick="switchPage('quest')" data-page="quest">
            <span class="icon">&#128220;</span>
            <span class="label">任务</span>
        </div>
        <div class="nav-item" onclick="switchPage('build')" data-page="build">
            <span class="icon">&#127959;</span>
            <span class="label">建造</span>
        </div>
        <div class="nav-item" onclick="switchPage('craft')" data-page="craft">
            <span class="icon">&#128295;</span>
            <span class="label">制作</span>
        </div>
        <div class="nav-item" onclick="switchPage('pet')" data-page="pet">
            <span class="icon">&#128021;</span>
            <span class="label">伙伴</span>
        </div>
        <div class="nav-item" onclick="switchPage('camp')" data-page="camp">
            <span class="icon">&#9978;</span>
            <span class="label">营地</span>
        </div>
        <div class="nav-item" onclick="switchPage('diary')" data-page="diary">
            <span class="icon">&#128214;</span>
            <span class="label">日记</span>
        </div>
    </nav>
    
    <!-- 模态框 -->
    <div class="modal-overlay" id="gameModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">标题</div>
            <div class="modal-body" id="modalText">内容</div>
            <div class="modal-choices" id="modalChoices"></div>
        </div>
    </div>

    <script>
        // 更新日志
        const UPDATE_LOG = [
            {
                version: '2.0',
                date: '2026-02-21',
                changes: [
                    { type: 'add', text: '全新底部菜单导航' },
                    { type: 'add', text: '蝴蝶效应事件系统' },
                    { type: 'add', text: '夜间自动休息' },
                    { type: 'add', text: '可关闭公告栏' },
                    { type: 'opt', text: '优化移动端适配' }
                ]
            }
        ];
        
        // 蝴蝶效应
        const butterflyEffects = {
            helpedSoldier: false,
            sparedGhoul: false,
            tookCrystal: false,
            destroyedRobot: false,
            sharedFood: false,
            karma: 0,
            traderRep: 0
        };
        
        // 游戏数据
        const gameData = {
            version: '2.0',
            player: {
                level: 1,
                exp: 0,
                maxExp: 100,
                stats: {
                    health: 100,
                    maxHealth: 100,
                    hunger: 100,
                    thirst: 100,
                    energy: 100,
                    radiation: 0
                }
            },
            resources: {
                wood: 0, stone: 0, metal: 0, 
                food: 3, water: 3, medkit: 1, 
                ammo: 10,
                fuel: 0, electronics: 0, crystal: 0,
                cloth: 0
            },
            caps: 50,
            equipment: { weapon: null, armor: null, accessory: null, pet: null },
            buildings: {},
            skills: { combat: 0, survival: 0, crafting: 0, barter: 0, leadership: 0 },
            skillPoints: 0,
            quests: [],
            completedQuests: [],
            diary: [],
            pet: null,
            npcs: [],
            camp: { level: 1, members: ['player'], prosperity: 100, maxMembers: 5, defense: 10 },
            stats: { kills: 0, explores: 0, builds: 0, crafts: 0, quests: 0 },
            time: { day: 1, hour: 8, minute: 0, paused: false, isNight: false, sleeping: false },
            flags: { introRead: false, factoryUnlocked: false },
            eventCooldowns: {},
            butterflyEffects: {...butterflyEffects}
        };
        
        // 配置
        const config = {
            resources: [
                {id: 'wood', name: '木材', icon: '&#129717;', rarity: 'common'},
                {id: 'stone', name: '石材', icon: '&#129704;', rarity: 'common'},
                {id: 'metal', name: '金属', icon: '&#9881;', rarity: 'common'},
                {id: 'food', name: '食物', icon: '&#127830;', rarity: 'common'},
                {id: 'water', name: '净水', icon: '&#128167;', rarity: 'common'},
                {id: 'medkit', name: '医疗包', icon: '&#128138;', rarity: 'uncommon'},
                {id: 'ammo', name: '弹药', icon: '&#127919;', rarity: 'common'},
                {id: 'fuel', name: '燃料', icon: '&#9981;', rarity: 'rare'},
                {id: 'electronics', name: '电子元件', icon: '&#128187;', rarity: 'rare'},
                {id: 'crystal', name: '辐射结晶', icon: '&#128142;', rarity: 'epic'},
                {id: 'cloth', name: '布料', icon: '&#129525;', rarity: 'common'}
            ],
            
            randomEvents: [
                {
                    id: 'old_safe',
                    title: '废弃保险箱',
                    desc: '你在废墟中发现了一个锈蚀的保险箱。',
                    choices: [
                        { text: '破解 (1电子)', cost: {electronics: 1}, reward: {caps: 80, metal: 15} },
                        { text: '砸开 (-15体力)', energyCost: 15, reward: {caps: 30, metal: 5}, failChance: 0.4, failText: '保险箱损坏' },
                        { text: '离开', reward: {} }
                    ],
                    weight: 1.5
                },
                {
                    id: 'wandering_trader',
                    title: '流浪商人',
                    desc: '一个商人愿意交换资源。',
                    choices: [
                        { text: '30木头换20弹药', cost: {wood: 30}, reward: {ammo: 20} },
                        { text: '15金属换1医疗包', cost: {metal: 15}, reward: {medkit: 1} },
                        { text: '抢劫', combat: true, enemy: 'trader', reward: {caps: 200, ammo: 50} },
                        { text: '拒绝', reward: {} }
                    ],
                    weight: 1.2
                },
                {
                    id: 'wounded_soldier',
                    title: '受伤士兵',
                    desc: '一名士兵请求水和食物。',
                    choices: [
                        { text: '帮助 (1水1食物)', cost: {water: 1, food: 1}, reward: {caps: 30, ammo: 15}, butterfly: {type: 'helpedSoldier', value: true} },
                        { text: '要报酬', cost: {water: 1, food: 1}, reward: {caps: 80} },
                        { text: '无视', reward: {} },
                        { text: '搜刮', reward: {caps: 50, ammo: 20} }
                    ],
                    weight: 1.0
                },
                {
                    id: 'ghoul_attack',
                    title: '食尸鬼遭遇',
                    desc: '一只食尸鬼冲出，但眼神中似乎还有人性...',
                    choices: [
                        { text: '攻击', combat: true, enemy: 'ghoul' },
                        { text: '尝试交流', skillCheck: {skill: 'leadership', difficulty: 2}, reward: {crystal: 1}, butterfly: {type: 'sparedGhoul', value: true} },
                        { text: '离开', reward: {} }
                    ],
                    weight: 1.3
                },
                {
                    id: 'mysterious_shrine',
                    title: '神秘祭坛',
                    desc: '辐射教徒祭坛，上有发光结晶。',
                    choices: [
                        { text: '拿结晶', reward: {crystal: 2}, radiation: 15 },
                        { text: '祭拜', cost: {food: 1}, radiation: -15 },
                        { text: '远离', reward: {} }
                    ],
                    weight: 0.8
                },
                {
                    id: 'radio_signal',
                    title: '神秘信号',
                    desc: '收音机捕捉到求救信号。',
                    choices: [
                        { text: '调查 (-20体力)', energyCost: 20, reward: {caps: 150, food: 3}, risk: 'combat' },
                        { text: '回复 (1电子)', cost: {electronics: 1}, reward: {caps: 100} },
                        { text: '忽略', reward: {} }
                    ],
                    weight: 0.9
                },
                {
                    id: 'abandoned_vehicle',
                    title: '废弃车辆',
                    desc: '一辆战前汽车，也许还有遗漏。',
                    choices: [
                        { text: '抽燃料', reward: {fuel: 8} },
                        { text: '搜零件', reward: {metal: 10, electronics: 2} },
                        { text: '检查车内', risk: 'combat', reward: {caps: 80, ammo: 20} }
                    ],
                    weight: 1.0
                },
                {
                    id: 'mole_rat_nest',
                    title: '鼹鼠窝',
                    desc: '巨大鼹鼠窝，有闪亮物品。',
                    choices: [
                        { text: '清理', combat: true, enemy: 'mole_rat', reward: {caps: 60, crystal: 1} },
                        { text: '引开 (2食物)', cost: {food: 2}, reward: {caps: 40} },
                        { text: '离开', reward: {} }
                    ],
                    weight: 1.2
                },
                {
                    id: 'supply_drop',
                    title: '空投物资',
                    desc: '无人机投下补给箱，有人也发现了。',
                    choices: [
                        { text: '快速抢', reward: {food: 8, water: 8, ammo: 40}, risk: 'combat' },
                        { text: '隐蔽观察', skillCheck: {skill: 'survival', difficulty: 2}, reward: {food: 5, water: 5} },
                        { text: '放弃', reward: {} }
                    ],
                    weight: 0.7
                },
                {
                    id: 'survivor_group',
                    title: '幸存者小队',
                    desc: '遇到疲惫但警惕的幸存者。',
                    choices: [
                        { text: '友好 (1食物)', cost: {food: 1}, reward: {caps: 50} },
                        { text: '保持距离', reward: {} },
                        { text: '战斗', combat: true, enemy: 'bandit_group', reward: {caps: 200, food: 5} }
                    ],
                    weight: 1.0
                }
            ],
            
            quests: [
                { id: 'q1', type: 'main', title: '第一个夜晚', desc: '建造简易帐篷。', target: {build: 'tent'}, reward: {exp: 50, caps: 100, wood: 20}, completed: false },
                { id: 'q2', type: 'main', title: '水源危机', desc: '建造集水器。', target: {build: 'water_collector'}, reward: {exp: 80, caps: 150, food: 5}, completed: false },
                { id: 'q3', type: 'main', title: '废土猎人', desc: '击败3个敌人。(0/3)', target: {kill: 3}, progress: 0, reward: {exp: 150, caps: 300, metal: 20}, completed: false },
                { id: 'q4', type: 'main', title: '建造工坊', desc: '建造工坊制作装备。', target: {build: 'workshop'}, reward: {exp: 200, caps: 400, electronics: 8}, completed: false },
                { id: 'q5', type: 'main', title: '寻找伙伴', desc: '驯服一只宠物。', target: {pet: true}, reward: {exp: 300, caps: 500, food: 10}, completed: false },
                { id: 's1', type: 'side', title: '木材大亨', desc: '收集80木材。(0/80)', target: {resource: 'wood', amount: 80}, progress: 0, reward: {exp: 50, caps: 100, stone: 25}, completed: false },
                { id: 's2', type: 'side', title: '电子专家', desc: '制作3电子元件。(0/3)', target: {craft: 'electronics', amount: 3}, progress: 0, reward: {exp: 80, caps: 150}, completed: false },
                { id: 'd1', type: 'daily', title: '日常探索', desc: '探索3次。(0/3)', target: {explore: 3}, progress: 0, reward: {exp: 60, caps: 120, wood: 8}, completed: false, refreshDay: 0 },
                { id: 'd2', type: 'daily', title: '资源收集', desc: '收集40资源。(0/40)', target: {collectAny: 40}, progress: 0, reward: {exp: 50, caps: 80}, completed: false, refreshDay: 0 }
            ],
            
            pets: [
                {id: 'dog', name: '阿尔法', icon: '&#128021;', type: 'combat', bonus: {damage: 8, defense: 2}, desc: '忠诚军犬，增加攻击和防御'},
                {id: 'cat', name: '喵喵', icon: '&#128008;', type: 'survival', bonus: {findBonus: 0.3}, desc: '机敏的猫，提高资源发现率'},
                {id: 'robot', name: 'R2', icon: '&#129302;', type: 'utility', bonus: {craftSpeed: 0.5}, desc: '旧机器人，减少制作消耗'},
                {id: 'bird', name: '小彩', icon: '&#129436;', type: 'scout', bonus: {avoidDanger: 0.25}, desc: '变异鹦鹉，预警危险'}
            ],
            
            npcs: [
                {id: 'doc', name: '医生李', icon: '&#128104;&#8205;&#9877;', role: '医生', affection: 0, maxAffection: 100, desc: '前战地医生，提供医疗帮助', gift: 'medkit'},
                {id: 'merchant', name: '行商老张', icon: '&#128115;', role: '商人', affection: 10, maxAffection: 100, desc: '废土老手，提供交易', gift: 'caps'},
                {id: 'engineer', name: '工程师王', icon: '&#128119;', role: '工程师', affection: 0, maxAffection: 100, desc: '机械天才，帮助建造', gift: 'electronics'},
                {id: 'hunter', name: '猎手陈', icon: '&#127993;', role: '猎人', affection: 0, maxAffection: 100, desc: '废土猎人，分享技巧', gift: 'food'},
                {id: 'scientist', name: '博士杨', icon: '&#128105;&#8205;&#128300;', role: '科学家', affection: 0, maxAffection: 100, desc: '辐射专家，净化辐射', gift: 'crystal'}
            ],
            
            buildings: [
                {id: 'tent', name: '简易帐篷', icon: '&#9978;', cost: {wood: 15, cloth: 5}, effect: '每日恢复生命', level: 1},
                {id: 'water_collector', name: '集水器', icon: '&#128167;', cost: {wood: 20, metal: 5}, effect: '每日+2水', level: 1},
                {id: 'storage', name: '储藏室', icon: '&#128230;', cost: {wood: 25, metal: 8}, effect: '容量+30', level: 1},
                {id: 'greenhouse', name: '温室', icon: '&#127793;', cost: {wood: 35, stone: 15, water: 3}, effect: '每日+2食物', level: 2, req: 'water_collector'},
                {id: 'workshop', name: '工坊', icon: '&#128295;', cost: {wood: 30, stone: 20, metal: 15, electronics: 2}, effect: '解锁高级制作', level: 2},
                {id: 'medical_station', name: '医疗站', icon: '&#127973;', cost: {wood: 35, metal: 12, electronics: 3}, effect: '每日回血+12', level: 2, req: 'tent'},
                {id: 'armory', name: '军械库', icon: '&#127984;', cost: {stone: 50, metal: 40, electronics: 8}, effect: '装备强化', level: 3, req: 'workshop'},
                {id: 'bunker', name: '地下堡垒', icon: '&#128737;', cost: {stone: 80, metal: 60, electronics: 15, crystal: 3}, effect: '辐射防护', level: 4, req: 'armory'}
            ],
            
            weapons: [
                {id: 'knife', name: '生存刀', icon: '&#128298;', damage: 12, cost: {wood: 5, metal: 3}},
                {id: 'bat', name: '球棒', icon: '&#127951;', damage: 18, cost: {wood: 12}},
                {id: 'machete', name: '砍刀', icon: '&#128481;', damage: 25, cost: {metal: 15, wood: 5}},
                {id: 'pistol', name: '手枪', icon: '&#128299;', damage: 30, cost: {metal: 15, electronics: 3, ammo: 15}},
                {id: 'rifle', name: '步枪', icon: '&#127919;', damage: 50, cost: {metal: 35, electronics: 8, wood: 10, ammo: 40}, req: 'workshop'},
                {id: 'shotgun', name: '霰弹枪', icon: '&#128299;', damage: 65, cost: {metal: 45, wood: 15, ammo: 25}, req: 'workshop'},
                {id: 'sniper', name: '狙击枪', icon: '&#127919;', damage: 85, cost: {metal: 70, electronics: 25, ammo: 80}, req: 'armory'}
            ],
            
            armors: [
                {id: 'clothes', name: '破烂衣服', icon: '&#128085;', defense: 2, cost: {cloth: 8}},
                {id: 'leather', name: '皮甲', icon: '&#129403;', defense: 8, cost: {cloth: 12, metal: 8}},
                {id: 'metal_armor', name: '金属甲', icon: '&#9939;', defense: 18, cost: {metal: 35}, req: 'workshop'},
                {id: 'combat_armor', name: '战斗装甲', icon: '&#129466;', defense: 32, cost: {metal: 50, electronics: 12, cloth: 15}, req: 'armory'}
            ],
            
            accessories: [
                {id: 'luck_ring', name: '幸运戒指', icon: '&#128141;', effect: 'findBonus', value: 0.12, cost: {metal: 12, crystal: 1}, desc: '+12%发现率'},
                {id: 'health_amulet', name: '生命护符', icon: '&#128255;', effect: 'healthRegen', value: 2, cost: {electronics: 15, crystal: 1}, desc: '每分钟+2生命'},
                {id: 'rad_badge', name: '辐射徽章', icon: '&#9762;', effect: 'radResist', value: 0.25, cost: {metal: 15, electronics: 8}, desc: '-25%辐射'},
                {id: 'ammo_pouch', name: '弹药袋', icon: '&#127890;', effect: 'ammoSave', value: 0.2, cost: {cloth: 15, metal: 8}, desc: '20%省弹药'}
            ],
            
            enemies: [
                {name: '变异鼠', icon: '&#128000;', hp: 30, damage: 5, exp: 18, loot: {food: 1, cloth: 1}, type: 'animal'},
                {name: '强盗', icon: '&#128121;', hp: 55, damage: 10, exp: 35, loot: {caps: 40, ammo: 6}, type: 'human'},
                {name: '变异犬', icon: '&#128021;', hp: 65, damage: 16, exp: 50, loot: {food: 2, cloth: 2}, type: 'animal'},
                {name: '食尸鬼', icon: '&#128128;', hp: 80, damage: 20, exp: 70, loot: {medkit: 1, caps: 50}, type: 'ghoul'},
                {name: '巨蝎', icon: '&#129410;', hp: 100, damage: 25, exp: 90, loot: {crystal: 1, metal: 12}, type: 'animal'},
                {name: '超级变种人', icon: '&#129503;', hp: 160, damage: 35, exp: 160, loot: {ammo: 35, metal: 25, caps: 200}, type: 'mutant'},
                {name: '死亡爪', icon: '&#129429;', hp: 280, damage: 55, exp: 320, loot: {crystal: 4, caps: 450, metal: 90}, type: 'legendary'},
                {name: '辐射僵尸', icon: '&#9762;', hp: 120, damage: 22, exp: 100, loot: {crystal: 1}, type: 'ghoul', radDamage: 4}
            ],
            
            story: {
                intro: '核战后的第5年，你从冷冻舱中醒来。\n\n记忆模糊，只记得战前世界的碎片。辐射尘遮蔽了天空，废土上遍布着变异生物和凶残的强盗。\n\n你在废墟中发现了一个旧日记本，上面写着："北方的避难所还有幸存者..."\n\n你的生存之旅，现在开始。'
            }
        };
        
        // 全局变量
        let gameState = JSON.parse(JSON.stringify(gameData));
        let currentEnemy = null;
        let gameInterval = null;
        
        // 初始化
        function init() {
            initQuests();
            initNPCs();
            addDiaryEntry('intro', config.story.intro);
            
            if (!gameState.flags.introRead) {
                showModal('序章：废土觉醒', config.story.intro, [
                    {text: '开始生存', action: function() {
                        gameState.flags.introRead = true;
                        closeModal();
                        addLog('欢迎来到废土世界！', 'story');
                    }}
                ]);
            }
            
            startGameLoop();
            updateUI();
        }
        
        function initQuests() { gameState.quests = JSON.parse(JSON.stringify(config.quests)); }
        function initNPCs() { gameState.npcs = JSON.parse(JSON.stringify(config.npcs)); }
        
        // 页面切换
        function switchPage(pageName) {
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === pageName) {
                    item.classList.add('active');
                }
            });
            
            document.querySelectorAll('.page-content').forEach(function(page) {
                page.classList.remove('active');
            });
            document.getElementById('page-' + pageName).classList.add('active');
            
            if (pageName === 'quest') renderQuests();
            if (pageName === 'build') renderBuildings();
            if (pageName === 'craft') renderCrafting();
            if (pageName === 'pet') renderPet();
            if (pageName === 'camp') renderNPCs();
            if (pageName === 'diary') renderDiary();
        }
        
        // 公告栏
        function closeAnnouncement() {
            document.getElementById('announcementBar').classList.add('hidden');
            document.getElementById('mainContainer').style.marginTop = '0';
        }
        
        function showUpdateLog() {
            let html = '<div class="update-log">';
            UPDATE_LOG.forEach(function(update) {
                html += '<div class="update-version"><h4>v' + update.version + ' (' + update.date + ')</h4><ul>';
                update.changes.forEach(function(change) {
                    var typeText = change.type === 'add' ? '[新增]' : change.type === 'fix' ? '[修复]' : '[优化]';
                    html += '<li>' + typeText + ' ' + change.text + '</li>';
                });
                html += '</ul></div>';
            });
            html += '</div>';
            
            showModal('更新日志', '', [{text: '关闭', action: closeModal}]);
            document.getElementById('modalText').innerHTML = html;
        }
        
        // 时间系统
        function startGameLoop() {
            gameInterval = setInterval(function() {
                if (gameState.time.paused || gameState.time.sleeping) return;
                
                gameState.time.minute += 10;
                if (gameState.time.minute >= 60) {
                    gameState.time.minute = 0;
                    gameState.time.hour++;
                    onHourPassed();
                }
                
                if (gameState.time.hour >= 24) {
                    gameState.time.hour = 0;
                    newDay();
                }
                
                updateTimeDisplay();
                checkNightStatus();
            }, 1000);
        }
        
        function onHourPassed() {
            if (gameState.time.hour % 2 === 0) decayStats();
            if (Math.random() < 0.012) triggerRandomEvent();
            document.getElementById('radDisplay').textContent = Math.floor(gameState.player.stats.radiation);
            updateStatCards();
        }
        
        function updateTimeDisplay() {
            var hour = String(gameState.time.hour).padStart(2, '0');
            var minute = String(gameState.time.minute).padStart(2, '0');
            document.getElementById('timeDisplay').textContent = hour + ':' + minute;
        }
        
        function checkNightStatus() {
            var hour = gameState.time.hour;
            var isNight = hour >= 22 || hour < 6;
            
            if (isNight && !gameState.time.isNight) {
                gameState.time.isNight = true;
                document.getElementById('nightOverlay').classList.add('active');
                addLog('夜幕降临，废土更危险了...', 'night');
                
                if (gameState.buildings.tent && gameState.resources.food >= 2 && gameState.resources.water >= 2) {
                    setTimeout(function() {
                        if (!gameState.time.sleeping) {
                            addLog('你决定在营地休息...', 'night');
                            startSleep();
                        }
                    }, 2500);
                }
            } else if (!isNight && gameState.time.isNight) {
                gameState.time.isNight = false;
                document.getElementById('nightOverlay').classList.remove('active');
                addLog('黎明到来！', 'success');
            }
        }
        
        function startSleep() {
            gameState.time.sleeping = true;
            document.getElementById('sleepIndicator').classList.add('active');
            gameState.resources.food -= 2;
            gameState.resources.water -= 2;
            
            var healAmount = 35 + (gameState.camp.level * 6) + (gameState.buildings.tent ? 12 : 0);
            var radHeal = 6 + (gameState.buildings.bunker ? 12 : 0);
            
            changeStat('energy', 100);
            changeStat('health', healAmount);
            gameState.player.stats.radiation = Math.max(0, gameState.player.stats.radiation - radHeal);
            
            var sleepInterval = setInterval(function() {
                gameState.time.hour++;
                if (gameState.time.hour >= 6 && gameState.time.hour < 22) {
                    clearInterval(sleepInterval);
                    wakeUp();
                }
                updateTimeDisplay();
            }, 150);
            
            addDiaryEntry('rest', '度过夜晚，恢复' + healAmount + '生命');
            updateUI();
        }
        
        function wakeUp() {
            gameState.time.sleeping = false;
            document.getElementById('sleepIndicator').classList.remove('active');
            addLog('你醒来了！', 'success');
            updateUI();
        }
        
        function decayStats() {
            var hungerDecay = 1, thirstDecay = 1.5, energyDecay = 0.8;
            if (gameState.time.isNight) energyDecay *= 1.5;
            if (gameState.skills.survival > 0) {
                var bonus = gameState.skills.survival * 0.08;
                hungerDecay *= (1 - bonus);
                thirstDecay *= (1 - bonus);
            }
            
            changeStat('hunger', -hungerDecay);
            changeStat('thirst', -thirstDecay);
            changeStat('energy', -energyDecay);
            
            if (gameState.player.stats.radiation > 50) {
                changeStat('health', -1.5);
                if (Math.random() < 0.04) addLog('辐射侵蚀身体...', 'danger');
            }
            
            var acc = config.accessories.find(function(a) { return a.id === gameState.equipment.accessory; });
            if (acc && acc.effect === 'healthRegen') changeStat('health', acc.value * 0.5);
            
            if (gameState.player.stats.hunger <= 0) {
                changeStat('health', -2);
                if (Math.random() < 0.06) addLog('饥饿让你虚弱...', 'danger');
            }
            if (gameState.player.stats.thirst <= 0) {
                changeStat('health', -3);
                if (Math.random() < 0.06) addLog('脱水症状！', 'danger');
            }
        }
        
        function newDay() {
            gameState.time.day++;
            addDiaryEntry('daily', '第' + gameState.time.day + '天: ' + getDailyReport());
            applyBuildingEffects();
            applyPetEffects();
            applyCampEffects();
            refreshDailyQuests();
            checkUnlocks();
            updateUI();
        }
        
        function getDailyReport() {
            var events = [];
            if (gameState.stats.kills > 0) events.push('击杀' + gameState.stats.kills + '敌人');
            if (gameState.stats.explores > 0) events.push('探索' + gameState.stats.explores + '次');
            return events.length ? events.join('，') : '平静的一天';
        }
        
        // 蝴蝶效应
        function applyButterflyEffect(type, value) {
            if (type === 'karma' || type === 'traderRep') {
                gameState.butterflyEffects[type] += value;
            } else {
                gameState.butterflyEffects[type] = value;
            }
            
            if (type === 'helpedSoldier' && value === true) {
                setTimeout(function() {
                    if (gameState.butterflyEffects.helpedSoldier) {
                        addLog('之前帮助的士兵送来军事物资！', 'success');
                        gameState.resources.ammo += 40;
                        gameState.caps += 80;
                        updateUI();
                    }
                }, 4000);
            }
        }
        
        // 事件系统
        function triggerRandomEvent() {
            if (gameState.eventCooldowns.lastEvent && gameState.time.day - gameState.eventCooldowns.lastEvent < 1) return;
            
            var availableEvents = config.randomEvents.filter(function(e) {
                return !e.condition || gameState.buildings[e.condition];
            });
            if (availableEvents.length === 0) return;
            
            var totalWeight = availableEvents.reduce(function(sum, e) { return sum + (e.weight || 1); }, 0);
            var random = Math.random() * totalWeight;
            var selectedEvent = availableEvents[0];
            
            for (var i = 0; i < availableEvents.length; i++) {
                random -= (availableEvents[i].weight || 1);
                if (random <= 0) { selectedEvent = availableEvents[i]; break; }
            }
            
            gameState.eventCooldowns.lastEvent = gameState.time.day;
            showEventModal(selectedEvent);
        }
        
        function showEventModal(event) {
            var choices = event.choices.map(function(c) {
                return {
                    text: c.text,
                    consequence: c.consequence || '',
                    action: function() { handleEventChoice(c, event); }
                };
            });
            showModalWithConsequences(event.title, event.desc, choices);
        }
        
        function showModalWithConsequences(title, text, choices) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            var choicesDiv = document.getElementById('modalChoices');
            choicesDiv.innerHTML = '';
            choices.forEach(function(choice) {
                var btn = document.createElement('button');
                btn.className = 'modal-choice-btn';
                btn.innerHTML = choice.text + (choice.consequence ? '<div class="consequence">' + choice.consequence + '</div>' : '');
                btn.onclick = choice.action;
                choicesDiv.appendChild(btn);
            });
            document.getElementById('gameModal').classList.add('active');
        }
        
        function handleEventChoice(choice, event) {
            if (choice.skillCheck && gameState.skills[choice.skillCheck.skill] < choice.skillCheck.difficulty) {
                addLog('技能不足！需要' + choice.skillCheck.skill + '等级' + choice.skillCheck.difficulty, 'warning');
                closeModal(); return;
            }
            
            if (choice.energyCost) changeStat('energy', -choice.energyCost);
            if (choice.cost) {
                for (var res in choice.cost) {
                    if ((gameState.resources[res] || 0) < choice.cost[res]) {
                        addLog(getResourceName(res) + '不足！', 'warning'); return;
                    }
                    gameState.resources[res] -= choice.cost[res];
                }
            }
            
            if (choice.failChance && Math.random() < choice.failChance) {
                addLog(choice.failText || '失败！', 'danger');
                closeModal(); return;
            }
            
            if (choice.butterfly) applyButterflyEffect(choice.butterfly.type, choice.butterfly.value);
            
            if (choice.reward) {
                for (var r in choice.reward) {
                    if (r === 'exp') gainExp(choice.reward[r]);
                    else gameState.resources[r] = (gameState.resources[r] || 0) + choice.reward[r];
                }
            }
            
            if (choice.radiation) {
                gameState.player.stats.radiation = Math.max(0, Math.min(100, gameState.player.stats.radiation + choice.radiation));
                if (choice.radiation > 0) addLog('受到' + choice.radiation + '辐射', 'danger');
                if (choice.radiation < 0) addLog('辐射减少' + Math.abs(choice.radiation), 'success');
            }
            
            if (choice.combat) {
                closeModal();
                var enemy;
                if (choice.enemy === 'trader') enemy = {name: '愤怒商人', icon: '&#128115;', hp: 80, damage: 15, exp: 50, loot: {caps: 100}, type: 'human'};
                else if (choice.enemy === 'bandit_group') enemy = {name: '强盗团伙', icon: '&#128121;', hp: 120, damage: 20, exp: 80, loot: {caps: 150, food: 3}, type: 'human'};
                else enemy = config.enemies.find(function(e) { return e.name.includes(choice.enemy) || e.type === choice.enemy; });
                if (enemy) {
                    var copy = Object.assign({}, enemy);
                    copy.maxHp = enemy.hp;
                    setTimeout(function() { startCombat(copy); }, 300);
                }
                return;
            }
            
            closeModal();
            updateUI();
        }
        
        // 探索与战斗
        function explore(location) {
            if (gameState.time.isNight) {
                addLog('太黑了，无法安全探索！', 'warning');
                return;
            }
            
            var costs = {suburbs: 10, city: 20, lab: 30, factory: 40};
            var riskLevel = {suburbs: 0.25, city: 0.45, lab: 0.65, factory: 0.8};
            
            if (gameState.player.stats.energy < costs[location]) {
                addLog('体力不足！需要休息', 'warning');
                return;
            }
            
            changeStat('energy', -costs[location]);
            gameState.stats.explores++;
            
            var radGain = {suburbs: 1, city: 3, lab: 7, factory: 10}[location];
            gameState.player.stats.radiation = Math.min(100, gameState.player.stats.radiation + radGain * (1 - getRadResist()));
            
            var encounterChance = riskLevel[location];
            if (gameState.pet && gameState.pet.type === 'scout') encounterChance *= (1 - gameState.pet.bonus.avoidDanger);
            if (gameState.butterflyEffects.sparedGhoul && Math.random() < 0.3) encounterChance *= 0.7;
            
            if (Math.random() < encounterChance) {
                var enemyPool = {suburbs: [0, 1], city: [1, 2, 3], lab: [3, 4, 5], factory: [4, 5, 6]}[location];
                var enemyIdx = enemyPool[Math.floor(Math.random() * enemyPool.length)];
                var enemy = Object.assign({}, config.enemies[enemyIdx]);
                enemy.maxHp = enemy.hp;
                enemy.level = Math.floor(gameState.player.level * 0.7) + 1;
                enemy.hp = Math.floor(enemy.hp * (1 + enemy.level * 0.08));
                enemy.damage = Math.floor(enemy.damage * (1 + enemy.level * 0.04));
                enemy.exp = Math.floor(enemy.exp * (1 + enemy.level * 0.08));
                startCombat(enemy);
                return;
            }
            
            var rewards = {
                suburbs: {wood: [12,25], stone: [8,18], cloth: [4,12]},
                city: {metal: [12,25], electronics: [2,8], ammo: [12,25], caps: [25,80]},
                lab: {electronics: [8,20], medkit: [1,2], crystal: [1,2]},
                factory: {metal: [25,45], fuel: [8,18], electronics: [12,25]}
            };
            
            var lootText = [];
            var bonus = 1 + (gameState.skills.survival * 0.08) + (gameState.pet ? gameState.pet.bonus.findBonus || 0 : 0);
            
            for (var res in rewards[location]) {
                var range = rewards[location][res];
                var amount = Math.floor((rand(range[0], range[1]) * bonus));
                if (amount > 0) {
                    gameState.resources[res] += amount;
                    lootText.push(amount + getResourceIcon(res));
                }
            }
            
            addLog('探索成功！获得: ' + lootText.join(' '), 'loot');
            gainExp(12 * (location === 'factory' ? 2 : 1));
            updateQuestProgress('explore', 1);
            updateUI();
        }
        
        function getRadResist() {
            var resist = 0;
            if (gameState.buildings.bunker) resist += 0.25;
            var acc = config.accessories.find(function(a) { return a.id === gameState.equipment.accessory; });
            if (acc && acc.effect === 'radResist') resist += acc.value;
            return Math.min(0.7, resist);
        }
        
        function startCombat(enemy) {
            currentEnemy = enemy;
            gameState.flags.firstCombat = true;
            
            var combatHTML = '<div class="combat-arena">' +
                '<div style="font-size: 18px; font-weight: bold; margin-bottom: 12px; color: #ff416c;">' +
                '战斗 - ' + enemy.name + ' Lv.' + enemy.level +
                '</div>' +
                '<div class="enemy-sprite">' + enemy.icon + '</div>' +
                '<div class="enemy-name">' + enemy.name + '</div>' +
                '<div style="color: #888; margin-bottom: 12px; font-size: 12px;">攻击力: ' + enemy.damage + '</div>' +
                '<div class="enemy-hp-bar">' +
                '<div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">' +
                '<span>HP</span><span id="enemyHpText">' + enemy.hp + '/' + enemy.maxHp + '</span>' +
                '</div>' +
                '<div style="height: 16px; background: rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden;">' +
                '<div id="enemyHpBar" style="width: 100%; height: 100%; background: linear-gradient(90deg, #ff416c, #ff6b6b); transition: width 0.3s;"></div>' +
                '</div>' +
                '</div>' +
                '<div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">' +
                '<button class="action-btn" onclick="playerAttack()">攻击</button>' +
                '<button class="action-btn" onclick="useSkill()">技能</button>' +
                '<button class="action-btn" onclick="useItem(\'medkit\')">治疗</button>' +
                '<button class="action-btn danger" onclick="flee()">逃跑</button>' +
                '</div>' +
                '</div>';
            
            document.getElementById('combatArea').innerHTML = combatHTML;
            document.getElementById('combatArea').style.display = 'block';
            addLog('遭遇 Lv.' + enemy.level + ' ' + enemy.name + '！', 'danger');
        }
        
        function playerAttack() {
            if (!currentEnemy) return;
            
            var weapon = config.weapons.find(function(w) { return w.id === gameState.equipment.weapon; });
            var damage = 8 + (gameState.skills.combat * 3);
            if (weapon) damage += weapon.damage;
            if (gameState.pet && gameState.pet.type === 'combat') damage += gameState.pet.bonus.damage;
            
            damage = Math.floor(damage * (0.9 + Math.random() * 0.2));
            
            var critChance = 0.06 + (gameState.skills.combat * 0.025);
            if (Math.random() < critChance) {
                damage = Math.floor(damage * 2);
                addLog('暴击！', 'warning');
            }
            
            currentEnemy.hp -= damage;
            if (currentEnemy.hp <= 0) { setTimeout(function() { winCombat(); }, 400); return; }
            
            updateCombatUI();
            if (gameState.pet && gameState.pet.type === 'combat') setTimeout(function() { petAttack(); }, 300);
            setTimeout(function() { enemyAttack(); }, 600);
        }
        
        function petAttack() {
            if (!currentEnemy || !gameState.pet) return;
            var dmg = Math.floor(gameState.pet.bonus.damage * (0.8 + Math.random() * 0.4));
            currentEnemy.hp -= dmg;
            addLog(gameState.pet.name + ' 造成' + dmg + '伤害', 'loot');
            updateCombatUI();
            if (currentEnemy.hp <= 0) setTimeout(function() { winCombat(); }, 300);
        }
        
        function enemyAttack() {
            if (!currentEnemy) return;
            
            var damage = currentEnemy.damage;
            var armor = config.armors.find(function(a) { return a.id === gameState.equipment.armor; });
            if (armor) damage = Math.max(1, damage - armor.defense);
            if (gameState.pet && gameState.pet.bonus.defense) damage = Math.max(1, damage - gameState.pet.bonus.defense);
            
            var dodgeChance = gameState.skills.combat * 0.015;
            if (Math.random() < dodgeChance) { addLog('闪避成功！', 'success'); return; }
            
            changeStat('health', -damage);
            if (currentEnemy.radDamage) {
                gameState.player.stats.radiation += currentEnemy.radDamage;
                addLog('受到' + currentEnemy.radDamage + '辐射伤害！', 'danger');
            }
            
            document.body.classList.add('flash');
            setTimeout(function() { document.body.classList.remove('flash'); }, 300);
            addLog(currentEnemy.name + ' 造成' + damage + '伤害！', 'danger');
        }
        
        function winCombat() {
            var enemy = currentEnemy;
            addLog('击败' + enemy.name + '！+' + enemy.exp + '经验', 'success');
            
            for (var item in enemy.loot) {
                var bonus = 1 + (gameState.skills.survival * 0.08);
                var finalAmount = Math.floor(enemy.loot[item] * bonus);
                gameState.resources[item] = (gameState.resources[item] || 0) + finalAmount;
                addLog('获得 ' + finalAmount + ' ' + getResourceName(item), 'loot');
            }
            
            if (Math.random() < 0.08) { gameState.caps += 35; addLog('幸运掉落: 35瓶盖！', 'loot'); }
            
            gameState.stats.kills++;
            gainExp(enemy.exp);
            updateQuestProgress('kill', 1);
            if (gameState.pet) gameState.pet.exp = (gameState.pet.exp || 0) + Math.floor(enemy.exp / 2);
            
            if (enemy.name === '变异犬' && !gameState.pet && Math.random() < 0.35) {
                setTimeout(function() {
                    showModal('驯服机会', '这只变异犬想跟你走？', [
                        {text: '收养', action: function() { acquirePet('dog'); closeModal(); }},
                        {text: '离开', action: closeModal}
                    ]);
                }, 400);
            }
            
            endCombat();
        }
        
        function flee() {
            var chance = 0.35 + (gameState.skills.survival * 0.04);
            if (Math.random() < chance) { addLog('成功逃脱！', 'success'); endCombat(); }
            else { addLog('逃跑失败！', 'danger'); enemyAttack(); }
        }
        
        function endCombat() {
            currentEnemy = null;
            document.getElementById('combatArea').style.display = 'none';
            updateUI();
        }
        
        function updateCombatUI() {
            if (!currentEnemy) return;
            var pct = Math.max(0, (currentEnemy.hp / currentEnemy.maxHp) * 100);
            document.getElementById('enemyHpBar').style.width = pct + '%';
            document.getElementById('enemyHpText').textContent = Math.max(0, currentEnemy.hp) + '/' + currentEnemy.maxHp;
        }
        
        // 任务系统
        function updateQuestProgress(type, amount) {
            gameState.quests.forEach(function(quest) {
                if (quest.completed) return;
                
                if (type === 'kill' && quest.target && quest.target.kill) {
                    quest.progress = (quest.progress || 0) + amount;
                    if (quest.progress >= quest.target.kill) completeQuest(quest);
                }
                if (type === 'explore' && quest.target && quest.target.explore) {
                    quest.progress = (quest.progress || 0) + amount;
                    if (quest.progress >= quest.target.explore) completeQuest(quest);
                }
                if (type === 'build' && quest.target && quest.target.build && amount === quest.target.build) completeQuest(quest);
                if (type === 'craft' && quest.target && quest.target.craft && amount === quest.target.craft) completeQuest(quest);
                if (type === 'collectAny') {
                    quest.progress = (quest.progress || 0) + amount;
                    if (quest.progress >= quest.target.collectAny) completeQuest(quest);
                }
                if (type === 'resource' && quest.target && quest.target.resource) {
                    if ((gameState.resources[quest.target.resource] || 0) >= quest.target.amount) completeQuest(quest);
                }
                if (type === 'pet' && quest.target && quest.target.pet && gameState.pet) completeQuest(quest);
            });
            renderQuests();
        }
        
        function completeQuest(quest) {
            quest.completed = true;
            gameState.completedQuests.push(quest.id);
            gameState.stats.quests++;
            
            if (quest.reward.exp) gainExp(quest.reward.exp);
            if (quest.reward.caps) gameState.caps += quest.reward.caps;
            for (var res in quest.reward) {
                if (res !== 'exp' && res !== 'caps') gameState.resources[res] = (gameState.resources[res] || 0) + quest.reward[res];
            }
            
            showAchievement('任务完成: ' + quest.title, formatReward(quest.reward));
            addLog('完成: ' + quest.title, 'success');
            addDiaryEntry('quest', '完成"' + quest.title + '"');
            updateUI();
        }
        
        function refreshDailyQuests() {
            gameState.quests.forEach(function(q) {
                if (q.type === 'daily' && q.completed && gameState.time.day > (q.refreshDay || 0)) {
                    q.completed = false; q.progress = 0; q.refreshDay = gameState.time.day + 1;
                }
            });
        }
        
        function renderQuests() {
            var list = document.getElementById('questList');
            var activeQuests = gameState.quests.filter(function(q) { return !q.completed; });
            
            if (activeQuests.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #666; padding: 30px;"><div style="font-size: 40px; margin-bottom: 10px;">&#128236;</div>暂无任务</div>';
                return;
            }
            
            list.innerHTML = activeQuests.map(function(quest) {
                var progressText = '', progressPct = 0;
                if (quest.target && quest.target.kill) {
                    progressText = (quest.progress || 0) + '/' + quest.target.kill;
                    progressPct = Math.min(100, ((quest.progress || 0) / quest.target.kill) * 100);
                } else if (quest.target && quest.target.explore) {
                    progressText = (quest.progress || 0) + '/' + quest.target.explore;
                    progressPct = Math.min(100, ((quest.progress || 0) / quest.target.explore) * 100);
                } else if (quest.target && quest.target.resource) {
                    var cur = gameState.resources[quest.target.resource] || 0;
                    progressText = cur + '/' + quest.target.amount;
                    progressPct = Math.min(100, (cur / quest.target.amount) * 100);
                }
                
                var typeColors = {main: 'var(--neon-blue)', side: 'var(--neon-green)', daily: 'var(--neon-orange)'};
                
                return '<div class="quest-item">' +
                    '<div class="quest-title">' + quest.title + '</div>' +
                    '<div class="quest-desc">' + quest.desc + '</div>' +
                    (progressText ? '<div style="display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-top: 6px;"><span>进度</span><span style="color: #fff;">' + progressText + '</span></div>' +
                    '<div class="quest-progress"><div class="quest-progress-fill" style="width: ' + progressPct + '%"></div></div>' : '') +
                    '<div style="font-size: 11px; color: var(--neon-green); margin-top: 6px;">&#127873; ' + formatReward(quest.reward) + '</div>' +
                    '</div>';
            }).join('');
        }
        
        // 建造系统
        function renderBuildings() {
            var grid = document.getElementById('buildGrid');
            grid.innerHTML = '';
            
            config.buildings.forEach(function(build) {
                var hasBuilt = gameState.buildings[build.id];
                var canBuild = checkCost(build.cost) && (!build.req || gameState.buildings[build.req]);
                var missingReq = build.req && !gameState.buildings[build.req];
                
                var div = document.createElement('div');
                div.className = 'build-card' + (hasBuilt ? ' built' : '');
                
                var statusText = '';
                if (hasBuilt) statusText = '<div style="color: var(--neon-green); font-weight: bold; margin-top: 6px; font-size: 11px;">&#10003; 已建造</div>';
                else if (missingReq) statusText = '<div style="color: #ff416c; font-size: 9px; margin-top: 6px;">&#128274; 需' + (config.buildings.find(function(b) { return b.id === build.req; }) || {}).name + '</div>';
                else statusText = '<div style="font-size: 9px; color: ' + (canBuild ? 'var(--neon-green)' : '#ff416c') + '; margin-top: 6px;">' + formatCost(build.cost) + '</div>';
                
                div.innerHTML = '<div class="build-icon">' + build.icon + '</div>' +
                    '<div class="build-name">' + build.name + '</div>' +
                    '<div class="build-effect">' + build.effect + '</div>' + statusText;
                
                if (!hasBuilt && canBuild) div.onclick = function() { build(build); };
                else if (!hasBuilt && !missingReq) div.style.opacity = '0.6';
                else if (missingReq) div.style.opacity = '0.4';
                
                grid.appendChild(div);
            });
        }
        
        function build(building) {
            if (!checkCost(building.cost)) return;
            for (var res in building.cost) gameState.resources[res] -= building.cost[res];
            
            gameState.buildings[building.id] = true;
            gameState.stats.builds++;
            addLog('建造: ' + building.name, 'success');
            addDiaryEntry('build', '建造' + building.name);
            updateQuestProgress('build', building.id);
            if (building.id === 'workshop') showAchievement('工坊解锁', '可制作高级装备！');
            updateUI();
        }
        
        // 制作系统
        function renderCrafting() {
            var list = document.getElementById('craftList');
            list.innerHTML = '';
            
            var categories = [
                {name: '&#9876; 武器', items: config.weapons},
                {name: '&#128737; 护甲', items: config.armors},
                {name: '&#128141; 饰品', items: config.accessories}
            ];
            
            categories.forEach(function(cat) {
                var div = document.createElement('div');
                div.className = 'craft-category';
                div.innerHTML = '<div class="craft-header"><h3 style="color: var(--neon-blue); font-size: 13px;">' + cat.name + '</h3></div>';
                
                var itemsDiv = document.createElement('div');
                itemsDiv.className = 'craft-items';
                
                cat.items.forEach(function(item) {
                    var canCraft = checkCost(item.cost) && (!item.req || gameState.buildings[item.req]);
                    var isEquipped = Object.values(gameState.equipment).includes(item.id);
                    
                    var itemDiv = document.createElement('div');
                    itemDiv.className = 'craft-item';
                    
                    var stats = item.damage ? '攻击力: ' + item.damage : item.defense ? '防御力: ' + item.defense : item.effect ? '特殊: ' + item.desc : '';
                    var reqText = item.req && !gameState.buildings[item.req] ? '<div style="color: #ff416c; font-size: 9px;">需' + (config.buildings.find(function(b) { return b.id === item.req; }) || {}).name + '</div>' : '';
                    
                    itemDiv.innerHTML = '<div class="craft-info">' +
                        '<div class="craft-icon">' + item.icon + '</div>' +
                        '<div class="craft-details">' +
                        '<h4 style="font-size: 12px;">' + item.name + ' ' + (isEquipped ? '&#10003;' : '') + '</h4>' +
                        '<div class="craft-stats">' + stats + '</div>' +
                        '<div class="craft-requirements">' + formatCost(item.cost) + '</div>' + reqText +
                        '</div></div>' +
                        (!isEquipped && canCraft ? '<button class="action-btn" onclick="craft(\'' + item.id + '\', \'' + (cat.name.includes('武器') ? 'weapon' : cat.name.includes('护甲') ? 'armor' : 'accessory') + '\')" style="padding: 6px 12px; font-size: 11px;">制作</button>' : '');
                    itemsDiv.appendChild(itemDiv);
                });
                
                div.appendChild(itemsDiv);
                list.appendChild(div);
            });
        }
        
        function craft(itemId, category) {
            var item;
            if (category === 'weapon') item = config.weapons.find(function(i) { return i.id === itemId; });
            else if (category === 'armor') item = config.armors.find(function(i) { return i.id === itemId; });
            else item = config.accessories.find(function(i) { return i.id === itemId; });
            
            if (!item || !checkCost(item.cost)) return;
            
            var discount = gameState.skills.crafting * 0.05;
            for (var res in item.cost) gameState.resources[res] -= Math.floor(item.cost[res] * (1 - discount));
            
            var type = item.damage ? 'weapon' : item.defense ? 'armor' : 'accessory';
            gameState.equipment[type] = itemId;
            addLog('制作并装备: ' + item.name, 'success');
            gameState.stats.crafts++;
            updateQuestProgress('craft', itemId);
            updateUI();
        }
        
        function unequip(type) {
            if (!gameState.equipment[type]) return;
            gameState.equipment[type] = null;
            updateUI();
        }
        
        // 宠物系统
        function acquirePet(petId) {
            var petConfig = config.pets.find(function(p) { return p.id === petId; });
            gameState.pet = Object.assign({}, petConfig, {loyalty: 50, exp: 0, level: 1});
            gameState.equipment.pet = petId;
            addLog('收养了' + petConfig.name + '！', 'success');
            addDiaryEntry('pet', '遇到伙伴' + petConfig.name);
            updateQuestProgress('pet', true);
            renderPet();
            updateUI();
        }
        
        function renderPet() {
            var container = document.getElementById('petDisplay');
            if (!gameState.pet) {
                container.innerHTML = '<div style="color: #666; padding: 30px; font-size: 13px;">' +
                    '<div style="font-size: 45px; margin-bottom: 10px;">&#128062;</div>' +
                    '还没有伙伴<br><span style="font-size: 11px; opacity: 0.7;">探索时可能遇到可驯服的动物</span></div>';
                return;
            }
            
            var pet = gameState.pet;
            var level = Math.floor((pet.exp || 0) / 80) + 1;
            var expPct = ((pet.exp || 0) % 80) / 80 * 100;
            
            container.innerHTML = '<div class="pet-avatar">' + pet.icon + '</div>' +
                '<div style="font-size: 20px; font-weight: bold; color: var(--neon-orange); margin: 8px 0;">' + pet.name + '</div>' +
                '<div style="color: #888; margin-bottom: 15px; font-size: 12px;">' + pet.desc + '</div>' +
                '<div style="max-width: 220px; margin: 0 auto 15px;">' +
                '<div style="display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-bottom: 3px;">' +
                '<span>等级 ' + level + '</span><span>' + Math.floor(expPct) + '/100 EXP</span></div>' +
                '<div style="height: 6px; background: rgba(0,0,0,0.5); border-radius: 3px; overflow: hidden;">' +
                '<div style="width: ' + expPct + '%; height: 100%; background: linear-gradient(90deg, var(--neon-orange), var(--neon-yellow));"></div></div></div>' +
                '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 350px; margin: 0 auto;">' +
                '<div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px;">' +
                '<div style="font-size: 10px; color: #888;">忠诚度</div>' +
                '<div style="font-size: 18px; font-weight: bold; color: var(--neon-orange);">' + pet.loyalty + '%</div></div>' +
                '<div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px;">' +
                '<div style="font-size: 10px; color: #888;">类型</div>' +
                '<div style="font-size: 14px; font-weight: bold; color: var(--neon-blue);">' + pet.type + '</div></div>' +
                '<div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px;">' +
                '<div style="font-size: 10px; color: #888;">心情</div>' +
                '<div style="font-size: 14px; font-weight: bold; color: var(--neon-green);">' + (pet.loyalty > 80 ? '开心' : pet.loyalty > 50 ? '平静' : '低落') + '</div></div></div>' +
                '<div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">' +
                '<button class="action-btn" onclick="feedPet()" style="padding: 8px 14px; font-size: 11px;">&#127830; 喂食</button>' +
                '<button class="action-btn warning" onclick="playWithPet()" style="padding: 8px 14px; font-size: 11px;">&#9918; 玩耍</button>' +
                '<button class="action-btn info" onclick="trainPet()" style="padding: 8px 14px; font-size: 11px;">&#128218; 训练</button></div>';
        }
        
        function feedPet() {
            if (gameState.resources.food <= 0) { addLog('没有食物！', 'warning'); return; }
            gameState.resources.food--;
            gameState.pet.loyalty = Math.min(100, gameState.pet.loyalty + 10);
            gameState.pet.exp = (gameState.pet.exp || 0) + 12;
            addLog(gameState.pet.name + ' 开心地吃着！忠诚度+10', 'success');
            renderPet();
        }
        
        function playWithPet() {
            gameState.pet.loyalty = Math.min(100, gameState.pet.loyalty + 6);
            gameState.pet.exp = (gameState.pet.exp || 0) + 8;
            changeStat('energy', -3);
            addLog('和' + gameState.pet.name + '玩耍！', 'success');
            renderPet();
        }
        
        function trainPet() {
            if (gameState.player.stats.energy < 15) { addLog('体力不足！', 'warning'); return; }
            changeStat('energy', -15);
            gameState.pet.exp = (gameState.pet.exp || 0) + 25;
            addLog('训练了' + gameState.pet.name + '！', 'success');
            renderPet();
        }
        
        // NPC系统
        function renderNPCs() {
            var list = document.getElementById('npcList');
            list.innerHTML = '';
            
            gameState.npcs.forEach(function(npc) {
                var div = document.createElement('div');
                div.className = 'npc-card';
                var hearts = '';
                for (var i = 0; i < 5; i++) {
                    hearts += '<span style="font-size: 12px; ' + (i < Math.floor(npc.affection / 20) ? 'color: #ff416c;' : 'color: rgba(255,255,255,0.2);') + '">&#10084;</span>';
                }
                
                div.innerHTML = '<div class="npc-avatar">' + npc.icon + '</div>' +
                    '<div style="flex: 1;">' +
                    '<div class="npc-name">' + npc.name + '</div>' +
                    '<div class="npc-role">' + npc.role + '</div>' +
                    '<div style="font-size: 10px; color: #666; margin-top: 2px;">' + npc.desc + '</div></div>' +
                    '<div>' + hearts + '</div>';
                div.onclick = function() { interactNPC(npc); };
                list.appendChild(div);
            });
        }
        
        function interactNPC(npc) {
            var actions = [
                {text: '&#128172; 交谈', action: function() { npc.affection = Math.min(npc.maxAffection, npc.affection + 6); addLog('与' + npc.name + '交谈，好感+6', 'success'); checkRecruit(npc); updateUI(); closeModal(); }}
            ];
            
            if (npc.affection >= 25) actions.push({
                text: '&#127873; 要礼物', action: function() {
                    if (npc.gift === 'caps') gameState.caps += 70;
                    else gameState.resources[npc.gift] = (gameState.resources[npc.gift] || 0) + 2;
                    addLog(npc.name + ' 给了礼物！', 'loot');
                    npc.affection -= 8; updateUI(); closeModal();
                }
            });
            
            if (npc.specialty === 'medical' && npc.affection >= 15) actions.push({
                text: '&#127973; 治疗 (50瓶盖)', action: function() {
                    if (gameState.caps >= 50) {
                        gameState.caps -= 50;
                        changeStat('health', 35);
                        gameState.player.stats.radiation = Math.max(0, gameState.player.stats.radiation - 12);
                        addLog('接受治疗', 'success');
                    } else addLog('瓶盖不足', 'warning');
                    closeModal();
                }
            });
            
            actions.push({text: '&#128075; 离开', action: closeModal});
            
            showModal(npc.name, npc.desc + '\n\n好感度: ' + npc.affection + '/' + npc.maxAffection + '\n\n"' + getNPCDialogue(npc) + '"', actions);
        }
        
        function getNPCDialogue(npc) {
            var dialogues = {
                doc: ['健康最重要。', '小心辐射病。', '我有最好的药。'],
                merchant: ['一分钱一分货。', '看看新货？'],
                engineer: ['机械就是生命。', '需要修理？'],
                hunter: ['废土最危险的是人。', '学设陷阱？'],
                scientist: ['知识就是力量。', '在研究净化技术。']
            };
            var lines = dialogues[npc.id] || ['...'];
            return lines[Math.floor(Math.random() * lines.length)];
        }
        
        function checkRecruit(npc) {
            if (npc.affection >= 75 && gameState.camp.members.indexOf(npc.id) === -1 && gameState.camp.members.length < gameState.camp.maxMembers) {
                gameState.camp.members.push(npc.id);
                gameState.camp.prosperity += 35;
                gameState.camp.defense += 10;
                showAchievement('新居民加入', npc.name + '加入营地！');
                addLog(npc.name + ' 加入营地！', 'success');
            }
        }
        
        function upgradeCamp() {
            var cost = { caps: 350 * gameState.camp.level, wood: 70 * gameState.camp.level, stone: 50 * gameState.camp.level, metal: 35 * gameState.camp.level };
            if (!checkCost(cost)) { addLog('资源不足！', 'warning'); return; }
            
            for (var res in cost) gameState.resources[res] -= cost[res];
            gameState.camp.level++;
            gameState.camp.maxMembers += 2;
            gameState.camp.prosperity += 120;
            gameState.camp.defense += 12;
            addLog('营地升级 Lv.' + gameState.camp.level + '！', 'success');
            showAchievement('营地升级', '最大居民: ' + gameState.camp.maxMembers);
            updateUI();
        }
        
        // 日记系统
        function addDiaryEntry(type, content) {
            var entry = { day: gameState.time.day, time: String(gameState.time.hour).padStart(2,'0') + ':' + String(gameState.time.minute).padStart(2,'0'), type: type, content: content };
            gameState.diary.unshift(entry);
            if (gameState.diary.length > 35) gameState.diary.pop();
            renderDiary();
        }
        
        function renderDiary() {
            var container = document.getElementById('diaryEntries');
            if (gameState.diary.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 25px;">暂无日记</div>';
                return;
            }
            
            var typeNames = {intro: '序章', daily: '日常', quest: '任务', build: '建造', pet: '伙伴', combat: '战斗', event: '事件', rest: '休息', system: '系统'};
            var typeColors = {intro: 'var(--neon-pink)', daily: 'var(--neon-blue)', quest: 'var(--neon-green)', build: 'var(--neon-orange)', pet: '#ff6b6b', combat: '#ff416c', event: 'var(--neon-purple)', rest: '#f2c94c', system: '#888'};
            
            container.innerHTML = gameState.diary.map(function(entry) {
                return '<div class="diary-entry">' +
                    '<div class="diary-date">' +
                    '<span>第' + entry.day + '天 ' + entry.time + '</span>' +
                    '<span style="font-size: 9px; padding: 2px 6px; background: ' + (typeColors[entry.type] || '#fff') + '20; border-radius: 6px; color: ' + (typeColors[entry.type] || '#fff') + ';">' + (typeNames[entry.type] || entry.type) + '</span></div>' +
                    '<div>' + entry.content + '</div></div>';
            }).join('');
        }
        
        // 技能系统
        function renderSkills() {
            var tree = document.getElementById('skillTree');
            tree.innerHTML = '';
            
            var skills = [
                {id: 'combat', name: '战斗', icon: '&#9876;', desc: '攻击+3/级'},
                {id: 'survival', name: '生存', icon: '&#127794;', desc: '资源+8%/级'},
                {id: 'crafting', name: '工艺', icon: '&#128295;', desc: '制作-8%消耗'},
                {id: 'barter', name: '交易', icon: '&#128176;', desc: '价格+8%/级'},
                {id: 'leadership', name: '领袖', icon: '&#128081;', desc: '繁荣+25/级'}
            ];
            
            skills.forEach(function(skill) {
                var level = gameState.skills[skill.id];
                var div = document.createElement('div');
                div.className = 'skill-card' + (level > 0 ? ' active' : '') + (level >= 5 ? ' maxed' : '');
                div.innerHTML = '<span class="skill-icon">' + skill.icon + '</span><div class="skill-name">' + skill.name + '</div><div class="skill-level">' + (level >= 5 ? 'MAX' : 'Lv.' + level) + '</div>';
                if (gameState.skillPoints > 0 && level < 5) div.onclick = function() { gameState.skills[skill.id]++; gameState.skillPoints--; addLog(skill.name + ' Lv.' + gameState.skills[skill.id], 'success'); updateUI(); };
                tree.appendChild(div);
            });
            
            document.getElementById('skillPoints').textContent = gameState.skillPoints;
        }
        
        // 辅助系统
        function rest() {
            if (gameState.resources.food < 2 || gameState.resources.water < 2) {
                addLog('需要2份食物和2份水！', 'warning');
                return;
            }
            gameState.resources.food -= 2;
            gameState.resources.water -= 2;
            
            var healAmount = 35 + (gameState.camp.level * 6) + (gameState.buildings.tent ? 12 : 0);
            var radHeal = 6 + (gameState.buildings.bunker ? 12 : 0);
            
            changeStat('energy', 100);
            changeStat('health', healAmount);
            gameState.player.stats.radiation = Math.max(0, gameState.player.stats.radiation - radHeal);
            gameState.time.hour = 8; gameState.time.minute = 0;
            
            addLog('休息后焕然一新！', 'success');
            addDiaryEntry('rest', '休息恢复' + healAmount + '生命');
            updateUI();
        }
        
        function quickEat() { useItem('food'); }
        function quickDrink() { useItem('water'); }
        function quickHeal() { useItem('medkit'); }
        
        function toggleTime() {
            gameState.time.paused = !gameState.time.paused;
            document.getElementById('timeBtn').innerHTML = gameState.time.paused ? '&#9654;' : '&#9208;';
            addLog(gameState.time.paused ? '已暂停' : '继续', 'story');
        }
        
        function useItem(item) {
            if ((gameState.resources[item] || 0) <= 0) { addLog('没有' + getResourceName(item) + '！', 'warning'); return; }
            gameState.resources[item]--;
            
            if (item === 'food') { changeStat('hunger', 30); addLog('进食，饥饿恢复', 'success'); }
            else if (item === 'water') { changeStat('thirst', 40); addLog('饮水，水分恢复', 'success'); }
            else if (item === 'medkit') { changeStat('health', 45); gameState.player.stats.radiation = Math.max(0, gameState.player.stats.radiation - 6); addLog('治疗，生命恢复', 'success'); }
            updateUI();
        }
        
        function useSkill() {
            if (gameState.skills.combat >= 3 && gameState.player.stats.energy >= 20) {
                changeStat('energy', -20);
                if (currentEnemy) {
                    var damage = Math.floor((15 + gameState.skills.combat * 4) * 1.5);
                    currentEnemy.hp -= damage;
                    addLog('强力攻击！' + damage + '伤害', 'success');
                    updateCombatUI();
                    if (currentEnemy.hp <= 0) setTimeout(function() { winCombat(); }, 400);
                    else setTimeout(function() { enemyAttack(); }, 600);
                }
            } else addLog('需要战斗等级3和20体力！', 'warning');
        }
        
        function gainExp(amount) {
            var bonus = 1 + (gameState.skills.leadership * 0.04);
            var finalAmount = Math.floor(amount * bonus);
            gameState.player.exp += finalAmount;
            
            while (gameState.player.exp >= gameState.player.maxExp) {
                gameState.player.exp -= gameState.player.maxExp;
                gameState.player.level++;
                gameState.player.maxExp = Math.floor(gameState.player.maxExp * 1.35);
                gameState.skillPoints += 2;
                gameState.player.stats.maxHealth += 12;
                gameState.player.stats.health = gameState.player.stats.maxHealth;
                showAchievement('升级！', 'Lv.' + gameState.player.level + '，+2技能点');
                addLog('升级！Lv.' + gameState.player.level, 'success');
            }
            updateUI();
        }
        
        function applyBuildingEffects() {
            var effects = [];
            if (gameState.buildings.water_collector) { var amt = 2 + (gameState.skills.survival * 0.4); gameState.resources.water += Math.floor(amt); effects.push('集水器+' + Math.floor(amt) + '水'); }
            if (gameState.buildings.greenhouse) { var amt = 2 + (gameState.skills.survival * 0.4); gameState.resources.food += Math.floor(amt); effects.push('温室+' + Math.floor(amt) + '食物'); }
            if (gameState.buildings.medical_station) { var heal = 12 + (gameState.skills.crafting * 1.5); changeStat('health', heal); effects.push('医疗站+' + Math.floor(heal) + '生命'); }
            if (effects.length) addLog('每日: ' + effects.join(', '), 'success');
        }
        
        function applyPetEffects() {
            if (!gameState.pet) return;
            if (gameState.pet.type === 'survival') {
                var bonus = Math.floor(Math.random() * 3) + 1;
                var res = ['wood', 'stone', 'metal'][Math.floor(Math.random() * 3)];
                gameState.resources[res] += bonus;
                addLog(gameState.pet.name + '带回' + bonus + getResourceName(res), 'loot');
            }
        }
        
        function applyCampEffects() {
            changeStat('health', gameState.camp.level * 2);
            if (Math.random() < 0.07) {
                if (gameState.camp.defense > 25) addLog('营地抵御了骚扰', 'success');
                else { addLog('营地遭袭！损失资源', 'danger'); loseRandomResources(); }
            }
        }
        
        function loseRandomResources() {
            var resources = Object.keys(gameState.resources).filter(function(r) { return gameState.resources[r] > 0; });
            if (resources.length === 0) return;
            var res = resources[Math.floor(Math.random() * resources.length)];
            var amount = Math.min(gameState.resources[res], Math.floor(Math.random() * 3) + 1);
            gameState.resources[res] -= amount;
            addLog('失去' + amount + getResourceName(res), 'danger');
        }
        
        function checkUnlocks() {
            if (gameState.player.level >= 5 && !gameState.flags.factoryUnlocked) {
                gameState.flags.factoryUnlocked = true;
                document.getElementById('explore-factory').style.display = 'block';
                addLog('解锁: 废弃工厂！', 'story');
                showAchievement('区域解锁', '废弃工厂开放');
            }
        }
        
        // UI更新
        function updateUI() {
            document.getElementById('playerLevel').textContent = gameState.player.level;
            document.getElementById('playerExp').textContent = gameState.player.exp;
            document.getElementById('playerMaxExp').textContent = gameState.player.maxExp;
            document.getElementById('dayDisplay').textContent = gameState.time.day;
            document.getElementById('capCount').textContent = gameState.caps;
            
            updateBar('health', gameState.player.stats.health, gameState.player.stats.maxHealth);
            updateBar('hunger', gameState.player.stats.hunger, 100);
            updateBar('thirst', gameState.player.stats.thirst, 100);
            updateBar('energy', gameState.player.stats.energy, 100);
            
            var resGrid = document.getElementById('resourcesGrid');
            resGrid.innerHTML = '';
            config.resources.forEach(function(res) {
                var count = gameState.resources[res.id] || 0;
                if (count > 0 || ['food', 'water', 'medkit'].indexOf(res.id) !== -1) {
                    var div = document.createElement('div');
                    div.className = 'resource-card' + (res.rarity === 'rare' ? ' rare' : res.rarity === 'epic' ? ' epic' : '');
                    if (['food', 'water', 'medkit'].indexOf(res.id) !== -1) { div.onclick = function() { useItem(res.id); }; div.style.cursor = 'pointer'; }
                    div.innerHTML = '<span class="resource-icon">' + res.icon + '</span><div class="resource-name">' + res.name + '</div><div class="resource-count">' + count + '</div>';
                    resGrid.appendChild(div);
                }
            });
            
            updateEquipment('weapon', config.weapons);
            updateEquipment('armor', config.armors);
            updateEquipment('accessory', config.accessories);
            document.getElementById('petSlotName').textContent = gameState.pet ? gameState.pet.name : '无';
            
            document.getElementById('statKills').textContent = gameState.stats.kills;
            document.getElementById('statExplores').textContent = gameState.stats.explores;
            document.getElementById('statQuests').textContent = gameState.stats.quests;
            document.getElementById('statBuilds').textContent = gameState.stats.builds;
            document.getElementById('statScore').textContent = calculateScore();
            
            document.getElementById('campLevel').textContent = gameState.camp.level;
            document.getElementById('campMembers').textContent = gameState.camp.members.length;
            document.getElementById('campMaxMembers').textContent = gameState.camp.maxMembers;
            document.getElementById('campProsperity').textContent = gameState.camp.prosperity;
            document.getElementById('campDefense').textContent = gameState.camp.defense;
        }
        
        function calculateScore() {
            var score = 0;
            score += gameState.stats.kills * 75;
            score += gameState.time.day * 45;
            score += gameState.stats.quests * 220;
            score += gameState.stats.builds * 160;
            score += gameState.player.level * 450;
            score += gameState.camp.prosperity * 1.3;
            score += Object.keys(gameState.buildings).filter(function(b) { return gameState.buildings[b]; }).length * 90;
            if (gameState.butterflyEffects.helpedSoldier) score += 180;
            if (gameState.butterflyEffects.sparedGhoul) score += 130;
            if (gameState.time.day >= 30) score *= 1.15;
            if (gameState.time.day >= 50) score *= 1.25;
            return Math.floor(score);
        }
        
        function updateBar(id, value, max) {
            var pct = Math.max(0, Math.min(100, (value / max) * 100));
            var bar = document.getElementById(id + 'Bar');
            var val = document.getElementById(id + 'Val');
            if (bar) bar.style.width = pct + '%';
            if (val) val.textContent = Math.floor(value);
        }
        
        function updateStatCards() {
            ['health', 'hunger', 'thirst', 'energy'].forEach(function(stat) {
                var card = document.getElementById(stat + 'Card');
                var value = gameState.player.stats[stat];
                var max = stat === 'health' ? gameState.player.stats.maxHealth : 100;
                if (value / max < 0.2) card.classList.add('critical');
                else card.classList.remove('critical');
            });
        }
        
        function updateEquipment(type, configArray) {
            var id = gameState.equipment[type];
            var slot = document.getElementById('slot-' + type);
            var nameEl = document.getElementById(type + 'Name');
            if (id) {
                var item = configArray.find(function(i) { return i.id === id; });
                if (item) { nameEl.textContent = item.name; slot.classList.add('filled'); }
            } else { nameEl.textContent = '未装备'; slot.classList.remove('filled'); }
        }
        
        // 存档系统
        function saveGame() {
            var data = JSON.stringify(gameState);
            localStorage.setItem('wasteland_v2_save', data);
            localStorage.setItem('wasteland_v2_backup', btoa(encodeURIComponent(data)));
            addLog('已保存！', 'success');
            showAchievement('存档完成', '进度已存储');
        }
        
        function loadGame() {
            var save = localStorage.getItem('wasteland_v2_save');
            if (!save) { addLog('无存档！', 'warning'); return; }
            try {
                var loaded = JSON.parse(save);
                gameState = Object.assign({}, gameData, loaded);
                if (!gameState.butterflyEffects) gameState.butterflyEffects = Object.assign({}, butterflyEffects);
                if (!gameState.time.minute) gameState.time.minute = 0;
                addLog('存档已读取', 'success');
                addDiaryEntry('system', '读取存档，第' + gameState.time.day + '天');
                if (gameState.flags.factoryUnlocked) document.getElementById('explore-factory').style.display = 'block';
                updateUI();
            } catch(e) { addLog('存档损坏！', 'danger'); }
        }
        
        function resetGame() {
            if (!confirm('确定重新开始？进度将丢失！')) return;
            if (!confirm('再次确认：无法恢复！')) return;
            localStorage.removeItem('wasteland_v2_save');
            localStorage.removeItem('wasteland_v2_backup');
            location.reload();
        }
        
        // 工具函数
        function addLog(msg, type) {
            var logArea = document.getElementById('logArea');
            var entry = document.createElement('div');
            entry.className = 'log-entry ' + (type || 'info');
            var time = String(gameState.time.hour).padStart(2,'0') + ':' + String(gameState.time.minute).padStart(2,'0');
            entry.innerHTML = '<span class="log-time">[' + time + ']</span> ' + msg;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
            while (logArea.children.length > 60) logArea.removeChild(logArea.firstChild);
        }
        
        function changeStat(stat, amount) {
            var max = stat === 'health' ? gameState.player.stats.maxHealth : 100;
            gameState.player.stats[stat] = Math.max(0, Math.min(gameState.player.stats[stat] + amount, max));
            if (stat === 'health' && gameState.player.stats.health <= 0) gameOver();
            updateUI();
        }
        
        function checkCost(cost) {
            for (var res in cost) if ((gameState.resources[res] || 0) < cost[res]) return false;
            return true;
        }
        
        function formatCost(cost) {
            if (!cost || Object.keys(cost).length === 0) return '免费';
            return Object.keys(cost).map(function(res) { return cost[res] + getResourceIcon(res); }).join(' ');
        }
        
        function formatReward(reward) {
            if (!reward) return '';
            var parts = [];
            if (reward.exp) parts.push(reward.exp + '经验');
            if (reward.caps) parts.push(reward.caps + '瓶盖');
            for (var k in reward) if (k !== 'exp' && k !== 'caps') parts.push(reward[k] + getResourceIcon(k));
            return parts.join('，');
        }
        
        function getResourceName(id) {
            var r = config.resources.find(function(r) { return r.id === id; });
            return r ? r.name : id;
        }
        
        function getResourceIcon(id) {
            var r = config.resources.find(function(r) { return r.id === id; });
            return r ? r.icon : '&#128230;';
        }
        
        function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        
        // 模态框
        function showModal(title, text, choices) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            var choicesDiv = document.getElementById('modalChoices');
            choicesDiv.innerHTML = '';
            choices.forEach(function(choice) {
                var btn = document.createElement('button');
                btn.className = 'modal-choice-btn';
                btn.textContent = choice.text;
                btn.onclick = choice.action;
                choicesDiv.appendChild(btn);
            });
            document.getElementById('gameModal').classList.add('active');
        }
        
        function closeModal() { document.getElementById('gameModal').classList.remove('active'); }
        
        function showAchievement(title, desc) {
            var toast = document.getElementById('achievementToast');
            document.getElementById('achievementText').innerHTML = '<strong style="font-size: 14px; display: block; margin-bottom: 2px;">' + title + '</strong><span style="font-size: 11px;">' + desc + '</span>';
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }
        
        function gameOver() {
            clearInterval(gameInterval);
            var score = calculateScore();
            var days = gameState.time.day;
            var rank = '废土流浪者';
            if (score > 7000) rank = '废土传奇';
            else if (score > 4500) rank = '避难所领袖';
            else if (score > 2200) rank = '生存专家';
            else if (score > 900) rank = '拾荒者';
            
            var epitaphs = ['又一个消失在废土中的灵魂...', '核冬天没有怜悯。', '你的故事结束了。', '也许下一个会更幸运。', '万物终将腐朽。'];
            
            showModal('你死了', '生存了' + days + '天\n得分: ' + score + '\n评价: ' + rank + '\n\n"' + epitaphs[Math.floor(Math.random() * epitaphs.length)] + '"', [
                {text: '重新开始', action: resetGame},
                {text: '读档', action: function() { closeModal(); loadGame(); }}
            ]);
        }
        
        // 启动
        window.onload = init;
        window.onbeforeunload = function() { if (gameState.time.day > 1) return '确定离开？未保存进度将丢失。'; };
        document.getElementById('gameModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
    </script>
</body>
</html>
